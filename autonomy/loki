#!/bin/bash
#===============================================================================
# Loki Mode CLI Wrapper (v5.0.0)
# Simple command-line interface for Loki Mode
#
# Installation:
#   ln -sf ~/.claude/skills/loki-mode/autonomy/loki /usr/local/bin/loki
#
# Usage:
#   loki start [PRD]      - Start Loki Mode (optionally with PRD)
#   loki stop             - Stop execution immediately
#   loki pause            - Pause after current session
#   loki resume           - Resume paused execution
#   loki status           - Show current status
#   loki dashboard        - Open dashboard in browser
#   loki import           - Import GitHub issues
#   loki help             - Show this help
#===============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Resolve the script's real path (handles symlinks)
resolve_script_path() {
    local script="$1"
    # Use realpath if available, otherwise fall back to readlink
    if command -v realpath &> /dev/null; then
        realpath "$script" 2>/dev/null || echo "$script"
    elif command -v readlink &> /dev/null; then
        # macOS readlink doesn't have -f, use a loop
        while [ -L "$script" ]; do
            local dir=$(dirname "$script")
            script=$(readlink "$script")
            [[ "$script" != /* ]] && script="$dir/$script"
        done
        echo "$script"
    else
        echo "$script"
    fi
}

# Find the skill installation
find_skill_dir() {
    local script_path
    script_path=$(resolve_script_path "$0")
    local script_dir
    script_dir=$(dirname "$script_path")

    local dirs=(
        "$HOME/.claude/skills/loki-mode"
        "$script_dir/.."
        "."
    )

    for dir in "${dirs[@]}"; do
        if [ -f "$dir/SKILL.md" ] && [ -f "$dir/autonomy/run.sh" ]; then
            echo "$dir"
            return 0
        fi
    done

    echo ""
    return 1
}

# Use || true to prevent set -e from exiting before error message
SKILL_DIR=$(find_skill_dir) || true
if [ -z "$SKILL_DIR" ]; then
    echo -e "${RED}Error: Could not find Loki Mode installation${NC}"
    echo "Expected at: ~/.claude/skills/loki-mode"
    echo "Or install via: npm install -g loki-mode"
    exit 1
fi

RUN_SH="$SKILL_DIR/autonomy/run.sh"
SANDBOX_SH="$SKILL_DIR/autonomy/sandbox.sh"
LOKI_DIR=".loki"

# Get version from VERSION file
get_version() {
    if [ -f "$SKILL_DIR/VERSION" ]; then
        cat "$SKILL_DIR/VERSION"
    else
        echo "unknown"
    fi
}

# Show help
show_help() {
    local version=$(get_version)
    echo -e "${BOLD}Loki Mode v$version${NC}"
    echo ""
    echo "Usage: loki <command> [options]"
    echo ""
    echo "Commands:"
    echo "  start [PRD]      Start Loki Mode (optionally with PRD file)"
    echo "  stop             Stop execution immediately"
    echo "  pause            Pause after current session"
    echo "  resume           Resume paused execution"
    echo "  status           Show current status"
    echo "  logs             Show recent log output"
    echo "  dashboard        Open dashboard in browser"
    echo "  provider [cmd]   Manage AI provider (show|set|list|info)"
    echo "  serve            Start HTTP API server (alias for api start)"
    echo "  api [cmd]        HTTP API server (start|stop|status)"
    echo "  sandbox [cmd]    Docker sandbox (start|stop|status|logs|shell|build)"
    echo "  import           Import GitHub issues as tasks"
    echo "  config [cmd]     Manage configuration (show|init|edit|path)"
    echo "  version          Show version"
    echo "  help             Show this help"
    echo ""
    echo "Options for 'start':"
    echo "  --provider NAME  AI provider: claude (default), codex, gemini"
    echo "  --parallel       Enable parallel mode with git worktrees"
    echo "  --bg, --background  Run in background mode"
    echo "  --simple         Force simple complexity tier (3 phases)"
    echo "  --complex        Force complex complexity tier (8 phases)"
    echo "  --github         Enable GitHub issue import"
    echo "  --no-dashboard   Disable web dashboard"
    echo "  --sandbox        Run in Docker sandbox for isolation"
    echo ""
    echo "Examples:"
    echo "  loki start                    # Start in current directory"
    echo "  loki start ./prd.md           # Start with PRD file"
    echo "  loki start --bg               # Start in background"
    echo "  loki start --parallel         # Start in parallel mode"
    echo "  loki pause                    # Pause execution"
    echo "  loki status                   # Check current status"
    echo ""
    echo "Environment Variables:"
    echo "  See: $RUN_SH (header comments)"
}

# Start Loki Mode
cmd_start() {
    local args=()
    local prd_file=""
    local provider=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --provider)
                if [[ -n "${2:-}" ]]; then
                    provider="$2"
                    args+=("--provider" "$provider")
                    shift 2
                else
                    echo -e "${RED}--provider requires a value (claude, codex, gemini)${NC}"
                    exit 1
                fi
                ;;
            --provider=*)
                provider="${1#*=}"
                args+=("--provider" "$provider")
                shift
                ;;
            --parallel)
                args+=("--parallel")
                shift
                ;;
            --bg|--background)
                args+=("--bg")
                shift
                ;;
            --simple)
                export LOKI_COMPLEXITY=simple
                shift
                ;;
            --complex)
                export LOKI_COMPLEXITY=complex
                shift
                ;;
            --github)
                export LOKI_GITHUB_IMPORT=true
                shift
                ;;
            --no-dashboard)
                export LOKI_DASHBOARD=false
                shift
                ;;
            --sandbox)
                export LOKI_SANDBOX_MODE=true
                shift
                ;;
            -*)
                echo -e "${RED}Unknown option: $1${NC}"
                exit 1
                ;;
            *)
                prd_file="$1"
                shift
                ;;
        esac
    done

    if [ -n "$prd_file" ]; then
        args+=("$prd_file")
    fi

    # Load saved provider if not specified on command line
    if [ -z "$provider" ]; then
        if [ -f "$LOKI_DIR/state/provider" ]; then
            provider=$(cat "$LOKI_DIR/state/provider" 2>/dev/null)
            if [ -n "$provider" ]; then
                args+=("--provider" "$provider")
            fi
        fi
    fi

    # Determine effective provider for display
    local effective_provider="${provider:-${LOKI_PROVIDER:-claude}}"

    # Handle sandbox mode - delegate to sandbox.sh
    if [[ "${LOKI_SANDBOX_MODE:-}" == "true" ]]; then
        if [ ! -f "$SANDBOX_SH" ]; then
            echo -e "${RED}Error: sandbox.sh not found at $SANDBOX_SH${NC}"
            exit 1
        fi

        # Check Docker availability
        if ! command -v docker &> /dev/null; then
            echo -e "${RED}Error: Docker not found${NC}"
            echo ""
            echo "Docker is required for sandbox mode. Install it:"
            echo "  macOS:  brew install --cask docker"
            echo "  Linux:  curl -fsSL https://get.docker.com | sh"
            exit 1
        fi

        if ! docker info &> /dev/null 2>&1; then
            echo -e "${RED}Error: Docker daemon not running${NC}"
            echo ""
            echo "Start Docker:"
            echo "  macOS:  Open Docker Desktop app"
            echo "  Linux:  sudo systemctl start docker"
            exit 1
        fi

        echo -e "${GREEN}Starting Loki Mode in Docker sandbox...${NC}"
        exec "$SANDBOX_SH" start "${args[@]}"
    fi

    # Show provider info
    echo -e "${GREEN}Starting Loki Mode...${NC}"
    echo -e "${CYAN}Provider:${NC} $effective_provider"
    if [ -f "$LOKI_DIR/state/provider" ]; then
        echo -e "${DIM}  (saved for this project - change with: loki provider set <name>)${NC}"
    else
        echo -e "${DIM}  (default - save for project with: loki provider set <name>)${NC}"
    fi
    echo ""

    exec "$RUN_SH" "${args[@]}"
}

# Stop execution immediately
cmd_stop() {
    if [ ! -d "$LOKI_DIR" ]; then
        echo -e "${YELLOW}No .loki directory found. Is Loki Mode running?${NC}"
        exit 1
    fi

    touch "$LOKI_DIR/STOP"
    echo -e "${RED}STOP signal sent. Execution will halt immediately.${NC}"
}

# Pause after current session
cmd_pause() {
    if [ ! -d "$LOKI_DIR" ]; then
        echo -e "${YELLOW}No .loki directory found. Is Loki Mode running?${NC}"
        exit 1
    fi

    touch "$LOKI_DIR/PAUSE"
    echo -e "${YELLOW}PAUSE signal sent. Execution will pause after current session.${NC}"
}

# Resume paused execution
cmd_resume() {
    if [ ! -d "$LOKI_DIR" ]; then
        echo -e "${YELLOW}No .loki directory found.${NC}"
        exit 1
    fi

    if [ -f "$LOKI_DIR/PAUSE" ]; then
        rm -f "$LOKI_DIR/PAUSE"
        echo -e "${GREEN}PAUSE file removed. You may need to restart Loki Mode.${NC}"
    elif [ -f "$LOKI_DIR/STOP" ]; then
        rm -f "$LOKI_DIR/STOP"
        echo -e "${GREEN}STOP file removed. You may need to restart Loki Mode.${NC}"
    else
        echo -e "${YELLOW}No pause/stop files found.${NC}"
    fi
}

# Show current status
cmd_status() {
    if [ ! -d "$LOKI_DIR" ]; then
        echo -e "${YELLOW}No .loki directory found.${NC}"
        echo "Loki Mode has not been initialized in this directory."
        exit 0
    fi

    echo -e "${BOLD}Loki Mode Status${NC}"
    echo ""

    # Show current provider
    local saved_provider=""
    if [ -f "$LOKI_DIR/state/provider" ]; then
        saved_provider=$(cat "$LOKI_DIR/state/provider" 2>/dev/null)
    fi
    local current_provider="${saved_provider:-${LOKI_PROVIDER:-claude}}"
    echo -e "${CYAN}Provider:${NC} $current_provider"
    echo -e "${DIM}  Switch with: loki provider set <claude|codex|gemini>${NC}"
    echo ""

    # Check status file
    if [ -f "$LOKI_DIR/STATUS.txt" ]; then
        echo -e "${CYAN}Current Status:${NC}"
        cat "$LOKI_DIR/STATUS.txt"
        echo ""
    fi

    # Check for signals
    if [ -f "$LOKI_DIR/PAUSE" ]; then
        echo -e "${YELLOW}PAUSE signal active${NC}"
    fi
    if [ -f "$LOKI_DIR/STOP" ]; then
        echo -e "${RED}STOP signal active${NC}"
    fi

    # Check orchestrator state
    if [ -f "$LOKI_DIR/state/orchestrator.json" ]; then
        echo -e "${CYAN}Orchestrator State:${NC}"
        jq -r '.currentPhase // "unknown"' "$LOKI_DIR/state/orchestrator.json" 2>/dev/null || echo "unknown"
    fi

    # Check pending tasks
    if [ -f "$LOKI_DIR/queue/pending.json" ]; then
        local task_count=$(jq '.tasks | length' "$LOKI_DIR/queue/pending.json" 2>/dev/null || echo "0")
        echo -e "${CYAN}Pending Tasks:${NC} $task_count"
    fi

    # Check dashboard
    if [ -f "$LOKI_DIR/dashboard/index.html" ]; then
        local port=${LOKI_DASHBOARD_PORT:-57374}
        echo -e "${CYAN}Dashboard:${NC} http://127.0.0.1:$port/dashboard/index.html"
    fi
}

# Provider management
cmd_provider() {
    local subcommand="${1:-show}"
    shift || true

    case "$subcommand" in
        show|current)
            cmd_provider_show
            ;;
        set)
            cmd_provider_set "$@"
            ;;
        list)
            cmd_provider_list
            ;;
        info)
            cmd_provider_info "$@"
            ;;
        *)
            echo -e "${BOLD}Loki Mode Provider Management${NC}"
            echo ""
            echo "Usage: loki provider <command>"
            echo ""
            echo "Commands:"
            echo "  show     Show current provider (default)"
            echo "  set      Set provider for this project"
            echo "  list     List available providers"
            echo "  info     Show provider details"
            echo ""
            echo "Examples:"
            echo "  loki provider show"
            echo "  loki provider set claude"
            echo "  loki provider set codex"
            echo "  loki provider list"
            echo "  loki provider info gemini"
            ;;
    esac
}

cmd_provider_show() {
    local saved_provider=""
    if [ -f "$LOKI_DIR/state/provider" ]; then
        saved_provider=$(cat "$LOKI_DIR/state/provider" 2>/dev/null)
    fi

    local current="${saved_provider:-${LOKI_PROVIDER:-claude}}"

    echo -e "${BOLD}Current Provider${NC}"
    echo ""
    echo -e "${CYAN}Provider:${NC} $current"

    if [ -n "$saved_provider" ]; then
        echo -e "${DIM}(saved in .loki/state/provider)${NC}"
    else
        echo -e "${DIM}(default - not explicitly set)${NC}"
    fi

    echo ""
    echo -e "Switch provider: ${CYAN}loki provider set <name>${NC}"
    echo -e "Available:       ${CYAN}loki provider list${NC}"
}

cmd_provider_set() {
    local new_provider="${1:-}"

    if [ -z "$new_provider" ]; then
        echo -e "${RED}Error: Provider name required${NC}"
        echo "Usage: loki provider set <claude|codex|gemini>"
        exit 1
    fi

    # Validate provider
    case "$new_provider" in
        claude|codex|gemini)
            ;;
        *)
            echo -e "${RED}Error: Invalid provider '$new_provider'${NC}"
            echo "Valid providers: claude, codex, gemini"
            exit 1
            ;;
    esac

    # Save provider
    mkdir -p "$LOKI_DIR/state"
    echo "$new_provider" > "$LOKI_DIR/state/provider"

    echo -e "${GREEN}Provider set to: $new_provider${NC}"
    echo ""
    echo "This will be used for all future runs in this project."
    echo "Override temporarily with: loki start --provider <name>"
}

cmd_provider_list() {
    echo -e "${BOLD}Available Providers${NC}"
    echo ""

    local saved_provider=""
    if [ -f "$LOKI_DIR/state/provider" ]; then
        saved_provider=$(cat "$LOKI_DIR/state/provider" 2>/dev/null)
    fi
    local current="${saved_provider:-${LOKI_PROVIDER:-claude}}"

    # Check which CLIs are installed
    local claude_status="${RED}not installed${NC}"
    local codex_status="${RED}not installed${NC}"
    local gemini_status="${RED}not installed${NC}"

    if command -v claude &> /dev/null; then
        claude_status="${GREEN}installed${NC}"
    fi
    if command -v codex &> /dev/null; then
        codex_status="${GREEN}installed${NC}"
    fi
    if command -v gemini &> /dev/null; then
        gemini_status="${GREEN}installed${NC}"
    fi

    # Display providers
    local marker=""
    [ "$current" = "claude" ] && marker=" ${CYAN}(current)${NC}"
    echo -e "  claude  - Claude Code (Anthropic)     $claude_status$marker"

    marker=""
    [ "$current" = "codex" ] && marker=" ${CYAN}(current)${NC}"
    echo -e "  codex   - Codex CLI (OpenAI)          $codex_status$marker"

    marker=""
    [ "$current" = "gemini" ] && marker=" ${CYAN}(current)${NC}"
    echo -e "  gemini  - Gemini CLI (Google)         $gemini_status$marker"

    echo ""
    echo -e "Set provider: ${CYAN}loki provider set <name>${NC}"
}

cmd_provider_info() {
    local provider="${1:-${LOKI_PROVIDER:-claude}}"

    echo -e "${BOLD}Provider: $provider${NC}"
    echo ""

    case "$provider" in
        claude)
            echo "Name:        Claude Code"
            echo "Vendor:      Anthropic"
            echo "CLI:         claude"
            echo "Flag:        --dangerously-skip-permissions"
            echo ""
            echo "Features:"
            echo "  - Full autonomous mode"
            echo "  - Task tool for subagents"
            echo "  - Parallel execution"
            echo "  - MCP server support"
            echo ""
            echo "Status:      Full features"
            ;;
        codex)
            echo "Name:        Codex CLI"
            echo "Vendor:      OpenAI"
            echo "CLI:         codex"
            echo "Flag:        exec --dangerously-bypass-approvals-and-sandbox"
            echo ""
            echo "Features:"
            echo "  - Autonomous mode"
            echo "  - Sequential only (no subagents)"
            echo ""
            echo "Status:      Degraded mode"
            ;;
        gemini)
            echo "Name:        Gemini CLI"
            echo "Vendor:      Google"
            echo "CLI:         gemini"
            echo "Flag:        --yolo"
            echo ""
            echo "Features:"
            echo "  - Autonomous mode"
            echo "  - Sequential only (no subagents)"
            echo ""
            echo "Status:      Degraded mode"
            ;;
        *)
            echo -e "${RED}Unknown provider: $provider${NC}"
            exit 1
            ;;
    esac
}

# Open dashboard in browser
cmd_dashboard() {
    local port=${LOKI_DASHBOARD_PORT:-57374}
    local url="http://127.0.0.1:$port/dashboard/index.html"

    if [ ! -d "$LOKI_DIR/dashboard" ]; then
        echo -e "${YELLOW}Dashboard not found. Start Loki Mode first.${NC}"
        exit 1
    fi

    echo -e "${GREEN}Opening dashboard: $url${NC}"

    # Open in browser (cross-platform)
    if command -v open &> /dev/null; then
        open "$url"
    elif command -v xdg-open &> /dev/null; then
        xdg-open "$url"
    else
        echo "Please open in browser: $url"
    fi
}

# Import GitHub issues
cmd_import() {
    if [ ! -d "$LOKI_DIR" ]; then
        mkdir -p "$LOKI_DIR/queue"
    fi

    export LOKI_GITHUB_IMPORT=true

    # Check gh CLI
    if ! command -v gh &> /dev/null; then
        echo -e "${RED}Error: gh CLI not found. Install with: brew install gh${NC}"
        exit 1
    fi

    if ! gh auth status &> /dev/null; then
        echo -e "${RED}Error: gh CLI not authenticated. Run: gh auth login${NC}"
        exit 1
    fi

    echo -e "${GREEN}Importing GitHub issues...${NC}"
    # Source the functions from run.sh and call import
    source "$RUN_SH" 2>/dev/null || true
    if type import_github_issues &>/dev/null; then
        import_github_issues
    else
        echo -e "${YELLOW}Import function not available. Using fallback.${NC}"
        gh issue list --json number,title,url --limit 20
    fi
}

# Show configuration
cmd_config() {
    local subcommand="${1:-show}"

    case "$subcommand" in
        show)
            cmd_config_show
            ;;
        init)
            cmd_config_init
            ;;
        edit)
            cmd_config_edit
            ;;
        path)
            cmd_config_path
            ;;
        *)
            echo -e "${YELLOW}Usage: loki config [show|init|edit|path]${NC}"
            echo ""
            echo "  show   Show current configuration (default)"
            echo "  init   Create a config file from template"
            echo "  edit   Open config file in editor"
            echo "  path   Show config file paths"
            ;;
    esac
}

cmd_config_show() {
    echo -e "${BOLD}Loki Mode Configuration${NC}"
    echo ""
    echo -e "${CYAN}Installation:${NC} $SKILL_DIR"
    echo -e "${CYAN}Version:${NC} $(get_version)"
    echo ""

    # Check for config files
    local config_file=""
    if [ -f ".loki/config.yaml" ]; then
        config_file=".loki/config.yaml"
        echo -e "${GREEN}Config file:${NC} $config_file (project-local)"
    elif [ -f ".loki/config.yml" ]; then
        config_file=".loki/config.yml"
        echo -e "${GREEN}Config file:${NC} $config_file (project-local)"
    elif [ -f "${HOME}/.config/loki-mode/config.yaml" ]; then
        config_file="${HOME}/.config/loki-mode/config.yaml"
        echo -e "${GREEN}Config file:${NC} $config_file (user-global)"
    elif [ -f "${HOME}/.config/loki-mode/config.yml" ]; then
        config_file="${HOME}/.config/loki-mode/config.yml"
        echo -e "${GREEN}Config file:${NC} $config_file (user-global)"
    else
        echo -e "${YELLOW}Config file:${NC} Not found (using defaults)"
    fi
    echo ""

    echo -e "${CYAN}Current Settings:${NC}"
    echo ""
    echo "Core:"
    echo "  max_retries:      ${LOKI_MAX_RETRIES:-50}"
    echo "  base_wait:        ${LOKI_BASE_WAIT:-60}s"
    echo "  max_wait:         ${LOKI_MAX_WAIT:-3600}s"
    echo ""
    echo "Dashboard:"
    echo "  enabled:          ${LOKI_DASHBOARD:-true}"
    echo "  port:             ${LOKI_DASHBOARD_PORT:-57374}"
    echo ""
    echo "Notifications:"
    echo "  enabled:          ${LOKI_NOTIFICATIONS:-true}"
    echo "  sound:            ${LOKI_NOTIFICATION_SOUND:-true}"
    echo ""
    echo "GitHub Integration:"
    echo "  import:           ${LOKI_GITHUB_IMPORT:-false}"
    echo "  pr:               ${LOKI_GITHUB_PR:-false}"
    echo "  sync:             ${LOKI_GITHUB_SYNC:-false}"
    echo ""
    echo "Provider:"
    echo "  provider:         ${LOKI_PROVIDER:-claude}"
    echo ""
    echo "Execution:"
    echo "  complexity:       ${LOKI_COMPLEXITY:-auto}"
    echo "  parallel_mode:    ${LOKI_PARALLEL_MODE:-false}"
    echo "  max_iterations:   ${LOKI_MAX_ITERATIONS:-1000}"
    echo "  autonomy_mode:    ${LOKI_AUTONOMY_MODE:-perpetual}"
    echo ""
    echo -e "Run ${CYAN}loki config path${NC} to see all config file locations"
}

cmd_config_init() {
    local template="$SKILL_DIR/autonomy/config.example.yaml"
    local target=".loki/config.yaml"
    local global_target="${HOME}/.config/loki-mode/config.yaml"

    if [ ! -f "$template" ]; then
        echo -e "${RED}Error: Config template not found at $template${NC}"
        exit 1
    fi

    echo -e "${BOLD}Initialize Configuration${NC}"
    echo ""
    echo "Where do you want to create the config file?"
    echo ""
    echo "  1) $target (project-local, recommended)"
    echo "  2) $global_target (user-global)"
    echo ""
    read -p "Choice [1]: " choice
    choice="${choice:-1}"

    case "$choice" in
        1)
            mkdir -p ".loki"
            cp "$template" "$target"
            echo -e "${GREEN}Created: $target${NC}"
            ;;
        2)
            mkdir -p "${HOME}/.config/loki-mode"
            cp "$template" "$global_target"
            echo -e "${GREEN}Created: $global_target${NC}"
            ;;
        *)
            echo -e "${RED}Invalid choice${NC}"
            exit 1
            ;;
    esac

    echo ""
    echo "Edit with: loki config edit"
}

cmd_config_edit() {
    local config_file=""

    # Find existing config file
    if [ -f ".loki/config.yaml" ]; then
        config_file=".loki/config.yaml"
    elif [ -f ".loki/config.yml" ]; then
        config_file=".loki/config.yml"
    elif [ -f "${HOME}/.config/loki-mode/config.yaml" ]; then
        config_file="${HOME}/.config/loki-mode/config.yaml"
    elif [ -f "${HOME}/.config/loki-mode/config.yml" ]; then
        config_file="${HOME}/.config/loki-mode/config.yml"
    fi

    if [ -z "$config_file" ]; then
        echo -e "${YELLOW}No config file found.${NC}"
        read -p "Create one? [Y/n]: " create
        create="${create:-Y}"
        if [[ "$create" =~ ^[Yy] ]]; then
            cmd_config_init
            config_file=".loki/config.yaml"
        else
            exit 0
        fi
    fi

    # Open in editor
    local editor="${EDITOR:-${VISUAL:-vim}}"
    echo -e "${GREEN}Opening $config_file with $editor${NC}"
    "$editor" "$config_file"
}

cmd_config_path() {
    echo -e "${BOLD}Config File Search Paths${NC}"
    echo ""
    echo "Loki Mode searches for config files in this order:"
    echo ""

    local paths=(
        ".loki/config.yaml"
        ".loki/config.yml"
        "${HOME}/.config/loki-mode/config.yaml"
        "${HOME}/.config/loki-mode/config.yml"
    )

    for path in "${paths[@]}"; do
        if [ -f "$path" ]; then
            echo -e "  ${GREEN}[FOUND]${NC}  $path"
        else
            echo -e "  ${YELLOW}[-----]${NC}  $path"
        fi
    done

    echo ""
    echo "Template: $SKILL_DIR/autonomy/config.example.yaml"
    echo ""
    echo "Create a config file with: loki config init"
}

# Show version
cmd_version() {
    echo "Loki Mode v$(get_version)"
}

# Show recent logs
cmd_logs() {
    local lines="${1:-50}"
    local log_file="$LOKI_DIR/logs/session.log"

    if [ ! -f "$log_file" ]; then
        echo -e "${YELLOW}No log file found at $log_file${NC}"
        exit 0
    fi

    echo -e "${BOLD}Recent Logs (last $lines lines)${NC}"
    echo ""
    tail -n "$lines" "$log_file"
}

# API server management
cmd_api() {
    local subcommand="${1:-help}"
    local port="${LOKI_API_PORT:-9898}"
    local pid_file="$LOKI_DIR/api.pid"
    local api_server="$SKILL_DIR/api/server.js"

    case "$subcommand" in
        start)
            # Check if Node.js is available
            if ! command -v node &> /dev/null; then
                echo -e "${RED}Error: Node.js not found. Install with: brew install node${NC}"
                exit 1
            fi

            # Check if already running
            if [ -f "$pid_file" ]; then
                local existing_pid=$(cat "$pid_file")
                if kill -0 "$existing_pid" 2>/dev/null; then
                    echo -e "${YELLOW}API server already running (PID: $existing_pid)${NC}"
                    echo "URL: http://localhost:$port"
                    exit 0
                fi
            fi

            # Start server
            mkdir -p "$LOKI_DIR"
            nohup node "$api_server" --port "$port" > "$LOKI_DIR/logs/api.log" 2>&1 &
            local new_pid=$!
            echo "$new_pid" > "$pid_file"

            echo -e "${GREEN}API server started${NC}"
            echo "  PID:  $new_pid"
            echo "  URL:  http://localhost:$port"
            echo "  Logs: $LOKI_DIR/logs/api.log"
            ;;

        stop)
            if [ -f "$pid_file" ]; then
                local pid=$(cat "$pid_file")
                if kill -0 "$pid" 2>/dev/null; then
                    kill "$pid"
                    rm -f "$pid_file"
                    echo -e "${GREEN}API server stopped${NC}"
                else
                    rm -f "$pid_file"
                    echo -e "${YELLOW}API server was not running${NC}"
                fi
            else
                echo -e "${YELLOW}No API server PID file found${NC}"
            fi
            ;;

        status)
            if [ -f "$pid_file" ]; then
                local pid=$(cat "$pid_file")
                if kill -0 "$pid" 2>/dev/null; then
                    echo -e "${GREEN}API server running${NC}"
                    echo "  PID:  $pid"
                    echo "  URL:  http://localhost:$port"

                    # Try to fetch status
                    if command -v curl &> /dev/null; then
                        echo ""
                        echo -e "${CYAN}Status:${NC}"
                        curl -s "http://localhost:$port/status" 2>/dev/null | jq . 2>/dev/null || true
                    fi
                else
                    echo -e "${YELLOW}API server not running (stale PID file)${NC}"
                    rm -f "$pid_file"
                fi
            else
                echo -e "${YELLOW}API server not running${NC}"
            fi
            ;;

        *)
            echo -e "${BOLD}Loki Mode API Server${NC}"
            echo ""
            echo "Usage: loki api <command>"
            echo ""
            echo "Commands:"
            echo "  start    Start the HTTP API server"
            echo "  stop     Stop the API server"
            echo "  status   Check if API server is running"
            echo ""
            echo "Environment:"
            echo "  LOKI_API_PORT  Port to listen on (default: 9898)"
            echo ""
            echo "Endpoints:"
            echo "  GET  /health  - Health check"
            echo "  GET  /status  - Session status"
            echo "  GET  /events  - SSE stream"
            echo "  GET  /logs    - Recent logs"
            echo "  POST /start   - Start session"
            echo "  POST /stop    - Stop session"
            echo "  POST /pause   - Pause session"
            echo "  POST /resume  - Resume session"
            ;;
    esac
}

# Sandbox management (delegates to sandbox.sh)
cmd_sandbox() {
    local subcommand="${1:-help}"
    shift || true

    if [ ! -f "$SANDBOX_SH" ]; then
        echo -e "${RED}Error: sandbox.sh not found at $SANDBOX_SH${NC}"
        echo "Expected at: $SKILL_DIR/autonomy/sandbox.sh"
        exit 1
    fi

    # Check Docker availability
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}Error: Docker not found${NC}"
        echo ""
        echo "Docker is required for sandbox mode. Install it:"
        echo "  macOS:  brew install --cask docker"
        echo "  Linux:  curl -fsSL https://get.docker.com | sh"
        echo ""
        echo "After installation, start Docker Desktop or the Docker daemon."
        exit 1
    fi

    if ! docker info &> /dev/null 2>&1; then
        echo -e "${RED}Error: Docker daemon not running${NC}"
        echo ""
        echo "Start Docker:"
        echo "  macOS:  Open Docker Desktop app"
        echo "  Linux:  sudo systemctl start docker"
        exit 1
    fi

    # Delegate to sandbox.sh
    exec "$SANDBOX_SH" "$subcommand" "$@"
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        start)
            cmd_start "$@"
            ;;
        stop)
            cmd_stop
            ;;
        pause)
            cmd_pause
            ;;
        resume)
            cmd_resume
            ;;
        status)
            cmd_status
            ;;
        dashboard)
            cmd_dashboard
            ;;
        logs)
            cmd_logs "$@"
            ;;
        serve)
            cmd_api start "$@"
            ;;
        api)
            cmd_api "$@"
            ;;
        sandbox)
            cmd_sandbox "$@"
            ;;
        import)
            cmd_import
            ;;
        config)
            cmd_config "$@"
            ;;
        provider)
            cmd_provider "$@"
            ;;
        version|--version|-v)
            cmd_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}Unknown command: $command${NC}"
            echo "Run 'loki help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
