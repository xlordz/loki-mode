<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Loki Mode Dashboard - Self-contained autonomous AI system monitor">
  <meta name="theme-color" content="#8b5cf6">
  <title>Loki Mode Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><path d='M16 6C8 6 2 16 2 16s6 10 14 10 14-10 14-10S24 6 16 6z' fill='none' stroke='%237c3aed' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><circle cx='16' cy='16' r='5' fill='%237c3aed'/><circle cx='16' cy='16' r='2' fill='%23fff'/></svg>">
  <style>
    /* CSS Reset and Base Styles */
    :root {
      /* Light theme (default) */
      --loki-bg-primary: #fafafa;
      --loki-bg-secondary: #f4f4f5;
      --loki-bg-tertiary: #e4e4e7;
      --loki-bg-card: #ffffff;
      --loki-bg-hover: #f0f0f3;
      --loki-text-primary: #18181b;
      --loki-text-secondary: #52525b;
      --loki-text-muted: #a1a1aa;
      --loki-accent: #7c3aed;
      --loki-accent-hover: #6d28d9;
      --loki-border: #e4e4e7;
      --loki-border-light: #d4d4d8;
      --loki-success: #16a34a;
      --loki-warning: #ca8a04;
      --loki-error: #dc2626;
      --loki-info: #2563eb;
      --loki-transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --loki-bg-primary: #09090b;
        --loki-bg-secondary: #0c0c0f;
        --loki-bg-tertiary: #111114;
        --loki-bg-card: #18181b;
        --loki-bg-hover: #1f1f23;
        --loki-text-primary: #fafafa;
        --loki-text-secondary: #a1a1aa;
        --loki-text-muted: #52525b;
        --loki-accent: #8b5cf6;
        --loki-accent-hover: #a78bfa;
        --loki-border: rgba(255, 255, 255, 0.06);
        --loki-border-light: rgba(255, 255, 255, 0.1);
        --loki-success: #22c55e;
        --loki-warning: #eab308;
        --loki-error: #ef4444;
        --loki-info: #3b82f6;
      }
    }

    [data-loki-theme="light"] {
      --loki-bg-primary: #fafafa;
      --loki-bg-secondary: #f4f4f5;
      --loki-bg-tertiary: #e4e4e7;
      --loki-bg-card: #ffffff;
      --loki-bg-hover: #f0f0f3;
      --loki-text-primary: #18181b;
      --loki-text-secondary: #52525b;
      --loki-text-muted: #a1a1aa;
      --loki-accent: #7c3aed;
      --loki-accent-hover: #6d28d9;
      --loki-border: #e4e4e7;
      --loki-border-light: #d4d4d8;
      --loki-success: #16a34a;
      --loki-warning: #ca8a04;
      --loki-error: #dc2626;
      --loki-info: #2563eb;
    }

    [data-loki-theme="dark"] {
      --loki-bg-primary: #09090b;
      --loki-bg-secondary: #0c0c0f;
      --loki-bg-tertiary: #111114;
      --loki-bg-card: #18181b;
      --loki-bg-hover: #1f1f23;
      --loki-text-primary: #fafafa;
      --loki-text-secondary: #a1a1aa;
      --loki-text-muted: #52525b;
      --loki-accent: #8b5cf6;
      --loki-accent-hover: #a78bfa;
      --loki-border: rgba(255, 255, 255, 0.06);
      --loki-border-light: rgba(255, 255, 255, 0.1);
      --loki-success: #22c55e;
      --loki-warning: #eab308;
      --loki-error: #ef4444;
      --loki-info: #3b82f6;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--loki-bg-primary);
      color: var(--loki-text-primary);
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background var(--loki-transition), color var(--loki-transition);
    }

    /* Dashboard Layout */
    .dashboard-layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      grid-template-rows: 1fr;
      min-height: 100vh;
    }

    @media (max-width: 768px) {
      .dashboard-layout {
        grid-template-columns: 1fr;
      }
      .sidebar { display: none; }
      .sidebar.mobile-open {
        display: flex;
        position: fixed;
        left: 0; top: 0; bottom: 0;
        width: 240px;
        z-index: 100;
      }
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      background: var(--loki-bg-card);
      border-right: 1px solid var(--loki-border);
      overflow-y: auto;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 20px 16px 16px;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #8b5cf6, #6d28d9);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      color: white;
    }

    .logo-text {
      font-size: 14px;
      font-weight: 600;
      color: var(--loki-text-primary);
    }

    /* Navigation */
    .nav-links {
      display: flex;
      flex-direction: column;
      padding: 8px;
      gap: 2px;
      flex: 1;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--loki-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
      background: none;
      text-align: left;
      width: 100%;
      font-family: inherit;
    }

    .nav-link:hover {
      color: var(--loki-text-primary);
      background: var(--loki-bg-hover);
    }

    .nav-link.active {
      color: var(--loki-accent);
      background: rgba(124, 58, 237, 0.08);
      border-color: rgba(124, 58, 237, 0.12);
    }

    .nav-link svg {
      width: 16px;
      height: 16px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
      flex-shrink: 0;
    }

    /* Sidebar footer */
    .sidebar-footer {
      padding: 12px;
      border-top: 1px solid var(--loki-border);
    }

    .sidebar-controls {
      display: flex;
      gap: 6px;
      align-items: center;
      padding: 8px 4px 0;
    }

    .theme-toggle, .api-btn {
      padding: 5px 10px;
      background: var(--loki-bg-tertiary);
      border: 1px solid var(--loki-border);
      border-radius: 6px;
      font-size: 11px;
      color: var(--loki-text-secondary);
      cursor: pointer;
      transition: all var(--loki-transition);
      font-family: inherit;
    }

    .theme-toggle:hover, .api-btn:hover {
      background: var(--loki-bg-hover);
      color: var(--loki-text-primary);
    }

    .api-url-input {
      padding: 5px 8px;
      background: var(--loki-bg-card);
      border: 1px solid var(--loki-border);
      border-radius: 6px;
      font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      color: var(--loki-text-primary);
      flex: 1;
      min-width: 0;
    }

    .api-url-input:focus {
      outline: none;
      border-color: var(--loki-accent);
    }

    /* Main Content */
    .main-content {
      padding: 24px 28px;
      overflow-y: auto;
      height: 100vh;
      scroll-behavior: smooth;
    }

    /* Section pages */
    .section-page {
      padding-bottom: 32px;
    }

    .section-page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-top: 4px;
    }

    .section-page-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--loki-text-primary);
    }

    /* Overview handled by <loki-overview> shadow DOM */

    /* Offline Banner */
    .offline-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--loki-warning);
      color: #18181b;
      padding: 8px 16px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      display: none;
      z-index: 999;
    }

    .offline-banner.show {
      display: block;
    }

    /* Loading state */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--loki-text-muted);
    }

    .loading::after {
      content: '';
      width: 20px;
      height: 20px;
      margin-left: 10px;
      border: 2px solid var(--loki-border);
      border-top-color: var(--loki-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile menu button */
    .mobile-menu-btn {
      display: none;
      padding: 8px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--loki-text-primary);
    }

    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: block;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }

    /* Keyboard Shortcuts Help Overlay */
    .shortcuts-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .shortcuts-overlay.visible {
      display: flex;
    }

    .shortcuts-dialog {
      background: var(--loki-bg-card);
      border: 1px solid var(--loki-border);
      border-radius: 12px;
      padding: 24px;
      max-width: 480px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .shortcuts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--loki-border);
    }

    .shortcuts-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--loki-text-primary);
    }

    .shortcuts-close {
      background: none;
      border: none;
      color: var(--loki-text-muted);
      cursor: pointer;
      padding: 4px;
      font-size: 18px;
      line-height: 1;
    }

    .shortcuts-close:hover {
      color: var(--loki-text-primary);
    }

    .shortcuts-group {
      margin-bottom: 16px;
    }

    .shortcuts-group-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--loki-text-muted);
      margin-bottom: 8px;
    }

    .shortcut-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
    }

    .shortcut-keys {
      display: flex;
      gap: 4px;
    }

    .shortcut-key {
      display: inline-block;
      padding: 2px 8px;
      background: var(--loki-bg-tertiary);
      border: 1px solid var(--loki-border);
      border-radius: 4px;
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
      color: var(--loki-text-primary);
      min-width: 24px;
      text-align: center;
    }

    .shortcut-desc {
      font-size: 13px;
      color: var(--loki-text-secondary);
    }
  </style>
</head>
<body>
  <!-- Offline Banner -->
  <div class="offline-banner" id="offline-banner">
    Offline - showing cached data
  </div>

  <!-- Dashboard Layout -->
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo">
        <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Toggle menu">
          <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
        <div class="logo-icon">L</div>
        <span class="logo-text">Loki Mode</span>
      </div>

      <nav class="nav-links">
        <button class="nav-link active" data-section="overview" id="nav-overview">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Overview
        </button>
        <button class="nav-link" data-section="tasks" id="nav-tasks">
          <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          Tasks
        </button>
        <button class="nav-link" data-section="logs" id="nav-logs">
          <svg viewBox="0 0 24 24"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
          Logs
        </button>
        <button class="nav-link" data-section="memory" id="nav-memory">
          <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
          Memory
        </button>
        <button class="nav-link" data-section="learning" id="nav-learning">
          <svg viewBox="0 0 24 24"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
          Learning
        </button>
        <button class="nav-link" data-section="prd-checklist" id="nav-prd-checklist">
          <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
          PRD Checklist
        </button>
        <button class="nav-link" data-section="app-runner" id="nav-app-runner">
          <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          App Runner
        </button>
        <button class="nav-link" data-section="council" id="nav-council">
          <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
          Council
        </button>
        <button class="nav-link" data-section="cost" id="nav-cost">
          <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
          Cost
        </button>
        <button class="nav-link" data-section="checkpoint" id="nav-checkpoint">
          <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Checkpoints
        </button>
        <button class="nav-link" data-section="context" id="nav-context">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          Context
        </button>
        <button class="nav-link" data-section="notifications" id="nav-notifications">
          <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
          Notifications
          <span class="notification-badge" id="notif-badge" style="display:none;background:var(--loki-red);color:#fff;font-size:10px;padding:1px 5px;border-radius:8px;margin-left:4px;">0</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        <loki-session-control id="session-control"></loki-session-control>
        <div class="sidebar-controls">
          <input type="text" class="api-url-input" id="api-url" placeholder="API URL">
          <button class="api-btn" id="connect-btn">Go</button>
          <button class="theme-toggle" id="theme-toggle" title="Toggle theme (T)">
            <svg id="theme-icon-sun" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" style="display:none"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
            <svg id="theme-icon-moon" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" style="display:none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
            <span id="theme-label">Dark</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
      <!-- Overview (default) -->
      <div class="section-page" id="page-overview">
        <loki-overview id="overview"></loki-overview>
      </div>

      <!-- Task Board -->
      <div class="section-page" id="page-tasks">
        <div class="section-page-header">
          <h2 class="section-page-title">Tasks</h2>
        </div>
        <loki-task-board id="task-board"></loki-task-board>
      </div>

      <!-- Log Stream -->
      <div class="section-page" id="page-logs">
        <div class="section-page-header">
          <h2 class="section-page-title">Logs</h2>
        </div>
        <loki-log-stream id="log-stream" auto-scroll max-lines="500"></loki-log-stream>
      </div>

      <!-- Memory Browser -->
      <div class="section-page" id="page-memory">
        <div class="section-page-header">
          <h2 class="section-page-title">Memory</h2>
        </div>
        <loki-memory-browser id="memory-browser" tab="summary"></loki-memory-browser>
      </div>

      <!-- Learning Dashboard -->
      <div class="section-page" id="page-learning">
        <div class="section-page-header">
          <h2 class="section-page-title">Learning Metrics</h2>
        </div>
        <loki-learning-dashboard id="learning-dashboard" time-range="7d"></loki-learning-dashboard>
      </div>

      <!-- PRD Checklist -->
      <div class="section-page" id="page-prd-checklist">
        <div class="section-page-header">
          <h2 class="section-page-title">PRD Checklist</h2>
        </div>
        <loki-checklist-viewer id="checklist-viewer"></loki-checklist-viewer>
      </div>

      <!-- App Runner -->
      <div class="section-page" id="page-app-runner">
        <div class="section-page-header">
          <h2 class="section-page-title">App Runner</h2>
        </div>
        <loki-app-status id="app-status"></loki-app-status>
      </div>

      <!-- Completion Council -->
      <div class="section-page" id="page-council">
        <div class="section-page-header">
          <h2 class="section-page-title">Completion Council</h2>
        </div>
        <loki-council-dashboard id="council-dashboard"></loki-council-dashboard>
      </div>

      <!-- Cost Dashboard -->
      <div class="section-page" id="page-cost">
        <div class="section-page-header">
          <h2 class="section-page-title">Cost</h2>
        </div>
        <loki-cost-dashboard id="cost-dashboard"></loki-cost-dashboard>
      </div>

      <!-- Checkpoints -->
      <div class="section-page" id="page-checkpoint">
        <div class="section-page-header">
          <h2 class="section-page-title">Checkpoints</h2>
        </div>
        <loki-checkpoint-viewer id="checkpoint-viewer"></loki-checkpoint-viewer>
      </div>

      <!-- Context Window Tracking -->
      <div class="section-page" id="page-context">
        <div class="section-page-header">
          <h2 class="section-page-title">Context Window</h2>
        </div>
        <loki-context-tracker id="context-tracker"></loki-context-tracker>
      </div>

      <!-- Notifications -->
      <div class="section-page" id="page-notifications">
        <div class="section-page-header">
          <h2 class="section-page-title">Notifications</h2>
        </div>
        <loki-notification-center id="notification-center"></loki-notification-center>
      </div>
    </main>
  </div>

  <!-- Keyboard Shortcuts Help Overlay -->
  <div class="shortcuts-overlay" id="shortcuts-overlay">
    <div class="shortcuts-dialog">
      <div class="shortcuts-header">
        <span class="shortcuts-title">Keyboard Shortcuts</span>
        <button class="shortcuts-close" id="shortcuts-close" aria-label="Close">&times;</button>
      </div>
      <div class="shortcuts-group">
        <div class="shortcuts-group-title">Navigation</div>
        <div class="shortcut-row"><span class="shortcut-desc">Overview</span><span class="shortcut-keys"><kbd class="shortcut-key">1</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Tasks</span><span class="shortcut-keys"><kbd class="shortcut-key">2</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Logs</span><span class="shortcut-keys"><kbd class="shortcut-key">3</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Memory</span><span class="shortcut-keys"><kbd class="shortcut-key">4</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Learning</span><span class="shortcut-keys"><kbd class="shortcut-key">5</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">App Runner</span><span class="shortcut-keys"><kbd class="shortcut-key">7</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Council</span><span class="shortcut-keys"><kbd class="shortcut-key">8</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Cost</span><span class="shortcut-keys"><kbd class="shortcut-key">9</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Checkpoints</span><span class="shortcut-keys"><kbd class="shortcut-key">0</kbd></span></div>
      </div>
      <div class="shortcuts-group">
        <div class="shortcuts-group-title">Session</div>
        <div class="shortcut-row"><span class="shortcut-desc">Pause session</span><span class="shortcut-keys"><kbd class="shortcut-key">p</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Resume session</span><span class="shortcut-keys"><kbd class="shortcut-key">r</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Stop session</span><span class="shortcut-keys"><kbd class="shortcut-key">s</kbd></span></div>
      </div>
      <div class="shortcuts-group">
        <div class="shortcuts-group-title">General</div>
        <div class="shortcut-row"><span class="shortcut-desc">Toggle theme</span><span class="shortcut-keys"><kbd class="shortcut-key">t</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Focus API URL</span><span class="shortcut-keys"><kbd class="shortcut-key">/</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Show shortcuts</span><span class="shortcut-keys"><kbd class="shortcut-key">?</kbd></span></div>
        <div class="shortcut-row"><span class="shortcut-desc">Close overlay</span><span class="shortcut-keys"><kbd class="shortcut-key">Esc</kbd></span></div>
      </div>
    </div>
  </div>

  <!-- Inlined JavaScript Bundle -->
  <script>
var LokiDashboard=(()=>{var X=Object.defineProperty;var ht=Object.getOwnPropertyDescriptor;var vt=Object.getOwnPropertyNames;var mt=Object.prototype.hasOwnProperty;var bt=(d,t,e)=>t in d?X(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var ft=(d,t)=>{for(var e in t)X(d,e,{get:t[e],enumerable:!0})},kt=(d,t,e,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of vt(t))!mt.call(d,i)&&i!==e&&X(d,i,{get:()=>t[i],enumerable:!(a=ht(t,i))||a.enumerable});return d};var _t=d=>kt(X({},"__esModule",{value:!0}),d);var f=(d,t,e)=>bt(d,typeof t!="symbol"?t+"":t,e);var It={};ft(It,{ANIMATION:()=>$,ARIA_PATTERNS:()=>tt,ApiEvents:()=>n,BASE_STYLES:()=>H,BREAKPOINTS:()=>Z,COMMON_STYLES:()=>ot,KEYBOARD_SHORTCUTS:()=>Q,KeyboardHandler:()=>I,LokiApiClient:()=>D,LokiAppStatus:()=>K,LokiChecklistViewer:()=>G,LokiCheckpointViewer:()=>V,LokiContextTracker:()=>Y,LokiCostDashboard:()=>J,LokiCouncilDashboard:()=>q,LokiElement:()=>c,LokiLearningDashboard:()=>N,LokiLogStream:()=>F,LokiMemoryBrowser:()=>O,LokiNotificationCenter:()=>W,LokiOverview:()=>B,LokiSessionControl:()=>j,LokiState:()=>z,LokiTaskBoard:()=>U,LokiTheme:()=>A,RADIUS:()=>w,SPACING:()=>_,STATE_CHANGE_EVENT:()=>it,THEMES:()=>b,THEME_VARIABLES:()=>et,TYPOGRAPHY:()=>v,UnifiedThemeManager:()=>h,VERSION:()=>At,Z_INDEX:()=>T,createApiClient:()=>dt,createStore:()=>ct,generateThemeCSS:()=>m,generateTokensCSS:()=>M,getApiClient:()=>u,getState:()=>L,init:()=>Lt});var b={light:{"--loki-bg-primary":"#fafafa","--loki-bg-secondary":"#f4f4f5","--loki-bg-tertiary":"#e4e4e7","--loki-bg-card":"#ffffff","--loki-bg-hover":"#f0f0f3","--loki-bg-active":"#e8e8ec","--loki-bg-overlay":"rgba(0, 0, 0, 0.5)","--loki-accent":"#7c3aed","--loki-accent-hover":"#6d28d9","--loki-accent-active":"#5b21b6","--loki-accent-light":"#8b5cf6","--loki-accent-muted":"rgba(124, 58, 237, 0.12)","--loki-text-primary":"#18181b","--loki-text-secondary":"#52525b","--loki-text-muted":"#a1a1aa","--loki-text-disabled":"#d4d4d8","--loki-text-inverse":"#ffffff","--loki-border":"#e4e4e7","--loki-border-light":"#d4d4d8","--loki-border-focus":"#7c3aed","--loki-success":"#16a34a","--loki-success-muted":"rgba(22, 163, 74, 0.12)","--loki-warning":"#ca8a04","--loki-warning-muted":"rgba(202, 138, 4, 0.12)","--loki-error":"#dc2626","--loki-error-muted":"rgba(220, 38, 38, 0.12)","--loki-info":"#2563eb","--loki-info-muted":"rgba(37, 99, 235, 0.12)","--loki-green":"#16a34a","--loki-green-muted":"rgba(22, 163, 74, 0.12)","--loki-yellow":"#ca8a04","--loki-yellow-muted":"rgba(202, 138, 4, 0.12)","--loki-red":"#dc2626","--loki-red-muted":"rgba(220, 38, 38, 0.12)","--loki-blue":"#2563eb","--loki-blue-muted":"rgba(37, 99, 235, 0.12)","--loki-purple":"#9333ea","--loki-purple-muted":"rgba(147, 51, 234, 0.12)","--loki-opus":"#d97706","--loki-sonnet":"#4f46e5","--loki-haiku":"#059669","--loki-shadow-sm":"0 1px 2px rgba(0, 0, 0, 0.05)","--loki-shadow-md":"0 4px 6px rgba(0, 0, 0, 0.07)","--loki-shadow-lg":"0 10px 15px rgba(0, 0, 0, 0.1)","--loki-shadow-focus":"0 0 0 3px rgba(124, 58, 237, 0.3)"},dark:{"--loki-bg-primary":"#09090b","--loki-bg-secondary":"#0c0c0f","--loki-bg-tertiary":"#111114","--loki-bg-card":"#18181b","--loki-bg-hover":"#1f1f23","--loki-bg-active":"#27272a","--loki-bg-overlay":"rgba(0, 0, 0, 0.8)","--loki-accent":"#8b5cf6","--loki-accent-hover":"#a78bfa","--loki-accent-active":"#7c3aed","--loki-accent-light":"#a78bfa","--loki-accent-muted":"rgba(139, 92, 246, 0.15)","--loki-text-primary":"#fafafa","--loki-text-secondary":"#a1a1aa","--loki-text-muted":"#52525b","--loki-text-disabled":"#3f3f46","--loki-text-inverse":"#09090b","--loki-border":"rgba(255, 255, 255, 0.06)","--loki-border-light":"rgba(255, 255, 255, 0.1)","--loki-border-focus":"#8b5cf6","--loki-success":"#22c55e","--loki-success-muted":"rgba(34, 197, 94, 0.15)","--loki-warning":"#eab308","--loki-warning-muted":"rgba(234, 179, 8, 0.15)","--loki-error":"#ef4444","--loki-error-muted":"rgba(239, 68, 68, 0.15)","--loki-info":"#3b82f6","--loki-info-muted":"rgba(59, 130, 246, 0.15)","--loki-green":"#22c55e","--loki-green-muted":"rgba(34, 197, 94, 0.15)","--loki-yellow":"#eab308","--loki-yellow-muted":"rgba(234, 179, 8, 0.15)","--loki-red":"#ef4444","--loki-red-muted":"rgba(239, 68, 68, 0.15)","--loki-blue":"#3b82f6","--loki-blue-muted":"rgba(59, 130, 246, 0.15)","--loki-purple":"#a78bfa","--loki-purple-muted":"rgba(167, 139, 250, 0.15)","--loki-opus":"#f59e0b","--loki-sonnet":"#818cf8","--loki-haiku":"#34d399","--loki-shadow-sm":"0 1px 2px rgba(0, 0, 0, 0.4)","--loki-shadow-md":"0 4px 12px rgba(0, 0, 0, 0.5)","--loki-shadow-lg":"0 10px 25px rgba(0, 0, 0, 0.6)","--loki-shadow-focus":"0 0 0 3px rgba(139, 92, 246, 0.25)"},"high-contrast":{"--loki-bg-primary":"#000000","--loki-bg-secondary":"#0a0a0a","--loki-bg-tertiary":"#141414","--loki-bg-card":"#0a0a0a","--loki-bg-hover":"#1a1a1a","--loki-bg-active":"#242424","--loki-bg-overlay":"rgba(0, 0, 0, 0.9)","--loki-accent":"#c084fc","--loki-accent-hover":"#d8b4fe","--loki-accent-active":"#e9d5ff","--loki-accent-light":"#d8b4fe","--loki-accent-muted":"rgba(192, 132, 252, 0.25)","--loki-text-primary":"#ffffff","--loki-text-secondary":"#e0e0e0","--loki-text-muted":"#b0b0b0","--loki-text-disabled":"#666666","--loki-text-inverse":"#000000","--loki-border":"#ffffff","--loki-border-light":"#cccccc","--loki-border-focus":"#c084fc","--loki-success":"#4ade80","--loki-success-muted":"rgba(74, 222, 128, 0.25)","--loki-warning":"#fde047","--loki-warning-muted":"rgba(253, 224, 71, 0.25)","--loki-error":"#f87171","--loki-error-muted":"rgba(248, 113, 113, 0.25)","--loki-info":"#60a5fa","--loki-info-muted":"rgba(96, 165, 250, 0.25)","--loki-green":"#4ade80","--loki-green-muted":"rgba(74, 222, 128, 0.25)","--loki-yellow":"#fde047","--loki-yellow-muted":"rgba(253, 224, 71, 0.25)","--loki-red":"#f87171","--loki-red-muted":"rgba(248, 113, 113, 0.25)","--loki-blue":"#60a5fa","--loki-blue-muted":"rgba(96, 165, 250, 0.25)","--loki-purple":"#c084fc","--loki-purple-muted":"rgba(192, 132, 252, 0.25)","--loki-opus":"#fbbf24","--loki-sonnet":"#818cf8","--loki-haiku":"#34d399","--loki-shadow-sm":"none","--loki-shadow-md":"none","--loki-shadow-lg":"none","--loki-shadow-focus":"0 0 0 3px #c084fc"},"vscode-light":{"--loki-bg-primary":"var(--vscode-editor-background, #ffffff)","--loki-bg-secondary":"var(--vscode-sideBar-background, #f3f3f3)","--loki-bg-tertiary":"var(--vscode-input-background, #ffffff)","--loki-bg-card":"var(--vscode-editor-background, #ffffff)","--loki-bg-hover":"var(--vscode-list-hoverBackground, #e8e8e8)","--loki-bg-active":"var(--vscode-list-activeSelectionBackground, #0060c0)","--loki-bg-overlay":"rgba(0, 0, 0, 0.4)","--loki-accent":"var(--vscode-focusBorder, #0066cc)","--loki-accent-hover":"var(--vscode-button-hoverBackground, #0055aa)","--loki-accent-active":"var(--vscode-button-background, #007acc)","--loki-accent-light":"var(--vscode-focusBorder, #0066cc)","--loki-accent-muted":"var(--vscode-editor-selectionBackground, rgba(0, 102, 204, 0.2))","--loki-text-primary":"var(--vscode-foreground, #333333)","--loki-text-secondary":"var(--vscode-descriptionForeground, #717171)","--loki-text-muted":"var(--vscode-disabledForeground, #a0a0a0)","--loki-text-disabled":"var(--vscode-disabledForeground, #cccccc)","--loki-text-inverse":"var(--vscode-button-foreground, #ffffff)","--loki-border":"var(--vscode-widget-border, #c8c8c8)","--loki-border-light":"var(--vscode-widget-border, #e0e0e0)","--loki-border-focus":"var(--vscode-focusBorder, #0066cc)","--loki-success":"var(--vscode-testing-iconPassed, #388a34)","--loki-success-muted":"rgba(56, 138, 52, 0.15)","--loki-warning":"var(--vscode-editorWarning-foreground, #bf8803)","--loki-warning-muted":"rgba(191, 136, 3, 0.15)","--loki-error":"var(--vscode-errorForeground, #e51400)","--loki-error-muted":"rgba(229, 20, 0, 0.15)","--loki-info":"var(--vscode-editorInfo-foreground, #1a85ff)","--loki-info-muted":"rgba(26, 133, 255, 0.15)","--loki-green":"var(--vscode-testing-iconPassed, #388a34)","--loki-green-muted":"rgba(56, 138, 52, 0.15)","--loki-yellow":"var(--vscode-editorWarning-foreground, #bf8803)","--loki-yellow-muted":"rgba(191, 136, 3, 0.15)","--loki-red":"var(--vscode-errorForeground, #e51400)","--loki-red-muted":"rgba(229, 20, 0, 0.15)","--loki-blue":"var(--vscode-editorInfo-foreground, #1a85ff)","--loki-blue-muted":"rgba(26, 133, 255, 0.15)","--loki-purple":"#9333ea","--loki-purple-muted":"rgba(147, 51, 234, 0.15)","--loki-opus":"#d97706","--loki-sonnet":"#4f46e5","--loki-haiku":"#059669","--loki-shadow-sm":"0 1px 2px rgba(0, 0, 0, 0.05)","--loki-shadow-md":"0 2px 4px rgba(0, 0, 0, 0.1)","--loki-shadow-lg":"0 4px 8px rgba(0, 0, 0, 0.15)","--loki-shadow-focus":"0 0 0 2px var(--vscode-focusBorder, #0066cc)"},"vscode-dark":{"--loki-bg-primary":"var(--vscode-editor-background, #1e1e1e)","--loki-bg-secondary":"var(--vscode-sideBar-background, #252526)","--loki-bg-tertiary":"var(--vscode-input-background, #3c3c3c)","--loki-bg-card":"var(--vscode-editor-background, #1e1e1e)","--loki-bg-hover":"var(--vscode-list-hoverBackground, #2a2d2e)","--loki-bg-active":"var(--vscode-list-activeSelectionBackground, #094771)","--loki-bg-overlay":"rgba(0, 0, 0, 0.6)","--loki-accent":"var(--vscode-focusBorder, #007fd4)","--loki-accent-hover":"var(--vscode-button-hoverBackground, #1177bb)","--loki-accent-active":"var(--vscode-button-background, #0e639c)","--loki-accent-light":"var(--vscode-focusBorder, #007fd4)","--loki-accent-muted":"var(--vscode-editor-selectionBackground, rgba(0, 127, 212, 0.25))","--loki-text-primary":"var(--vscode-foreground, #cccccc)","--loki-text-secondary":"var(--vscode-descriptionForeground, #9d9d9d)","--loki-text-muted":"var(--vscode-disabledForeground, #6b6b6b)","--loki-text-disabled":"var(--vscode-disabledForeground, #4d4d4d)","--loki-text-inverse":"var(--vscode-button-foreground, #ffffff)","--loki-border":"var(--vscode-widget-border, #454545)","--loki-border-light":"var(--vscode-widget-border, #5a5a5a)","--loki-border-focus":"var(--vscode-focusBorder, #007fd4)","--loki-success":"var(--vscode-testing-iconPassed, #89d185)","--loki-success-muted":"rgba(137, 209, 133, 0.2)","--loki-warning":"var(--vscode-editorWarning-foreground, #cca700)","--loki-warning-muted":"rgba(204, 167, 0, 0.2)","--loki-error":"var(--vscode-errorForeground, #f48771)","--loki-error-muted":"rgba(244, 135, 113, 0.2)","--loki-info":"var(--vscode-editorInfo-foreground, #75beff)","--loki-info-muted":"rgba(117, 190, 255, 0.2)","--loki-green":"var(--vscode-testing-iconPassed, #89d185)","--loki-green-muted":"rgba(137, 209, 133, 0.2)","--loki-yellow":"var(--vscode-editorWarning-foreground, #cca700)","--loki-yellow-muted":"rgba(204, 167, 0, 0.2)","--loki-red":"var(--vscode-errorForeground, #f48771)","--loki-red-muted":"rgba(244, 135, 113, 0.2)","--loki-blue":"var(--vscode-editorInfo-foreground, #75beff)","--loki-blue-muted":"rgba(117, 190, 255, 0.2)","--loki-purple":"#c084fc","--loki-purple-muted":"rgba(192, 132, 252, 0.2)","--loki-opus":"#f59e0b","--loki-sonnet":"#818cf8","--loki-haiku":"#34d399","--loki-shadow-sm":"0 1px 2px rgba(0, 0, 0, 0.3)","--loki-shadow-md":"0 2px 4px rgba(0, 0, 0, 0.4)","--loki-shadow-lg":"0 4px 8px rgba(0, 0, 0, 0.5)","--loki-shadow-focus":"0 0 0 2px var(--vscode-focusBorder, #007fd4)"}},_={xs:"4px",sm:"8px",md:"12px",lg:"16px",xl:"24px","2xl":"32px","3xl":"48px"},w={none:"0",sm:"4px",md:"6px",lg:"8px",xl:"10px",full:"9999px"},v={fontFamily:{sans:"'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",mono:"'JetBrains Mono', 'Fira Code', 'SF Mono', Menlo, monospace"},fontSize:{xs:"10px",sm:"11px",base:"12px",md:"13px",lg:"14px",xl:"16px","2xl":"18px","3xl":"24px"},fontWeight:{normal:"400",medium:"500",semibold:"600",bold:"700"},lineHeight:{tight:"1.25",normal:"1.5",relaxed:"1.75"}},$={duration:{fast:"100ms",normal:"200ms",slow:"300ms",slower:"500ms"},easing:{default:"cubic-bezier(0.4, 0, 0.2, 1)",in:"cubic-bezier(0.4, 0, 1, 1)",out:"cubic-bezier(0, 0, 0.2, 1)",bounce:"cubic-bezier(0.68, -0.55, 0.265, 1.55)"}},Z={sm:"640px",md:"768px",lg:"1024px",xl:"1280px","2xl":"1536px"},T={base:"0",dropdown:"100",sticky:"200",modal:"300",popover:"400",tooltip:"500",toast:"600"},Q={"navigation.nextItem":{key:"ArrowDown",modifiers:[]},"navigation.prevItem":{key:"ArrowUp",modifiers:[]},"navigation.nextSection":{key:"Tab",modifiers:[]},"navigation.prevSection":{key:"Tab",modifiers:["Shift"]},"navigation.confirm":{key:"Enter",modifiers:[]},"navigation.cancel":{key:"Escape",modifiers:[]},"action.refresh":{key:"r",modifiers:["Meta"]},"action.search":{key:"k",modifiers:["Meta"]},"action.save":{key:"s",modifiers:["Meta"]},"action.close":{key:"w",modifiers:["Meta"]},"theme.toggle":{key:"d",modifiers:["Meta","Shift"]},"task.create":{key:"n",modifiers:["Meta"]},"task.complete":{key:"Enter",modifiers:["Meta"]},"view.toggleLogs":{key:"l",modifiers:["Meta","Shift"]},"view.toggleMemory":{key:"m",modifiers:["Meta","Shift"]}},tt={button:{role:"button",tabIndex:0},tablist:{role:"tablist"},tab:{role:"tab",ariaSelected:!1,tabIndex:-1},tabpanel:{role:"tabpanel",tabIndex:0},list:{role:"list"},listitem:{role:"listitem"},livePolite:{ariaLive:"polite",ariaAtomic:!0},liveAssertive:{ariaLive:"assertive",ariaAtomic:!0},dialog:{role:"dialog",ariaModal:!0},alertdialog:{role:"alertdialog",ariaModal:!0},status:{role:"status",ariaLive:"polite"},alert:{role:"alert",ariaLive:"assertive"},log:{role:"log",ariaLive:"polite",ariaRelevant:"additions"}};function m(d){let t=b[d];return t?Object.entries(t).map(([e,a])=>`${e}: ${a};`).join(`
    `):""}function M(){return`
    /* Spacing */
    --loki-space-xs: ${_.xs};
    --loki-space-sm: ${_.sm};
    --loki-space-md: ${_.md};
    --loki-space-lg: ${_.lg};
    --loki-space-xl: ${_.xl};
    --loki-space-2xl: ${_["2xl"]};
    --loki-space-3xl: ${_["3xl"]};

    /* Border Radius */
    --loki-radius-none: ${w.none};
    --loki-radius-sm: ${w.sm};
    --loki-radius-md: ${w.md};
    --loki-radius-lg: ${w.lg};
    --loki-radius-xl: ${w.xl};
    --loki-radius-full: ${w.full};

    /* Typography */
    --loki-font-sans: ${v.fontFamily.sans};
    --loki-font-mono: ${v.fontFamily.mono};
    --loki-text-xs: ${v.fontSize.xs};
    --loki-text-sm: ${v.fontSize.sm};
    --loki-text-base: ${v.fontSize.base};
    --loki-text-md: ${v.fontSize.md};
    --loki-text-lg: ${v.fontSize.lg};
    --loki-text-xl: ${v.fontSize.xl};
    --loki-text-2xl: ${v.fontSize["2xl"]};
    --loki-text-3xl: ${v.fontSize["3xl"]};

    /* Animation */
    --loki-duration-fast: ${$.duration.fast};
    --loki-duration-normal: ${$.duration.normal};
    --loki-duration-slow: ${$.duration.slow};
    --loki-easing-default: ${$.easing.default};
    --loki-transition: ${$.duration.normal} ${$.easing.default};

    /* Z-Index */
    --loki-z-dropdown: ${T.dropdown};
    --loki-z-sticky: ${T.sticky};
    --loki-z-modal: ${T.modal};
    --loki-z-popover: ${T.popover};
    --loki-z-tooltip: ${T.tooltip};
    --loki-z-toast: ${T.toast};

    /* Glass effect */
    --loki-glass-bg: rgba(255, 255, 255, 0.03);
    --loki-glass-border: rgba(255, 255, 255, 0.06);
    --loki-glass-blur: blur(12px);
  `}var H=`
  /* Reset and base */
  :host {
    font-family: var(--loki-font-sans);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    box-sizing: border-box;
    color: var(--loki-text-primary);
  }

  :host *, :host *::before, :host *::after {
    box-sizing: border-box;
  }

  /* Monospace utility */
  .mono {
    font-family: var(--loki-font-mono);
  }

  /* Focus visible outline */
  :focus-visible {
    outline: 2px solid var(--loki-border-focus);
    outline-offset: 2px;
  }

  :focus:not(:focus-visible) {
    outline: none;
  }

  /* Button base */
  .btn {
    padding: var(--loki-space-sm) var(--loki-space-md);
    border-radius: var(--loki-radius-md);
    font-size: var(--loki-text-md);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--loki-transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--loki-space-xs);
    border: 1px solid transparent;
    text-decoration: none;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .btn-primary {
    background: var(--loki-accent);
    color: var(--loki-text-inverse);
  }

  .btn-primary:hover:not(:disabled) {
    background: var(--loki-accent-hover);
  }

  .btn-primary:active:not(:disabled) {
    background: var(--loki-accent-active);
  }

  .btn-secondary {
    background: var(--loki-bg-tertiary);
    color: var(--loki-text-primary);
    border-color: var(--loki-border);
  }

  .btn-secondary:hover:not(:disabled) {
    background: var(--loki-bg-hover);
    border-color: var(--loki-border-light);
  }

  .btn-ghost {
    background: transparent;
    color: var(--loki-text-secondary);
  }

  .btn-ghost:hover:not(:disabled) {
    background: var(--loki-bg-hover);
    color: var(--loki-text-primary);
  }

  .btn-danger {
    background: var(--loki-error);
    color: var(--loki-text-inverse);
  }

  .btn-danger:hover:not(:disabled) {
    background: var(--loki-red);
    filter: brightness(1.1);
  }

  /* Button sizes */
  .btn-sm {
    padding: var(--loki-space-xs) var(--loki-space-sm);
    font-size: var(--loki-text-sm);
  }

  .btn-lg {
    padding: var(--loki-space-md) var(--loki-space-lg);
    font-size: var(--loki-text-lg);
  }

  /* Status indicators */
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: var(--loki-radius-full);
    flex-shrink: 0;
  }

  .status-dot.active {
    background: var(--loki-success);
    animation: pulse 2s infinite;
  }
  .status-dot.idle { background: var(--loki-text-muted); }
  .status-dot.paused { background: var(--loki-warning); }
  .status-dot.stopped { background: var(--loki-error); }
  .status-dot.error { background: var(--loki-error); }
  .status-dot.offline { background: var(--loki-text-muted); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Card base */
  .card {
    background: var(--loki-bg-card);
    border: 1px solid var(--loki-border);
    border-radius: var(--loki-radius-xl);
    padding: var(--loki-space-lg);
    transition: all var(--loki-transition);
  }

  .card:hover {
    border-color: var(--loki-border-light);
  }

  .card-interactive {
    cursor: pointer;
  }

  .card-interactive:hover {
    transform: translateY(-1px);
    box-shadow: var(--loki-shadow-md);
  }

  /* Input base */
  .input {
    width: 100%;
    padding: var(--loki-space-sm) var(--loki-space-md);
    background: var(--loki-bg-tertiary);
    border: 1px solid var(--loki-border);
    border-radius: var(--loki-radius-md);
    font-size: var(--loki-text-base);
    color: var(--loki-text-primary);
    transition: all var(--loki-transition);
  }

  .input::placeholder {
    color: var(--loki-text-muted);
  }

  .input:hover:not(:disabled) {
    border-color: var(--loki-border-light);
  }

  .input:focus {
    outline: none;
    border-color: var(--loki-border-focus);
    box-shadow: var(--loki-shadow-focus);
  }

  .input:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Badge */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px var(--loki-space-sm);
    border-radius: var(--loki-radius-sm);
    font-size: var(--loki-text-xs);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .badge-success {
    background: var(--loki-success-muted);
    color: var(--loki-success);
  }

  .badge-warning {
    background: var(--loki-warning-muted);
    color: var(--loki-warning);
  }

  .badge-error {
    background: var(--loki-error-muted);
    color: var(--loki-error);
  }

  .badge-info {
    background: var(--loki-info-muted);
    color: var(--loki-info);
  }

  .badge-neutral {
    background: var(--loki-bg-tertiary);
    color: var(--loki-text-secondary);
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: var(--loki-space-xl);
    color: var(--loki-text-muted);
    font-size: var(--loki-text-base);
  }

  /* Loading spinner */
  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--loki-border);
    border-top-color: var(--loki-accent);
    border-radius: var(--loki-radius-full);
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  ::-webkit-scrollbar-track {
    background: var(--loki-bg-primary);
    border-radius: var(--loki-radius-sm);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--loki-border);
    border-radius: var(--loki-radius-sm);
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--loki-border-light);
  }

  /* Screen reader only */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Responsive utilities */
  @media (max-width: ${Z.md}) {
    .hide-mobile { display: none !important; }
  }

  @media (min-width: ${Z.md}) {
    .hide-desktop { display: none !important; }
  }
`,g=class g{static detectContext(){return typeof acquireVsCodeApi<"u"||document.body.classList.contains("vscode-body")||getComputedStyle(document.documentElement).getPropertyValue("--vscode-editor-background")?"vscode":document.documentElement.dataset.lokiContext==="cli"?"cli":"browser"}static detectVSCodeTheme(){let t=document.body;if(t.classList.contains("vscode-high-contrast"))return"high-contrast";if(t.classList.contains("vscode-dark"))return"dark";if(t.classList.contains("vscode-light"))return"light";let e=getComputedStyle(document.documentElement).getPropertyValue("--vscode-editor-background");if(e){let a=e.match(/\d+/g);if(a)return(parseInt(a[0])*299+parseInt(a[1])*587+parseInt(a[2])*114)/1e3>128?"light":"dark"}return null}static getTheme(){if(g.detectContext()==="vscode"){let a=g.detectVSCodeTheme();return a==="high-contrast"?"high-contrast":a==="dark"?"vscode-dark":"vscode-light"}let e=localStorage.getItem(g.STORAGE_KEY);return e&&b[e]?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}static setTheme(t){if(!b[t]){console.warn(`Unknown theme: ${t}`);return}localStorage.setItem(g.STORAGE_KEY,t),document.documentElement.setAttribute("data-loki-theme",t),window.dispatchEvent(new CustomEvent("loki-theme-change",{detail:{theme:t,context:g.detectContext()}}))}static toggle(){let t=g.getTheme(),e;return t.includes("dark")||t==="high-contrast"?e=t.startsWith("vscode")?"vscode-light":"light":e=t.startsWith("vscode")?"vscode-dark":"dark",g.setTheme(e),e}static getVariables(t=null){let e=t||g.getTheme();return b[e]||b.light}static generateCSS(t=null){let e=t||g.getTheme();return`
      :host {
        ${m(e)}
        ${M()}
      }
      ${H}
    `}static init(){let t=g.getTheme();document.documentElement.setAttribute("data-loki-theme",t),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{localStorage.getItem(g.STORAGE_KEY)||g.setTheme(g.getTheme())}),g.detectContext()==="vscode"&&new MutationObserver(()=>{let a=g.getTheme();document.documentElement.setAttribute("data-loki-theme",a),window.dispatchEvent(new CustomEvent("loki-theme-change",{detail:{theme:a,context:"vscode"}}))}).observe(document.body,{attributes:!0,attributeFilter:["class"]})}};f(g,"STORAGE_KEY","loki-theme"),f(g,"CONTEXT_KEY","loki-context");var h=g,I=class{constructor(){this._handlers=new Map,this._enabled=!0}register(t,e){let a=Q[t];if(!a){console.warn(`Unknown keyboard action: ${t}`);return}this._handlers.set(t,{shortcut:a,handler:e})}unregister(t){this._handlers.delete(t)}setEnabled(t){this._enabled=t}handleEvent(t){if(!this._enabled)return!1;for(let[e,{shortcut:a,handler:i}]of this._handlers)if(this._matchesShortcut(t,a))return t.preventDefault(),t.stopPropagation(),i(t),!0;return!1}_matchesShortcut(t,e){let a=t.key.toLowerCase(),i=e.modifiers||[];if(a!==e.key.toLowerCase())return!1;let s=i.includes("Ctrl")||i.includes("Meta"),r=i.includes("Shift"),o=i.includes("Alt"),l=(t.ctrlKey||t.metaKey)===s,p=t.shiftKey===r,y=t.altKey===o;return l&&p&&y}attach(t){this._boundHandler||(this._boundHandler=e=>this.handleEvent(e)),t.addEventListener("keydown",this._boundHandler)}detach(t){this._boundHandler&&t.removeEventListener("keydown",this._boundHandler)}};var et={light:{"--loki-bg-primary":"#fafafa","--loki-bg-secondary":"#f4f4f5","--loki-bg-tertiary":"#e4e4e7","--loki-bg-card":"#ffffff","--loki-bg-hover":"#f0f0f3","--loki-accent":"#7c3aed","--loki-accent-light":"#8b5cf6","--loki-accent-muted":"rgba(124, 58, 237, 0.12)","--loki-text-primary":"#18181b","--loki-text-secondary":"#52525b","--loki-text-muted":"#a1a1aa","--loki-border":"#e4e4e7","--loki-border-light":"#d4d4d8","--loki-green":"#16a34a","--loki-green-muted":"rgba(22, 163, 74, 0.12)","--loki-yellow":"#ca8a04","--loki-yellow-muted":"rgba(202, 138, 4, 0.12)","--loki-red":"#dc2626","--loki-red-muted":"rgba(220, 38, 38, 0.12)","--loki-blue":"#2563eb","--loki-blue-muted":"rgba(37, 99, 235, 0.12)","--loki-purple":"#9333ea","--loki-purple-muted":"rgba(147, 51, 234, 0.12)","--loki-opus":"#d97706","--loki-sonnet":"#4f46e5","--loki-haiku":"#059669","--loki-transition":"0.2s cubic-bezier(0.4, 0, 0.2, 1)"},dark:{"--loki-bg-primary":"#09090b","--loki-bg-secondary":"#0c0c0f","--loki-bg-tertiary":"#111114","--loki-bg-card":"#18181b","--loki-bg-hover":"#1f1f23","--loki-accent":"#8b5cf6","--loki-accent-light":"#a78bfa","--loki-accent-muted":"rgba(139, 92, 246, 0.15)","--loki-text-primary":"#fafafa","--loki-text-secondary":"#a1a1aa","--loki-text-muted":"#52525b","--loki-border":"rgba(255, 255, 255, 0.06)","--loki-border-light":"rgba(255, 255, 255, 0.1)","--loki-green":"#22c55e","--loki-green-muted":"rgba(34, 197, 94, 0.15)","--loki-yellow":"#eab308","--loki-yellow-muted":"rgba(234, 179, 8, 0.15)","--loki-red":"#ef4444","--loki-red-muted":"rgba(239, 68, 68, 0.15)","--loki-blue":"#3b82f6","--loki-blue-muted":"rgba(59, 130, 246, 0.15)","--loki-purple":"#a78bfa","--loki-purple-muted":"rgba(167, 139, 250, 0.15)","--loki-opus":"#f59e0b","--loki-sonnet":"#818cf8","--loki-haiku":"#34d399","--loki-transition":"0.2s cubic-bezier(0.4, 0, 0.2, 1)"}},ot=`
  :host {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    box-sizing: border-box;
  }

  :host *, :host *::before, :host *::after {
    box-sizing: border-box;
  }

  .mono {
    font-family: 'JetBrains Mono', monospace;
  }

  /* Button base styles */
  .btn {
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--loki-transition);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: none;
  }

  .btn-primary {
    background: var(--loki-accent);
    color: white;
  }

  .btn-primary:hover {
    background: var(--loki-accent-light);
  }

  .btn-secondary {
    background: var(--loki-bg-tertiary);
    color: var(--loki-text-primary);
    border: 1px solid var(--loki-border);
  }

  .btn-secondary:hover {
    background: var(--loki-bg-hover);
  }

  /* Status dot */
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .status-dot.active {
    background: var(--loki-green);
    animation: pulse 2s infinite;
  }
  .status-dot.idle { background: var(--loki-text-muted); }
  .status-dot.paused { background: var(--loki-yellow); }
  .status-dot.stopped { background: var(--loki-red); }
  .status-dot.error { background: var(--loki-red); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Card base */
  .card {
    background: var(--loki-bg-card);
    border: 1px solid var(--loki-border);
    border-radius: 10px;
    padding: 16px;
    transition: all var(--loki-transition);
  }

  .card:hover {
    border-color: var(--loki-border-light);
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 24px;
    color: var(--loki-text-muted);
    font-size: 12px;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--loki-bg-primary); }
  ::-webkit-scrollbar-thumb { background: var(--loki-border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--loki-border-light); }
`,C=class C{static getTheme(){return h.getTheme()}static setTheme(t){h.setTheme(t)}static toggle(){return h.toggle()}static getVariables(t=null){let e=t||C.getTheme();return b[e]||et[e]||et.light}static toCSSString(t=null){let e=t||C.getTheme();if(b[e])return m(e);let a=C.getVariables(e);return Object.entries(a).map(([i,s])=>`${i}: ${s};`).join(`
`)}static applyToElement(t,e=null){let a=C.getVariables(e);for(let[i,s]of Object.entries(a))t.style.setProperty(i,s)}static init(){h.init()}static detectContext(){return h.detectContext()}static getAvailableThemes(){return Object.keys(b)}};f(C,"STORAGE_KEY","loki-theme");var A=C,c=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._theme=A.getTheme(),this._themeChangeHandler=this._onThemeChange.bind(this),this._keyboardHandler=new I}connectedCallback(){window.addEventListener("loki-theme-change",this._themeChangeHandler),this._applyTheme(),this._setupKeyboardHandling(),this.render()}disconnectedCallback(){window.removeEventListener("loki-theme-change",this._themeChangeHandler),this._keyboardHandler.detach(this)}_onThemeChange(t){this._theme=t.detail.theme,this._applyTheme(),this.onThemeChange&&this.onThemeChange(this._theme)}_applyTheme(){A.applyToElement(this.shadowRoot.host,this._theme),this.setAttribute("data-loki-theme",this._theme)}_setupKeyboardHandling(){this._keyboardHandler.attach(this)}registerShortcut(t,e){this._keyboardHandler.register(t,e)}getBaseStyles(){return`
      /* Design tokens */
      :host {
        ${M()}
      }

      /* Light theme (default) */
      :host {
        ${m("light")}
      }

      /* Dark theme via system preference */
      @media (prefers-color-scheme: dark) {
        :host {
          ${m("dark")}
        }
      }

      /* Explicit theme attributes */
      :host([theme="dark"]),
      :host([data-loki-theme="dark"]) {
        ${m("dark")}
      }

      :host([theme="light"]),
      :host([data-loki-theme="light"]) {
        ${m("light")}
      }

      :host([theme="high-contrast"]),
      :host([data-loki-theme="high-contrast"]) {
        ${m("high-contrast")}
      }

      :host([theme="vscode-light"]),
      :host([data-loki-theme="vscode-light"]) {
        ${m("vscode-light")}
      }

      :host([theme="vscode-dark"]),
      :host([data-loki-theme="vscode-dark"]) {
        ${m("vscode-dark")}
      }

      /* Reduced motion preference */
      @media (prefers-reduced-motion: reduce) {
        :host *,
        :host *::before,
        :host *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      ${H}
    `}getAriaPattern(t){return tt[t]||{}}applyAriaPattern(t,e){let a=this.getAriaPattern(e);for(let[i,s]of Object.entries(a))if(i==="role")t.setAttribute("role",s);else{let r=i.replace(/([A-Z])/g,"-$1").toLowerCase();t.setAttribute(r,s)}}render(){}};var E={realtime:1e3,normal:2e3,background:5e3,offline:1e4},nt={vscode:E.normal,browser:E.realtime,cli:E.background},lt={baseUrl:typeof window<"u"?window.location.origin:"http://localhost:57374",wsUrl:typeof window<"u"?`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`:"ws://localhost:57374/ws",pollInterval:2e3,timeout:1e4,retryAttempts:3,retryDelay:1e3},n={CONNECTED:"api:connected",DISCONNECTED:"api:disconnected",ERROR:"api:error",STATUS_UPDATE:"api:status-update",TASK_CREATED:"api:task-created",TASK_UPDATED:"api:task-updated",TASK_DELETED:"api:task-deleted",PROJECT_CREATED:"api:project-created",PROJECT_UPDATED:"api:project-updated",AGENT_UPDATE:"api:agent-update",LOG_MESSAGE:"api:log-message",MEMORY_UPDATE:"api:memory-update",CHECKLIST_UPDATE:"api:checklist-update"},x=class x extends EventTarget{static getInstance(t={}){let e=t.baseUrl||lt.baseUrl;return x._instances.has(e)||x._instances.set(e,new x(t)),x._instances.get(e)}static clearInstances(){x._instances.forEach(t=>t.disconnect()),x._instances.clear()}constructor(t={}){super(),this.config={...lt,...t},this._ws=null,this._connected=!1,this._pollInterval=null,this._reconnectTimeout=null,this._cache=new Map,this._cacheTimeout=5e3,this._vscodeApi=null,this._context=this._detectContext(),this._currentPollInterval=nt[this._context]||E.normal,this._visibilityChangeHandler=null,this._messageHandler=null,this._setupAdaptivePolling(),this._setupVSCodeBridge()}_detectContext(){return typeof acquireVsCodeApi<"u"?"vscode":typeof window<"u"&&window.location?"browser":"cli"}get context(){return this._context}static get POLL_INTERVALS(){return E}_setupAdaptivePolling(){typeof document>"u"||(this._visibilityChangeHandler=()=>{document.hidden?this._setPollInterval(E.background):this._setPollInterval(nt[this._context]||E.normal)},document.addEventListener("visibilitychange",this._visibilityChangeHandler))}_setPollInterval(t){this._currentPollInterval=t,this._pollInterval&&(this.stopPolling(),this.startPolling(null,t))}setPollMode(t){let e=E[t];e&&this._setPollInterval(e)}_setupVSCodeBridge(){if(!(typeof acquireVsCodeApi>"u")){try{this._vscodeApi=acquireVsCodeApi()}catch{console.warn("VS Code API already acquired or unavailable");return}this._messageHandler=t=>{let e=t.data;if(!(!e||!e.type))switch(e.type){case"updateStatus":this._emit(n.STATUS_UPDATE,e.data);break;case"updateTasks":this._emit(n.TASK_UPDATED,e.data);break;case"taskCreated":this._emit(n.TASK_CREATED,e.data);break;case"taskDeleted":this._emit(n.TASK_DELETED,e.data);break;case"projectCreated":this._emit(n.PROJECT_CREATED,e.data);break;case"projectUpdated":this._emit(n.PROJECT_UPDATED,e.data);break;case"agentUpdate":this._emit(n.AGENT_UPDATE,e.data);break;case"logMessage":this._emit(n.LOG_MESSAGE,e.data);break;case"memoryUpdate":this._emit(n.MEMORY_UPDATE,e.data);break;case"connected":this._connected=!0,this._emit(n.CONNECTED,e.data);break;case"disconnected":this._connected=!1,this._emit(n.DISCONNECTED,e.data);break;case"error":this._emit(n.ERROR,e.data);break;case"setPollMode":this.setPollMode(e.data.mode);break;default:this._emit(`api:${e.type}`,e.data)}},window.addEventListener("message",this._messageHandler)}}get isVSCode(){return this._context==="vscode"}postToVSCode(t,e={}){this._vscodeApi&&this._vscodeApi.postMessage({type:t,data:e})}requestRefresh(){this.postToVSCode("requestRefresh")}notifyVSCode(t,e={}){this.postToVSCode("userAction",{action:t,...e})}get baseUrl(){return this.config.baseUrl}set baseUrl(t){this.config.baseUrl=t,this.config.wsUrl=t.replace(/^http/,"ws")+"/ws"}get isConnected(){return this._connected}async connect(){if(!(this._ws&&this._ws.readyState===WebSocket.OPEN))return new Promise((t,e)=>{try{this._ws=new WebSocket(this.config.wsUrl),this._ws.onopen=()=>{this._connected=!0,this._emit(n.CONNECTED),t()},this._ws.onclose=()=>{this._connected=!1,this._emit(n.DISCONNECTED),this._scheduleReconnect()},this._ws.onerror=a=>{this._emit(n.ERROR,{error:a}),e(a)},this._ws.onmessage=a=>{try{let i=JSON.parse(a.data);this._handleMessage(i)}catch(i){console.error("Failed to parse WebSocket message:",i)}}}catch(a){e(a)}})}disconnect(){this._ws&&(this._ws.close(),this._ws=null),this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null),this._reconnectTimeout&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null),this._connected=!1,this._cleanupGlobalListeners()}_cleanupGlobalListeners(){this._visibilityChangeHandler&&typeof document<"u"&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler),this._visibilityChangeHandler=null),this._messageHandler&&typeof window<"u"&&(window.removeEventListener("message",this._messageHandler),this._messageHandler=null)}destroy(){this.disconnect()}_scheduleReconnect(){this._reconnectTimeout||(this._reconnectTimeout=setTimeout(()=>{this._reconnectTimeout=null,this.connect().catch(()=>{})},this.config.retryDelay))}_handleMessage(t){let a={connected:n.CONNECTED,status_update:n.STATUS_UPDATE,task_created:n.TASK_CREATED,task_updated:n.TASK_UPDATED,task_deleted:n.TASK_DELETED,task_moved:n.TASK_UPDATED,project_created:n.PROJECT_CREATED,project_updated:n.PROJECT_UPDATED,agent_update:n.AGENT_UPDATE,log:n.LOG_MESSAGE}[t.type]||`api:${t.type}`;this._emit(a,t.data)}_emit(t,e={}){this.dispatchEvent(new CustomEvent(t,{detail:e}))}async _request(t,e={}){let a=`${this.config.baseUrl}${t}`,i=new AbortController,s=setTimeout(()=>i.abort(),this.config.timeout);try{let r=await fetch(a,{...e,signal:i.signal,headers:{"Content-Type":"application/json",...e.headers}});if(clearTimeout(s),!r.ok){let o=await r.json().catch(()=>({detail:r.statusText}));throw new Error(o.detail||`HTTP ${r.status}`)}return r.status===204?null:await r.json()}catch(r){throw clearTimeout(s),r.name==="AbortError"?new Error("Request timeout"):r}}async _get(t,e=!1){if(e&&this._cache.has(t)){let i=this._cache.get(t);if(Date.now()-i.timestamp<this._cacheTimeout)return i.data}let a=await this._request(t);return e&&this._cache.set(t,{data:a,timestamp:Date.now()}),a}async _post(t,e){return this._request(t,{method:"POST",body:JSON.stringify(e)})}async _put(t,e){return this._request(t,{method:"PUT",body:JSON.stringify(e)})}async _delete(t){return this._request(t,{method:"DELETE"})}async getStatus(){return this._get("/api/status")}async healthCheck(){return this._get("/health")}async listProjects(t=null){let e=t?`?status=${t}`:"";return this._get(`/api/projects${e}`)}async getProject(t){return this._get(`/api/projects/${t}`)}async createProject(t){return this._post("/api/projects",t)}async updateProject(t,e){return this._put(`/api/projects/${t}`,e)}async deleteProject(t){return this._delete(`/api/projects/${t}`)}async listTasks(t={}){let e=new URLSearchParams;t.projectId&&e.append("project_id",t.projectId),t.status&&e.append("status",t.status),t.priority&&e.append("priority",t.priority);let a=e.toString()?`?${e}`:"";return this._get(`/api/tasks${a}`)}async getTask(t){return this._get(`/api/tasks/${t}`)}async createTask(t){return this._post("/api/tasks",t)}async updateTask(t,e){return this._put(`/api/tasks/${t}`,e)}async moveTask(t,e,a){return this._post(`/api/tasks/${t}/move`,{status:e,position:a})}async deleteTask(t){return this._delete(`/api/tasks/${t}`)}async getMemorySummary(){return this._get("/api/memory/summary",!0)}async getMemoryIndex(){return this._get("/api/memory/index",!0)}async getMemoryTimeline(){return this._get("/api/memory/timeline")}async listEpisodes(t={}){let e=new URLSearchParams(t).toString();return this._get(`/api/memory/episodes${e?"?"+e:""}`)}async getEpisode(t){return this._get(`/api/memory/episodes/${t}`)}async listPatterns(t={}){let e=new URLSearchParams(t).toString();return this._get(`/api/memory/patterns${e?"?"+e:""}`)}async getPattern(t){return this._get(`/api/memory/patterns/${t}`)}async listSkills(){return this._get("/api/memory/skills")}async getSkill(t){return this._get(`/api/memory/skills/${t}`)}async retrieveMemories(t,e=null,a=5){return this._post("/api/memory/retrieve",{query:t,taskType:e,topK:a})}async consolidateMemory(t=24){return this._post("/api/memory/consolidate",{sinceHours:t})}async getTokenEconomics(){return this._get("/api/memory/economics")}async listRegisteredProjects(t=!1){return this._get(`/api/registry/projects?include_inactive=${t}`)}async registerProject(t,e=null,a=null){return this._post("/api/registry/projects",{path:t,name:e,alias:a})}async discoverProjects(t=3){return this._get(`/api/registry/discover?max_depth=${t}`)}async syncRegistry(){return this._post("/api/registry/sync",{})}async getCrossProjectTasks(t=null){let e=t?`?project_ids=${t.join(",")}`:"";return this._get(`/api/registry/tasks${e}`)}async getLearningMetrics(t={}){let e=new URLSearchParams;t.timeRange&&e.append("timeRange",t.timeRange),t.signalType&&e.append("signalType",t.signalType),t.source&&e.append("source",t.source);let a=e.toString()?`?${e}`:"";return this._get(`/api/learning/metrics${a}`)}async getLearningTrends(t={}){let e=new URLSearchParams;t.timeRange&&e.append("timeRange",t.timeRange),t.signalType&&e.append("signalType",t.signalType),t.source&&e.append("source",t.source);let a=e.toString()?`?${e}`:"";return this._get(`/api/learning/trends${a}`)}async getLearningSignals(t={}){let e=new URLSearchParams;t.timeRange&&e.append("timeRange",t.timeRange),t.signalType&&e.append("signalType",t.signalType),t.source&&e.append("source",t.source),t.limit&&e.append("limit",String(t.limit)),t.offset&&e.append("offset",String(t.offset));let a=e.toString()?`?${e}`:"";return this._get(`/api/learning/signals${a}`)}async getLatestAggregation(){return this._get("/api/learning/aggregation")}async triggerAggregation(t={}){return this._post("/api/learning/aggregate",t)}async getAggregatedPreferences(t=20){return this._get(`/api/learning/preferences?limit=${t}`)}async getAggregatedErrors(t=20){return this._get(`/api/learning/errors?limit=${t}`)}async getAggregatedSuccessPatterns(t=20){return this._get(`/api/learning/success?limit=${t}`)}async getToolEfficiency(t=20){return this._get(`/api/learning/tools?limit=${t}`)}async getCost(){return this._get("/api/cost")}async getPricing(){return this._get("/api/pricing")}async getCouncilState(){return this._get("/api/council/state")}async getCouncilVerdicts(t=20){return this._get(`/api/council/verdicts?limit=${t}`)}async getCouncilConvergence(){return this._get("/api/council/convergence")}async getCouncilReport(){return this._get("/api/council/report")}async forceCouncilReview(){return this._post("/api/council/force-review",{})}async getContext(){return this._get("/api/context")}async getNotifications(t,e){let a=new URLSearchParams;t&&a.set("severity",t),e&&a.set("unread_only","true");let i=a.toString();return this._get("/api/notifications"+(i?"?"+i:""))}async getNotificationTriggers(){return this._get("/api/notifications/triggers")}async updateNotificationTriggers(t){return this._put("/api/notifications/triggers",{triggers:t})}async acknowledgeNotification(t){return this._post("/api/notifications/"+encodeURIComponent(t)+"/acknowledge",{})}async pauseSession(){return this._post("/api/control/pause",{})}async resumeSession(){return this._post("/api/control/resume",{})}async stopSession(){return this._post("/api/control/stop",{})}async getLogs(t=100){return this._get(`/api/logs?lines=${t}`)}async getChecklist(){return this._get("/api/checklist")}async getChecklistSummary(){return this._get("/api/checklist/summary")}async getPrdObservations(){let t=await fetch(`${this.baseUrl}/api/prd-observations`);if(!t.ok)throw new Error(`HTTP ${t.status}`);return t.text()}async getChecklistWaivers(){return this._get("/api/checklist/waivers")}async addChecklistWaiver(t,e,a="dashboard"){return this._post("/api/checklist/waivers",{item_id:t,reason:e,waived_by:a})}async removeChecklistWaiver(t){return this._delete(`/api/checklist/waivers/${encodeURIComponent(t)}`)}async getCouncilGate(){return this._get("/api/council/gate")}async getAppRunnerStatus(){return this._get("/api/app-runner/status")}async getAppRunnerLogs(t=100){return this._get(`/api/app-runner/logs?lines=${t}`)}async restartApp(){return this._post("/api/control/app-restart")}async stopApp(){return this._post("/api/control/app-stop")}async getPlaywrightResults(){return this._get("/api/playwright/results")}async getPlaywrightScreenshot(){return this._get("/api/playwright/screenshot")}startPolling(t,e=null){if(this._pollInterval)return;this._pollCallback=t;let a=async()=>{try{let s=await this.getStatus();this._connected=!0,this._pollCallback&&this._pollCallback(s),this._emit(n.STATUS_UPDATE,s),this._vscodeApi&&this.postToVSCode("pollSuccess",{timestamp:Date.now()})}catch(s){this._connected=!1,this._emit(n.ERROR,{error:s}),this._vscodeApi&&this.postToVSCode("pollError",{error:s.message})}};a();let i=e||this._currentPollInterval||this.config.pollInterval;this._pollInterval=setInterval(a,i)}stopPolling(){this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null)}};f(x,"_instances",new Map);var D=x;function dt(d={}){return new D(d)}function u(d={}){return D.getInstance(d)}var it="loki-state-change",at={ui:{theme:"light",sidebarCollapsed:!1,activeSection:"kanban",terminalAutoScroll:!0},session:{connected:!1,lastSync:null,mode:"offline",phase:null,iteration:null},localTasks:[],cache:{projects:[],tasks:[],agents:[],memory:null,lastFetch:null},preferences:{pollInterval:2e3,notifications:!0,soundEnabled:!1}},k=class k extends EventTarget{static getInstance(){return k._instance||(k._instance=new k),k._instance}constructor(){super(),this._state=this._loadState(),this._subscribers=new Map,this._batchUpdates=[],this._batchTimeout=null}_loadState(){try{let t=localStorage.getItem(k.STORAGE_KEY);if(t){let e=JSON.parse(t);return this._mergeState(at,e)}}catch(t){console.warn("Failed to load state from localStorage:",t)}return{...at}}_mergeState(t,e){let a={...t};for(let i of Object.keys(e))i in t&&typeof t[i]=="object"&&!Array.isArray(t[i])?a[i]=this._mergeState(t[i],e[i]):a[i]=e[i];return a}_saveState(){try{let t={ui:this._state.ui,localTasks:this._state.localTasks,preferences:this._state.preferences};localStorage.setItem(k.STORAGE_KEY,JSON.stringify(t))}catch(t){console.warn("Failed to save state to localStorage:",t)}}get(t=null){if(!t)return{...this._state};let e=t.split("."),a=this._state;for(let i of e){if(a==null)return;a=a[i]}return a}set(t,e,a=!0){let i=t.split("."),s=i.pop(),r=this._state;for(let l of i)l in r||(r[l]={}),r=r[l];let o=r[s];r[s]=e,a&&this._saveState(),this._notifyChange(t,e,o)}update(t,e=!0){let a=[];for(let[i,s]of Object.entries(t)){let r=this.get(i);this.set(i,s,!1),a.push({path:i,value:s,oldValue:r})}e&&this._saveState();for(let i of a)this._notifyChange(i.path,i.value,i.oldValue)}_notifyChange(t,e,a){this.dispatchEvent(new CustomEvent(it,{detail:{path:t,value:e,oldValue:a}}));let i=this._subscribers.get(t)||[];for(let r of i)try{r(e,a,t)}catch(o){console.error("State subscriber error:",o)}let s=t.split(".");for(;s.length>1;){s.pop();let r=s.join("."),o=this._subscribers.get(r)||[];for(let l of o)try{l(this.get(r),null,r)}catch(p){console.error("State subscriber error:",p)}}}subscribe(t,e){return this._subscribers.has(t)||this._subscribers.set(t,[]),this._subscribers.get(t).push(e),()=>{let a=this._subscribers.get(t),i=a.indexOf(e);i>-1&&a.splice(i,1)}}reset(t=null){if(t){let e=t.split("."),a=at;for(let i of e)a=a?.[i];this.set(t,a)}else this._state={...at},this._saveState(),this.dispatchEvent(new CustomEvent(it,{detail:{path:null,value:this._state,oldValue:null}}))}addLocalTask(t){let e=this.get("localTasks")||[],a={id:`local-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,createdAt:new Date().toISOString(),status:"pending",...t};return this.set("localTasks",[...e,a]),a}updateLocalTask(t,e){let a=this.get("localTasks")||[],i=a.findIndex(r=>r.id===t);if(i===-1)return null;let s={...a[i],...e,updatedAt:new Date().toISOString()};return a[i]=s,this.set("localTasks",[...a]),s}deleteLocalTask(t){let e=this.get("localTasks")||[];this.set("localTasks",e.filter(a=>a.id!==t))}moveLocalTask(t,e,a=null){let s=(this.get("localTasks")||[]).find(r=>r.id===t);return s?this.updateLocalTask(t,{status:e,position:a??s.position}):null}updateSession(t){this.update(Object.fromEntries(Object.entries(t).map(([e,a])=>[`session.${e}`,a])),!1)}updateCache(t){this.update({"cache.projects":t.projects??this.get("cache.projects"),"cache.tasks":t.tasks??this.get("cache.tasks"),"cache.agents":t.agents??this.get("cache.agents"),"cache.memory":t.memory??this.get("cache.memory"),"cache.lastFetch":new Date().toISOString()},!1)}getMergedTasks(){let t=this.get("cache.tasks")||[],a=(this.get("localTasks")||[]).map(i=>({...i,isLocal:!0}));return[...t,...a]}getTasksByStatus(t){return this.getMergedTasks().filter(e=>e.status===t)}};f(k,"STORAGE_KEY","loki-dashboard-state"),f(k,"_instance",null);var z=k;function L(){return z.getInstance()}function ct(d){let t=L();return{get:()=>t.get(d),set:e=>t.set(d,e),subscribe:e=>t.subscribe(d,e)}}var B=class extends c{static get observedAttributes(){return["api-url","theme"]}constructor(){super(),this._data={status:"offline",phase:null,iteration:null,provider:null,running_agents:0,pending_tasks:null,uptime_seconds:0,complexity:null,connected:!1},this._api=null,this._pollInterval=null,this._statusUpdateHandler=null,this._connectedHandler=null,this._disconnectedHandler=null,this._checklistSummary=null,this._appRunnerStatus=null,this._playwrightResults=null,this._gateStatus=null}connectedCallback(){super.connectedCallback(),this._setupApi(),this._loadStatus(),this._startPolling()}disconnectedCallback(){super.disconnectedCallback(),this._stopPolling(),this._api&&(this._statusUpdateHandler&&this._api.removeEventListener(n.STATUS_UPDATE,this._statusUpdateHandler),this._connectedHandler&&this._api.removeEventListener(n.CONNECTED,this._connectedHandler),this._disconnectedHandler&&this._api.removeEventListener(n.DISCONNECTED,this._disconnectedHandler))}attributeChangedCallback(t,e,a){e!==a&&(t==="api-url"&&this._api&&(this._api.baseUrl=a,this._loadStatus()),t==="theme"&&this._applyTheme())}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t}),this._statusUpdateHandler=e=>this._updateFromStatus(e.detail),this._connectedHandler=()=>{this._data.connected=!0,this.render()},this._disconnectedHandler=()=>{this._data.connected=!1,this._data.status="offline",this.render()},this._api.addEventListener(n.STATUS_UPDATE,this._statusUpdateHandler),this._api.addEventListener(n.CONNECTED,this._connectedHandler),this._api.addEventListener(n.DISCONNECTED,this._disconnectedHandler)}async _loadStatus(){try{let[t,e,a,i,s]=await Promise.allSettled([this._api.getStatus(),this._api.getChecklistSummary(),this._api.getAppRunnerStatus(),this._api.getPlaywrightResults(),this._api.getCouncilGate()]);t.status==="fulfilled"?this._updateFromStatus(t.value):(this._data.connected=!1,this._data.status="offline"),e.status==="fulfilled"&&(this._checklistSummary=e.value?.summary||null),a.status==="fulfilled"&&(this._appRunnerStatus=a.value),i.status==="fulfilled"&&(this._playwrightResults=i.value),s.status==="fulfilled"&&(this._gateStatus=s.value),this.render()}catch{this._data.connected=!1,this._data.status="offline",this.render()}}_updateFromStatus(t){t&&(this._data={...this._data,connected:!0,status:t.status||"offline",phase:t.phase||null,iteration:t.iteration!=null?t.iteration:null,provider:t.provider||null,running_agents:t.running_agents||0,pending_tasks:t.pending_tasks!=null?t.pending_tasks:null,uptime_seconds:t.uptime_seconds||0,complexity:t.complexity||null},this.render())}_startPolling(){this._pollInterval=setInterval(async()=>{try{let t=await this._api.getStatus();this._updateFromStatus(t)}catch{this._data.connected=!1,this._data.status="offline",this.render()}},5e3)}_stopPolling(){this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null)}_formatUptime(t){if(!t||t<0)return"--";let e=Math.floor(t/3600),a=Math.floor(t%3600/60),i=Math.floor(t%60);return e>0?`${e}h ${a}m`:a>0?`${a}m ${i}s`:`${i}s`}_getStatusDotClass(){switch(this._data.status){case"running":case"autonomous":return"active";case"paused":return"paused";case"stopped":return"stopped";case"error":return"error";default:return"offline"}}_escapeHtml(t){return t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}_renderAppRunnerCard(){let t=this._appRunnerStatus;if(!t||t.status==="not_initialized")return`
        <div class="overview-card">
          <div class="card-label">App Runner</div>
          <div class="card-value small-text">--</div>
        </div>
      `;let a={running:"var(--loki-green, #22c55e)",starting:"var(--loki-yellow, #f59e0b)",crashed:"var(--loki-red, #ef4444)",stopped:"var(--loki-text-muted, #a1a1aa)"}[t.status]||"var(--loki-text-muted)",i=t.status==="running"?"active":t.status==="crashed"?"error":"offline",s=(t.status||"unknown").toUpperCase(),r=t.port?`:${t.port}`:"";return`
      <div class="overview-card">
        <div class="card-label">App Runner</div>
        <div class="card-value small-text">
          <span class="status-dot ${i}"></span>
          ${s}${r}
        </div>
        ${t.method?`<div style="font-size:10px;color:var(--loki-text-muted);margin-top:2px;">${this._escapeHtml(t.method)}</div>`:""}
      </div>
    `}_renderPlaywrightCard(){let t=this._playwrightResults;if(!t||t==="null"||!t.verified_at)return`
        <div class="overview-card">
          <div class="card-label">Verification</div>
          <div class="card-value small-text">--</div>
        </div>
      `;let e=t.passed===!0,a=e?"var(--loki-green, #22c55e)":"var(--loki-red, #ef4444)",i=e?"PASSED":"FAILED",s=e?"active":"error",r=t.checks||{},o=Object.values(r).filter(l=>!l).length;return`
      <div class="overview-card">
        <div class="card-label">Verification</div>
        <div class="card-value small-text">
          <span class="status-dot ${s}"></span>
          ${i}
        </div>
        ${!e&&o>0?`<div style="font-size:10px;color:var(--loki-red,#ef4444);margin-top:2px;">${o} check(s) failed</div>`:""}
      </div>
    `}_renderChecklistCard(){let t=this._checklistSummary;if(!t||!t.total)return`
        <div class="overview-card">
          <div class="card-label">PRD Progress</div>
          <div class="card-value small-text">--</div>
        </div>
      `;let e=Math.round(t.verified/t.total*100),a=t.failing>0?"var(--loki-yellow, #f59e0b)":"var(--loki-green, #22c55e)";return`
      <div class="overview-card">
        <div class="card-label">PRD Progress</div>
        <div class="card-value small-text">${t.verified}/${t.total} (${e}%)</div>
        <div class="mini-progress" style="margin-top:4px;height:4px;background:var(--loki-bg-secondary,#e4e4e7);border-radius:2px;overflow:hidden;">
          <div style="width:${e}%;height:100%;background:${a};transition:width 0.3s;"></div>
        </div>
        ${t.failing?`<div style="font-size:10px;color:var(--loki-red,#ef4444);margin-top:2px;">${t.failing} failing</div>`:""}
      </div>
    `}_renderCouncilGateCard(){let t=this._gateStatus;if(!t||!t.status)return`
        <div class="overview-card">
          <div class="card-label">Council Gate</div>
          <div class="card-value small-text">
            <span class="status-dot offline"></span>
            N/A
          </div>
        </div>
      `;if(t.status==="blocked"){let e=t.critical_failures||0;return`
        <div class="overview-card">
          <div class="card-label">Council Gate</div>
          <div class="card-value small-text">
            <span class="status-dot error"></span>
            BLOCKED
          </div>
          ${e>0?`<div style="font-size:10px;color:var(--loki-red,#ef4444);margin-top:2px;">${e} critical failure${e!==1?"s":""}</div>`:""}
        </div>
      `}return`
      <div class="overview-card">
        <div class="card-label">Council Gate</div>
        <div class="card-value small-text">
          <span class="status-dot active"></span>
          PASSED
        </div>
      </div>
    `}render(){let t=this._getStatusDotClass(),e=(this._data.status||"OFFLINE").toUpperCase(),a=this._data.phase||"--",i=this._data.iteration!=null?String(this._data.iteration):"0",s=(this._data.provider||"CLAUDE").toUpperCase(),r=String(this._data.running_agents||0),o=this._data.pending_tasks!=null?`${this._data.pending_tasks} pending`:"--",l=this._formatUptime(this._data.uptime_seconds),p=(this._data.complexity||"STANDARD").toUpperCase();this.shadowRoot.innerHTML=`
      <style>
        ${this.getBaseStyles()}

        :host {
          display: block;
        }

        .overview-container {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          padding: 16px;
          transition: all var(--loki-transition);
        }

        .overview-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 14px;
        }

        .overview-header svg {
          width: 16px;
          height: 16px;
          color: var(--loki-text-muted);
          flex-shrink: 0;
        }

        .overview-title {
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-text-muted);
        }

        .overview-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
          gap: 10px;
        }

        .overview-card {
          background: var(--loki-bg-tertiary);
          border-radius: 8px;
          padding: 12px 14px;
          transition: background var(--loki-transition);
        }

        .overview-card:hover {
          background: var(--loki-bg-hover);
        }

        .card-label {
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-text-muted);
          margin-bottom: 6px;
        }

        .card-value {
          font-size: 18px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-primary);
          display: flex;
          align-items: center;
          gap: 8px;
          line-height: 1.2;
        }

        .card-value.small-text {
          font-size: 14px;
        }

        .status-dot {
          width: 10px;
          height: 10px;
          border-radius: 50%;
          flex-shrink: 0;
        }

        .status-dot.active {
          background: var(--loki-green);
          animation: pulse 2s infinite;
        }

        .status-dot.paused {
          background: var(--loki-yellow);
        }

        .status-dot.stopped {
          background: var(--loki-red);
        }

        .status-dot.error {
          background: var(--loki-red);
        }

        .status-dot.offline {
          background: var(--loki-text-muted);
        }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      </style>

      <div class="overview-container">
        <div class="overview-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <span class="overview-title">Overview</span>
        </div>

        <div class="overview-grid">
          <div class="overview-card">
            <div class="card-label">Session</div>
            <div class="card-value">
              <span class="status-dot ${t}"></span>
              ${e}
            </div>
          </div>

          <div class="overview-card">
            <div class="card-label">Phase</div>
            <div class="card-value small-text">${a}</div>
          </div>

          <div class="overview-card">
            <div class="card-label">Iteration</div>
            <div class="card-value">${i}</div>
          </div>

          <div class="overview-card">
            <div class="card-label">Provider</div>
            <div class="card-value small-text">${s}</div>
          </div>

          <div class="overview-card">
            <div class="card-label">Agents</div>
            <div class="card-value">${r}</div>
          </div>

          <div class="overview-card">
            <div class="card-label">Tasks</div>
            <div class="card-value small-text">${o}</div>
          </div>

          ${this._renderChecklistCard()}

          ${this._renderAppRunnerCard()}

          ${this._renderPlaywrightCard()}

          ${this._renderCouncilGateCard()}

          <div class="overview-card">
            <div class="card-label">Uptime</div>
            <div class="card-value small-text">${l}</div>
          </div>

          <div class="overview-card">
            <div class="card-label">Complexity</div>
            <div class="card-value small-text">${p}</div>
          </div>
        </div>
      </div>
    `}};customElements.get("loki-overview")||customElements.define("loki-overview",B);var xt=[{id:"pending",label:"Pending",status:"pending",color:"var(--loki-text-muted)"},{id:"in_progress",label:"In Progress",status:"in_progress",color:"var(--loki-blue)"},{id:"review",label:"In Review",status:"review",color:"var(--loki-purple)"},{id:"done",label:"Completed",status:"done",color:"var(--loki-green)"}];var U=class extends c{static get observedAttributes(){return["api-url","project-id","theme","readonly"]}constructor(){super(),this._tasks=[],this._loading=!0,this._error=null,this._draggedTask=null,this._api=null,this._state=L()}connectedCallback(){super.connectedCallback(),this._setupApi(),this._loadTasks()}disconnectedCallback(){super.disconnectedCallback(),this._api&&(this._api.removeEventListener(n.TASK_CREATED,this._onTaskEvent),this._api.removeEventListener(n.TASK_UPDATED,this._onTaskEvent),this._api.removeEventListener(n.TASK_DELETED,this._onTaskEvent))}attributeChangedCallback(t,e,a){e!==a&&(t==="api-url"&&this._api&&(this._api.baseUrl=a,this._loadTasks()),t==="project-id"&&this._loadTasks(),t==="theme"&&this._applyTheme())}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t}),this._onTaskEvent&&(this._api.removeEventListener(n.TASK_CREATED,this._onTaskEvent),this._api.removeEventListener(n.TASK_UPDATED,this._onTaskEvent),this._api.removeEventListener(n.TASK_DELETED,this._onTaskEvent)),this._onTaskEvent=()=>this._loadTasks(),this._api.addEventListener(n.TASK_CREATED,this._onTaskEvent),this._api.addEventListener(n.TASK_UPDATED,this._onTaskEvent),this._api.addEventListener(n.TASK_DELETED,this._onTaskEvent)}async _loadTasks(){this._loading=!0,this._error=null,this.render();try{let t=this.getAttribute("project-id"),e=t?{projectId:parseInt(t)}:{};this._tasks=await this._api.listTasks(e);let a=this._state.get("localTasks")||[];a.length>0&&(this._tasks=[...this._tasks,...a.map(i=>({...i,isLocal:!0}))]),this._state.update({"cache.tasks":this._tasks},!1)}catch(t){this._error=t.message,this._tasks=(this._state.get("localTasks")||[]).map(e=>({...e,isLocal:!0}))}this._loading=!1,this.render()}_getTasksByStatus(t){return this._tasks.filter(e=>e.status?.toLowerCase().replace(/-/g,"_")===t)}_handleDragStart(t,e){this.hasAttribute("readonly")||(this._draggedTask=e,t.target.classList.add("dragging"),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",e.id.toString()))}_handleDragEnd(t){t.target.classList.remove("dragging"),this._draggedTask=null,this.shadowRoot.querySelectorAll(".kanban-tasks").forEach(e=>{e.classList.remove("drag-over")})}_handleDragOver(t){t.preventDefault(),t.dataTransfer.dropEffect="move"}_handleDragEnter(t){t.preventDefault(),t.currentTarget.classList.add("drag-over")}_handleDragLeave(t){t.currentTarget.contains(t.relatedTarget)||t.currentTarget.classList.remove("drag-over")}async _handleDrop(t,e){if(t.preventDefault(),t.currentTarget.classList.remove("drag-over"),!this._draggedTask||this.hasAttribute("readonly"))return;let a=this._draggedTask.id,i=this._tasks.find(r=>r.id===a);if(!i)return;let s=i.status;if(s!==e){i.status=e,this.render();try{i.isLocal?this._state.moveLocalTask(a,e):await this._api.moveTask(a,e,0),this.dispatchEvent(new CustomEvent("task-moved",{detail:{taskId:a,oldStatus:s,newStatus:e}}))}catch(r){i.status=s,this.render(),console.error("Failed to move task:",r)}}}_openAddTaskModal(t="pending"){this.dispatchEvent(new CustomEvent("add-task",{detail:{status:t}}))}_openTaskDetail(t){this.dispatchEvent(new CustomEvent("task-click",{detail:{task:t}}))}render(){let t=`
      <style>
        ${this.getBaseStyles()}

        :host {
          display: block;
        }

        .board-container {
          width: 100%;
        }

        .board-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }

        .board-title {
          font-size: 16px;
          font-weight: 600;
          color: var(--loki-text-primary);
        }

        .board-actions {
          display: flex;
          gap: 8px;
        }

        .loading, .error {
          padding: 40px;
          text-align: center;
          color: var(--loki-text-muted);
        }

        .error {
          color: var(--loki-red);
        }

        .kanban-board {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 12px;
          min-height: 350px;
        }

        @media (max-width: 1200px) {
          .kanban-board { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
          .kanban-board { grid-template-columns: 1fr; }
        }

        .kanban-column {
          background: var(--loki-bg-secondary);
          border-radius: 10px;
          padding: 12px;
          display: flex;
          flex-direction: column;
          transition: background var(--loki-transition);
        }

        .kanban-column-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
          padding-bottom: 10px;
          border-bottom: 2px solid var(--loki-border);
        }

        .kanban-column[data-status="pending"] .kanban-column-header { border-color: var(--loki-text-muted); }
        .kanban-column[data-status="in_progress"] .kanban-column-header { border-color: var(--loki-blue); }
        .kanban-column[data-status="review"] .kanban-column-header { border-color: var(--loki-purple); }
        .kanban-column[data-status="done"] .kanban-column-header { border-color: var(--loki-green); }

        .kanban-column-title {
          font-size: 13px;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 6px;
          color: var(--loki-text-primary);
        }

        .kanban-column-count {
          background: var(--loki-bg-tertiary);
          padding: 2px 8px;
          border-radius: 10px;
          font-size: 11px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-secondary);
        }

        .kanban-tasks {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 8px;
          min-height: 80px;
          transition: background var(--loki-transition);
          border-radius: 6px;
          padding: 4px;
        }

        .kanban-tasks.drag-over {
          background: var(--loki-bg-hover);
        }

        .task-card {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 6px;
          padding: 10px;
          cursor: pointer;
          transition: all var(--loki-transition);
        }

        .task-card:hover {
          border-color: var(--loki-border-light);
          transform: translateY(-1px);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .task-card.draggable {
          cursor: grab;
        }

        .task-card.dragging {
          opacity: 0.5;
          cursor: grabbing;
        }

        .task-card.local {
          border-left: 3px solid var(--loki-accent);
        }

        .task-card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 6px;
        }

        .task-id {
          font-size: 11px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-accent);
        }

        .task-priority {
          font-size: 9px;
          padding: 2px 5px;
          border-radius: 3px;
          font-weight: 500;
          text-transform: uppercase;
        }

        .task-priority.high, .task-priority.critical {
          background: var(--loki-red-muted);
          color: var(--loki-red);
        }

        .task-priority.medium {
          background: var(--loki-yellow-muted);
          color: var(--loki-yellow);
        }

        .task-priority.low {
          background: var(--loki-green-muted);
          color: var(--loki-green);
        }

        .task-title {
          font-size: 12px;
          font-weight: 500;
          margin-bottom: 6px;
          line-height: 1.4;
          color: var(--loki-text-primary);
        }

        .task-meta {
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 10px;
          color: var(--loki-text-muted);
        }

        .task-type {
          background: var(--loki-bg-tertiary);
          padding: 2px 6px;
          border-radius: 3px;
        }

        .add-task-btn {
          background: transparent;
          border: 1px dashed var(--loki-border);
          border-radius: 6px;
          padding: 10px;
          color: var(--loki-text-muted);
          font-size: 12px;
          cursor: pointer;
          transition: all var(--loki-transition);
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          margin-top: 8px;
        }

        .add-task-btn:hover {
          border-color: var(--loki-accent);
          color: var(--loki-accent);
          background: var(--loki-accent-muted);
        }

        .empty-column {
          text-align: center;
          padding: 20px;
          color: var(--loki-text-muted);
          font-size: 12px;
        }

        /* Column icons */
        .column-icon {
          width: 14px;
          height: 14px;
          stroke: currentColor;
          stroke-width: 2;
          fill: none;
        }
      </style>
    `,e=i=>{switch(i){case"pending":return'<circle cx="12" cy="12" r="10"/>';case"in_progress":return'<path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>';case"review":return'<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';case"done":return'<path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>';default:return'<circle cx="12" cy="12" r="10"/>'}},a;if(this._loading)a='<div class="loading">Loading tasks...</div>';else if(this._error&&this._tasks.length===0)a=`<div class="error">Error: ${this._error}</div>`;else{let i=this.hasAttribute("readonly");a=`
        <div class="kanban-board">
          ${xt.map(s=>{let r=this._getTasksByStatus(s.status);return`
              <div class="kanban-column" data-status="${s.status}">
                <div class="kanban-column-header">
                  <span class="kanban-column-title">
                    <svg class="column-icon" viewBox="0 0 24 24" style="color: ${s.color}">
                      ${e(s.status)}
                    </svg>
                    ${s.label}
                  </span>
                  <span class="kanban-column-count">${r.length}</span>
                </div>
                <div class="kanban-tasks" data-status="${s.status}">
                  ${r.length===0?'<div class="empty-column">No tasks</div>':""}
                  ${r.map(o=>`
                    <div class="task-card ${!i&&!o.fromServer?"draggable":""} ${o.isLocal?"local":""}"
                         data-task-id="${o.id}"
                         tabindex="0"
                         role="button"
                         aria-label="Task: ${this._escapeHtml(o.title||"Untitled")}, ${o.priority||"medium"} priority"
                         ${!i&&!o.fromServer?'draggable="true"':""}>
                      <div class="task-card-header">
                        <span class="task-id">${o.isLocal?"LOCAL":"#"+o.id}</span>
                        <span class="task-priority ${(o.priority||"medium").toLowerCase()}">${o.priority||"medium"}</span>
                      </div>
                      <div class="task-title">${this._escapeHtml(o.title||"Untitled")}</div>
                      <div class="task-meta">
                        <span class="task-type">${o.type||"task"}</span>
                        ${o.assigned_agent_id?`<span>Agent #${o.assigned_agent_id}</span>`:""}
                      </div>
                    </div>
                  `).join("")}
                </div>
                ${!i&&s.status==="pending"?`
                  <button class="add-task-btn" data-status="${s.status}" aria-label="Add new task to ${s.label}">+ Add Task</button>
                `:""}
              </div>
            `}).join("")}
        </div>
      `}this.shadowRoot.innerHTML=`
      ${t}
      <div class="board-container">
        <div class="board-header">
          <h2 class="board-title">Task Queue</h2>
          <div class="board-actions">
            <button class="btn btn-secondary" id="refresh-btn" aria-label="Refresh task board">
              <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" aria-hidden="true">
                <polyline points="23 4 23 10 17 10"/>
                <polyline points="1 20 1 14 7 14"/>
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
              </svg>
              Refresh
            </button>
          </div>
        </div>
        ${a}
      </div>
    `,this._attachEventListeners()}_attachEventListeners(){let t=this.shadowRoot.getElementById("refresh-btn");t&&t.addEventListener("click",()=>this._loadTasks()),this.shadowRoot.querySelectorAll(".add-task-btn").forEach(e=>{e.addEventListener("click",()=>{this._openAddTaskModal(e.dataset.status)})}),this.shadowRoot.querySelectorAll(".task-card").forEach(e=>{let a=e.dataset.taskId,i=this._tasks.find(s=>s.id.toString()===a);i&&(e.addEventListener("click",()=>this._openTaskDetail(i)),e.addEventListener("keydown",s=>{s.key==="Enter"||s.key===" "?(s.preventDefault(),this._openTaskDetail(i)):(s.key==="ArrowDown"||s.key==="ArrowUp")&&(s.preventDefault(),this._navigateTaskCards(e,s.key==="ArrowDown"?"next":"prev"))}),e.classList.contains("draggable")&&(e.addEventListener("dragstart",s=>this._handleDragStart(s,i)),e.addEventListener("dragend",s=>this._handleDragEnd(s))))}),this.shadowRoot.querySelectorAll(".kanban-tasks").forEach(e=>{e.addEventListener("dragover",a=>this._handleDragOver(a)),e.addEventListener("dragenter",a=>this._handleDragEnter(a)),e.addEventListener("dragleave",a=>this._handleDragLeave(a)),e.addEventListener("drop",a=>this._handleDrop(a,e.dataset.status))})}_escapeHtml(t){let e=document.createElement("div");return e.textContent=t,e.innerHTML}_navigateTaskCards(t,e){let a=Array.from(this.shadowRoot.querySelectorAll(".task-card")),i=a.indexOf(t);if(i===-1)return;let s=e==="next"?i+1:i-1;s>=0&&s<a.length&&a[s].focus()}};customElements.get("loki-task-board")||customElements.define("loki-task-board",U);var j=class extends c{static get observedAttributes(){return["api-url","theme","compact"]}constructor(){super(),this._status={mode:"offline",phase:null,iteration:null,complexity:null,connected:!1,version:null,uptime:0,activeAgents:0,pendingTasks:0},this._api=null,this._state=L(),this._statusUpdateHandler=null,this._connectedHandler=null,this._disconnectedHandler=null}connectedCallback(){super.connectedCallback(),this._setupApi(),this._loadStatus(),this._startPolling()}disconnectedCallback(){super.disconnectedCallback(),this._stopPolling(),this._api&&(this._statusUpdateHandler&&this._api.removeEventListener(n.STATUS_UPDATE,this._statusUpdateHandler),this._connectedHandler&&this._api.removeEventListener(n.CONNECTED,this._connectedHandler),this._disconnectedHandler&&this._api.removeEventListener(n.DISCONNECTED,this._disconnectedHandler))}attributeChangedCallback(t,e,a){e!==a&&(t==="api-url"&&this._api&&(this._api.baseUrl=a,this._loadStatus()),t==="theme"&&this._applyTheme(),t==="compact"&&this.render())}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t}),this._statusUpdateHandler=e=>this._updateFromStatus(e.detail),this._connectedHandler=()=>{this._status.connected=!0,this.render()},this._disconnectedHandler=()=>{this._status.connected=!1,this._status.mode="offline",this.render()},this._api.addEventListener(n.STATUS_UPDATE,this._statusUpdateHandler),this._api.addEventListener(n.CONNECTED,this._connectedHandler),this._api.addEventListener(n.DISCONNECTED,this._disconnectedHandler)}async _loadStatus(){try{let t=await this._api.getStatus();this._updateFromStatus(t)}catch{this._status.connected=!1,this._status.mode="offline",this.render()}}_updateFromStatus(t){t&&(this._status={...this._status,connected:!0,mode:t.status||"running",version:t.version,uptime:t.uptime_seconds||0,activeAgents:t.running_agents||0,pendingTasks:t.pending_tasks||0,phase:t.phase,iteration:t.iteration,complexity:t.complexity},this._state.updateSession({connected:!0,mode:this._status.mode,lastSync:new Date().toISOString()}),this.render())}_startPolling(){this._ownPollInterval=setInterval(async()=>{try{let t=await this._api.getStatus();this._updateFromStatus(t)}catch{this._status.connected=!1,this._status.mode="offline",this.render()}},3e3)}_stopPolling(){this._ownPollInterval&&(clearInterval(this._ownPollInterval),this._ownPollInterval=null)}_formatUptime(t){if(!t||t<0)return"--";let e=Math.floor(t/3600),a=Math.floor(t%3600/60),i=Math.floor(t%60);return e>0?`${e}h ${a}m`:a>0?`${a}m ${i}s`:`${i}s`}_getStatusClass(){switch(this._status.mode){case"running":case"autonomous":return"active";case"paused":return"paused";case"stopped":return"stopped";case"error":return"error";default:return"offline"}}_getStatusLabel(){switch(this._status.mode){case"running":case"autonomous":return"AUTONOMOUS";case"paused":return"PAUSED";case"stopped":return"STOPPED";case"error":return"ERROR";default:return"OFFLINE"}}_triggerStart(){this.dispatchEvent(new CustomEvent("session-start",{detail:this._status}))}async _triggerPause(){try{await this._api.pauseSession(),this._status.mode="paused",this.render()}catch(t){console.error("Failed to pause session:",t)}this.dispatchEvent(new CustomEvent("session-pause",{detail:this._status}))}async _triggerResume(){try{await this._api.resumeSession(),this._status.mode="running",this.render()}catch(t){console.error("Failed to resume session:",t)}this.dispatchEvent(new CustomEvent("session-resume",{detail:this._status}))}async _triggerStop(){try{await this._api.stopSession(),this._status.mode="stopped",this.render()}catch(t){console.error("Failed to stop session:",t)}this.dispatchEvent(new CustomEvent("session-stop",{detail:this._status}))}render(){let t=this.hasAttribute("compact"),e=this._getStatusClass(),a=this._getStatusLabel(),i=["running","autonomous"].includes(this._status.mode),s=this._status.mode==="paused",r=`
      <style>
        ${this.getBaseStyles()}

        :host {
          display: block;
        }

        .control-panel {
          background: var(--loki-bg-tertiary);
          border-radius: 10px;
          padding: 14px;
          display: flex;
          flex-direction: column;
          gap: 10px;
          transition: background var(--loki-transition);
        }

        .control-panel.compact {
          padding: 10px;
          gap: 8px;
        }

        .panel-title {
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-text-muted);
          margin-bottom: 4px;
        }

        .status-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 12px;
        }

        .status-label {
          color: var(--loki-text-secondary);
        }

        .status-value {
          font-weight: 500;
          display: flex;
          align-items: center;
          gap: 6px;
          color: var(--loki-text-primary);
        }

        .status-dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
        }

        .status-dot.active {
          background: var(--loki-green);
          animation: pulse 2s infinite;
        }
        .status-dot.idle { background: var(--loki-text-muted); }
        .status-dot.paused { background: var(--loki-yellow); }
        .status-dot.stopped { background: var(--loki-red); }
        .status-dot.error { background: var(--loki-red); }
        .status-dot.offline { background: var(--loki-text-muted); }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }

        .control-buttons {
          display: flex;
          gap: 6px;
          margin-top: 6px;
        }

        .control-btn {
          flex: 1;
          padding: 6px 10px;
          border-radius: 6px;
          border: 1px solid var(--loki-border);
          background: var(--loki-bg-card);
          color: var(--loki-text-secondary);
          font-size: 11px;
          font-weight: 500;
          cursor: pointer;
          transition: all var(--loki-transition);
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 4px;
        }

        .control-btn:hover {
          background: var(--loki-bg-hover);
          color: var(--loki-text-primary);
        }

        .control-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .control-btn.start:hover:not(:disabled) {
          background: var(--loki-green-muted);
          color: var(--loki-green);
          border-color: var(--loki-green);
        }

        .control-btn.pause:hover:not(:disabled) {
          background: var(--loki-yellow-muted);
          color: var(--loki-yellow);
          border-color: var(--loki-yellow);
        }

        .control-btn.resume:hover:not(:disabled) {
          background: var(--loki-green-muted);
          color: var(--loki-green);
          border-color: var(--loki-green);
        }

        .control-btn.stop:hover:not(:disabled) {
          background: var(--loki-red-muted);
          color: var(--loki-red);
          border-color: var(--loki-red);
        }

        .control-btn svg {
          width: 10px;
          height: 10px;
          fill: currentColor;
        }

        .connection-status {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          background: var(--loki-bg-tertiary);
          border-radius: 6px;
          font-size: 11px;
          color: var(--loki-text-muted);
          margin-top: 4px;
        }

        .connection-dot {
          width: 6px;
          height: 6px;
          border-radius: 50%;
          background: var(--loki-red);
        }

        .connection-dot.connected {
          background: var(--loki-green);
          animation: pulse 2s infinite;
        }

        .stats-row {
          display: flex;
          justify-content: space-around;
          padding: 8px 0;
          border-top: 1px solid var(--loki-border);
          margin-top: 4px;
        }

        .stat-item {
          text-align: center;
        }

        .stat-value {
          font-size: 16px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-primary);
        }

        .stat-label {
          font-size: 10px;
          color: var(--loki-text-muted);
        }
      </style>
    `,o=`
      <div class="control-panel compact">
        <div class="status-row">
          <span class="status-value">
            <span class="status-dot ${e}"></span>
            ${a}
          </span>
        </div>
        <div class="control-buttons" role="group" aria-label="Session controls">
          ${s?`
            <button class="control-btn resume" id="resume-btn" aria-label="Resume session">
              <svg viewBox="0 0 24 24" aria-hidden="true"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Resume
            </button>
          `:`
            <button class="control-btn pause" id="pause-btn" aria-label="Pause session" ${i?"":"disabled"}>
              <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
              Pause
            </button>
          `}
          <button class="control-btn stop" id="stop-btn" aria-label="Stop session" ${!i&&!s?"disabled":""}>
            <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
            Stop
          </button>
        </div>
      </div>
    `,l=`
      <div class="control-panel">
        <div class="panel-title">System Status</div>

        <div class="status-row">
          <span class="status-label">Mode</span>
          <span class="status-value">
            <span class="status-dot ${e}"></span>
            ${a}
          </span>
        </div>

        <div class="status-row">
          <span class="status-label">Phase</span>
          <span class="status-value">${this._status.phase||"--"}</span>
        </div>

        <div class="status-row">
          <span class="status-label">Complexity</span>
          <span class="status-value">${String(this._status.complexity||"--").toUpperCase()}</span>
        </div>

        <div class="status-row">
          <span class="status-label">Iteration</span>
          <span class="status-value">${this._status.iteration||"--"}</span>
        </div>

        <div class="status-row">
          <span class="status-label">Uptime</span>
          <span class="status-value">${this._formatUptime(this._status.uptime)}</span>
        </div>

        <div class="control-buttons" role="group" aria-label="Session controls">
          ${s?`
            <button class="control-btn resume" id="resume-btn" aria-label="Resume session">
              <svg viewBox="0 0 24 24" aria-hidden="true"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Resume
            </button>
          `:`
            <button class="control-btn pause" id="pause-btn" aria-label="Pause session" ${i?"":"disabled"}>
              <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
              Pause
            </button>
          `}
          <button class="control-btn stop" id="stop-btn" aria-label="Stop session" ${!i&&!s?"disabled":""}>
            <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
            Stop
          </button>
        </div>

        <div class="connection-status">
          <span class="connection-dot ${this._status.connected?"connected":""}"></span>
          <span>${this._status.connected?"Connected":"Disconnected"}</span>
          ${this._status.version?`<span style="margin-left: auto">v${this._status.version}</span>`:""}
        </div>

        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-value">${this._status.activeAgents}</div>
            <div class="stat-label">Agents</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${this._status.pendingTasks}</div>
            <div class="stat-label">Pending</div>
          </div>
        </div>
      </div>
    `;this.shadowRoot.innerHTML=`
      ${r}
      ${t?o:l}
    `,this._attachEventListeners()}_attachEventListeners(){let t=this.shadowRoot.getElementById("pause-btn"),e=this.shadowRoot.getElementById("resume-btn"),a=this.shadowRoot.getElementById("stop-btn"),i=this.shadowRoot.getElementById("start-btn");t&&t.addEventListener("click",()=>this._triggerPause()),e&&e.addEventListener("click",()=>this._triggerResume()),a&&a.addEventListener("click",()=>this._triggerStop()),i&&i.addEventListener("click",()=>this._triggerStart())}};customElements.get("loki-session-control")||customElements.define("loki-session-control",j);var pt={info:{color:"var(--loki-blue)",label:"INFO"},success:{color:"var(--loki-green)",label:"SUCCESS"},warning:{color:"var(--loki-yellow)",label:"WARN"},error:{color:"var(--loki-red)",label:"ERROR"},step:{color:"var(--loki-purple)",label:"STEP"},agent:{color:"var(--loki-accent)",label:"AGENT"},debug:{color:"var(--loki-text-muted)",label:"DEBUG"}},F=class extends c{static get observedAttributes(){return["api-url","max-lines","auto-scroll","theme","log-file"]}constructor(){super(),this._logs=[],this._maxLines=500,this._autoScroll=!0,this._filter="",this._levelFilter="all",this._api=null,this._pollInterval=null,this._logMessageHandler=null}connectedCallback(){super.connectedCallback(),this._maxLines=parseInt(this.getAttribute("max-lines"))||500,this._autoScroll=this.hasAttribute("auto-scroll"),this._setupApi(),this._startLogPolling()}disconnectedCallback(){super.disconnectedCallback(),this._stopLogPolling(),this._api&&this._logMessageHandler&&this._api.removeEventListener(n.LOG_MESSAGE,this._logMessageHandler)}attributeChangedCallback(t,e,a){if(e!==a)switch(t){case"api-url":this._api&&(this._api.baseUrl=a);break;case"max-lines":this._maxLines=parseInt(a)||500,this._trimLogs(),this.render();break;case"auto-scroll":this._autoScroll=this.hasAttribute("auto-scroll"),this.render();break;case"theme":this._applyTheme();break}}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t}),this._logMessageHandler=e=>this._addLog(e.detail),this._api.addEventListener(n.LOG_MESSAGE,this._logMessageHandler)}_startLogPolling(){let t=this.getAttribute("log-file");t?this._pollLogFile(t):this._pollApiLogs()}async _pollApiLogs(){let t=0,e=async()=>{try{let a=await this._api.getLogs(200);if(Array.isArray(a)&&a.length>t){let i=a.slice(t);for(let s of i)s.message&&s.message.trim()&&this._addLog({message:s.message,level:s.level||"info",timestamp:s.timestamp||new Date().toLocaleTimeString()});t=a.length}}catch{}};e(),this._apiPollInterval=setInterval(e,2e3)}async _pollLogFile(t){let e=0,a=async()=>{try{let i=await fetch(`${t}?t=${Date.now()}`);if(!i.ok)return;let r=(await i.text()).split(`
`);if(r.length>e){let o=r.slice(e);for(let l of o)l.trim()&&this._addLog(this._parseLine(l));e=r.length}}catch{}};a(),this._pollInterval=setInterval(a,1e3)}_stopLogPolling(){this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null),this._apiPollInterval&&(clearInterval(this._apiPollInterval),this._apiPollInterval=null)}_parseLine(t){let e=t.match(/^\[([^\]]+)\]\s*\[([^\]]+)\]\s*(.+)$/);if(e)return{timestamp:e[1],level:e[2].toLowerCase(),message:e[3]};let a=t.match(/^(\d{2}:\d{2}:\d{2})\s+(\w+)\s+(.+)$/);return a?{timestamp:a[1],level:a[2].toLowerCase(),message:a[3]}:{timestamp:new Date().toLocaleTimeString(),level:"info",message:t}}_addLog(t){if(!t)return;let e={id:Date.now()+Math.random(),timestamp:t.timestamp||new Date().toLocaleTimeString(),level:(t.level||"info").toLowerCase(),message:t.message||t};this._logs.push(e),this._trimLogs(),this.dispatchEvent(new CustomEvent("log-received",{detail:e})),this._renderLogs(),this._autoScroll&&this._scrollToBottom()}_trimLogs(){this._logs.length>this._maxLines&&(this._logs=this._logs.slice(-this._maxLines))}_clearLogs(){this._logs=[],this.dispatchEvent(new CustomEvent("logs-cleared")),this._renderLogs()}_toggleAutoScroll(){this._autoScroll=!this._autoScroll,this.render(),this._autoScroll&&this._scrollToBottom()}_scrollToBottom(){requestAnimationFrame(()=>{let t=this.shadowRoot.getElementById("log-output");t&&(t.scrollTop=t.scrollHeight)})}_downloadLogs(){let t=this._logs.map(s=>`[${s.timestamp}] [${s.level.toUpperCase()}] ${s.message}`).join(`
`),e=new Blob([t],{type:"text/plain"}),a=URL.createObjectURL(e),i=document.createElement("a");i.href=a,i.download=`loki-logs-${new Date().toISOString().split("T")[0]}.txt`,i.click(),URL.revokeObjectURL(a)}_setFilter(t){this._filter=t.toLowerCase(),this._renderLogs()}_setLevelFilter(t){this._levelFilter=t,this._renderLogs()}_getFilteredLogs(){return this._logs.filter(t=>!(this._levelFilter!=="all"&&t.level!==this._levelFilter||this._filter&&!t.message.toLowerCase().includes(this._filter)))}_renderLogs(){let t=this.shadowRoot.getElementById("log-output");if(!t)return;let e=this._getFilteredLogs();if(e.length===0){t.innerHTML='<div class="log-empty">No log output yet. Terminal will update when Loki Mode is running.</div>';return}t.innerHTML=e.map(a=>{let i=pt[a.level]||pt.info;return`
        <div class="log-line">
          <span class="timestamp">${this._escapeHtml(a.timestamp)}</span>
          <span class="level" style="color: ${i.color}">[${this._escapeHtml(i.label)}]</span>
          <span class="message">${this._escapeHtml(a.message)}</span>
        </div>
      `}).join(""),this._autoScroll&&this._scrollToBottom()}_escapeHtml(t){let e=document.createElement("div");return e.textContent=t,e.innerHTML}render(){let t=`
      <style>
        ${this.getBaseStyles()}

        :host {
          display: block;
        }

        .terminal-container {
          background: var(--loki-bg-secondary);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          overflow: hidden;
        }

        .terminal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px 14px;
          background: var(--loki-bg-tertiary);
          border-bottom: 1px solid var(--loki-border);
        }

        .terminal-title {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 12px;
          font-weight: 600;
          color: var(--loki-text-secondary);
        }

        .terminal-dots {
          display: flex;
          gap: 6px;
        }

        .terminal-dot {
          width: 10px;
          height: 10px;
          border-radius: 50%;
        }

        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27c93f; }

        .terminal-controls {
          display: flex;
          gap: 8px;
          align-items: center;
        }

        .terminal-btn {
          padding: 4px 10px;
          background: var(--loki-bg-hover);
          border: 1px solid var(--loki-border-light);
          border-radius: 4px;
          color: var(--loki-text-secondary);
          font-size: 11px;
          cursor: pointer;
          transition: all var(--loki-transition);
        }

        .terminal-btn:hover {
          background: var(--loki-border-light);
          color: var(--loki-text-primary);
        }

        .terminal-btn.active {
          background: var(--loki-accent);
          border-color: var(--loki-accent);
          color: white;
        }

        .filter-input {
          padding: 4px 10px;
          background: var(--loki-bg-hover);
          border: 1px solid var(--loki-border-light);
          border-radius: 4px;
          color: var(--loki-text-primary);
          font-size: 11px;
          width: 120px;
        }

        .filter-input:focus {
          outline: none;
          border-color: var(--loki-accent);
        }

        .filter-input::placeholder {
          color: var(--loki-text-muted);
        }

        .level-select {
          padding: 4px 10px;
          background: var(--loki-bg-hover);
          border: 1px solid var(--loki-border-light);
          border-radius: 4px;
          color: var(--loki-text-secondary);
          font-size: 11px;
          cursor: pointer;
        }

        .log-output {
          padding: 14px;
          max-height: 350px;
          overflow-y: auto;
          font-family: 'JetBrains Mono', monospace;
          font-size: 12px;
          line-height: 1.6;
          color: var(--loki-text-primary);
          background: var(--loki-bg-secondary);
        }

        .log-line {
          display: flex;
          gap: 10px;
          white-space: pre-wrap;
          word-break: break-all;
        }

        .log-line .timestamp {
          color: var(--loki-text-muted);
          flex-shrink: 0;
        }

        .log-line .level {
          flex-shrink: 0;
          font-weight: 500;
        }

        .log-line .message {
          flex: 1;
        }

        .log-empty {
          color: var(--loki-text-muted);
          text-align: center;
          padding: 40px;
        }

        .log-count {
          font-size: 10px;
          color: var(--loki-text-muted);
          padding: 4px 14px;
          border-top: 1px solid var(--loki-border);
          background: var(--loki-bg-secondary);
        }

        /* Scrollbar */
        .log-output::-webkit-scrollbar { width: 6px; }
        .log-output::-webkit-scrollbar-track { background: var(--loki-bg-secondary); }
        .log-output::-webkit-scrollbar-thumb { background: var(--loki-border-light); border-radius: 3px; }
        .log-output::-webkit-scrollbar-thumb:hover { background: var(--loki-text-muted); }
      </style>
    `;this.shadowRoot.innerHTML=`
      ${t}
      <div class="terminal-container">
        <div class="terminal-header">
          <div class="terminal-title">
            <div class="terminal-dots">
              <span class="terminal-dot red"></span>
              <span class="terminal-dot yellow"></span>
              <span class="terminal-dot green"></span>
            </div>
            loki-mode -- agent output
          </div>
          <div class="terminal-controls">
            <input type="text" class="filter-input" id="filter-input" placeholder="Filter logs...">
            <select class="level-select" id="level-select">
              <option value="all">All Levels</option>
              <option value="info">Info</option>
              <option value="success">Success</option>
              <option value="warning">Warning</option>
              <option value="error">Error</option>
              <option value="step">Step</option>
              <option value="agent">Agent</option>
              <option value="debug">Debug</option>
            </select>
            <button class="terminal-btn ${this._autoScroll?"active":""}" id="auto-scroll-btn" aria-label="Toggle auto-scroll" aria-pressed="${this._autoScroll}">Auto-scroll</button>
            <button class="terminal-btn" id="clear-btn" aria-label="Clear all logs">Clear</button>
            <button class="terminal-btn" id="download-btn" aria-label="Download logs as text file">Download</button>
          </div>
        </div>
        <div class="log-output" id="log-output" role="log" aria-live="polite" aria-label="Log output">
          <div class="log-empty">No log output yet. Terminal will update when Loki Mode is running.</div>
        </div>
        <div class="log-count">
          ${this._logs.length} lines (${this._getFilteredLogs().length} shown)
        </div>
      </div>
    `,this._attachEventListeners(),this._renderLogs()}_attachEventListeners(){let t=this.shadowRoot.getElementById("filter-input"),e=this.shadowRoot.getElementById("level-select"),a=this.shadowRoot.getElementById("auto-scroll-btn"),i=this.shadowRoot.getElementById("clear-btn"),s=this.shadowRoot.getElementById("download-btn");t&&(t.value=this._filter,t.addEventListener("input",r=>this._setFilter(r.target.value))),e&&(e.value=this._levelFilter,e.addEventListener("change",r=>this._setLevelFilter(r.target.value))),a&&a.addEventListener("click",()=>this._toggleAutoScroll()),i&&i.addEventListener("click",()=>this._clearLogs()),s&&s.addEventListener("click",()=>this._downloadLogs())}addLog(t,e="info"){this._addLog({message:t,level:e,timestamp:new Date().toLocaleTimeString()})}clear(){this._clearLogs()}};customElements.get("loki-log-stream")||customElements.define("loki-log-stream",F);var yt=[{id:"summary",label:"Summary",icon:"M4 6h16M4 12h16M4 18h16"},{id:"episodes",label:"Episodes",icon:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"},{id:"patterns",label:"Patterns",icon:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},{id:"skills",label:"Skills",icon:"M13 10V3L4 14h7v7l9-11h-7z"}],O=class extends c{static get observedAttributes(){return["api-url","theme","tab"]}constructor(){super(),this._activeTab="summary",this._loading=!1,this._error=null,this._api=null,this._summary=null,this._episodes=[],this._patterns=[],this._skills=[],this._tokenEconomics=null,this._selectedItem=null,this._lastFocusedElement=null}connectedCallback(){super.connectedCallback(),this._activeTab=this.getAttribute("tab")||"summary",this._setupApi(),this._loadData()}attributeChangedCallback(t,e,a){if(e!==a)switch(t){case"api-url":this._api&&(this._api.baseUrl=a,this._loadData());break;case"theme":this._applyTheme();break;case"tab":this._setTab(a);break}}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t})}async _loadData(){this._loading=!0,this._error=null,this.render();try{this._summary=await this._api.getMemorySummary().catch(()=>null),this._tokenEconomics=await this._api.getTokenEconomics().catch(()=>null),await this._loadTabData()}catch(t){this._error=t.message||"Failed to load memory data"}this._loading=!1,this.render()}async _loadTabData(){switch(this._activeTab){case"episodes":this._episodes=await this._api.listEpisodes({limit:50}).catch(()=>[]);break;case"patterns":this._patterns=await this._api.listPatterns().catch(()=>[]);break;case"skills":this._skills=await this._api.listSkills().catch(()=>[]);break}}_setTab(t){this._activeTab!==t&&(this._activeTab=t,this._selectedItem=null,this._loadTabData().then(()=>this.render()))}async _selectEpisode(t){try{this._lastFocusedElement=this.shadowRoot.activeElement,this._selectedItem=await this._api.getEpisode(t),this.dispatchEvent(new CustomEvent("episode-select",{detail:this._selectedItem})),this.render(),this._focusDetailPanel()}catch(e){console.error("Failed to load episode:",e)}}async _selectPattern(t){try{this._lastFocusedElement=this.shadowRoot.activeElement,this._selectedItem=await this._api.getPattern(t),this.dispatchEvent(new CustomEvent("pattern-select",{detail:this._selectedItem})),this.render(),this._focusDetailPanel()}catch(e){console.error("Failed to load pattern:",e)}}async _selectSkill(t){try{this._lastFocusedElement=this.shadowRoot.activeElement,this._selectedItem=await this._api.getSkill(t),this.dispatchEvent(new CustomEvent("skill-select",{detail:this._selectedItem})),this.render(),this._focusDetailPanel()}catch(e){console.error("Failed to load skill:",e)}}_focusDetailPanel(){requestAnimationFrame(()=>{let t=this.shadowRoot.getElementById("close-detail");t&&t.focus()})}_closeDetail(){this._selectedItem=null,this.render(),this._lastFocusedElement&&requestAnimationFrame(()=>{this._lastFocusedElement.focus(),this._lastFocusedElement=null})}async _triggerConsolidation(){try{let t=await this._api.consolidateMemory(24);alert(`Consolidation complete:
- Patterns created: ${t.patternsCreated}
- Patterns merged: ${t.patternsMerged}
- Episodes processed: ${t.episodesProcessed}`),this._loadData()}catch(t){alert("Consolidation failed: "+t.message)}}_renderSummary(){if(!this._summary)return'<div class="empty-state">No memory data available</div>';let{episodic:t,semantic:e,procedural:a,tokenEconomics:i}=this._summary;return`
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-card-header">
            <span class="summary-card-title">Episodic Memory</span>
            <span class="summary-card-count">${t?.count||0}</span>
          </div>
          <div class="summary-card-detail">
            Specific interaction traces and outcomes
          </div>
          ${t?.latestDate?`<div class="summary-card-meta">Latest: ${new Date(t.latestDate).toLocaleDateString()}</div>`:""}
          <div class="memory-bar">
            <div class="memory-bar-fill episodic" style="width: ${Math.min((t?.count||0)/100*100,100)}%"></div>
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-card-header">
            <span class="summary-card-title">Semantic Memory</span>
            <span class="summary-card-count">${e?.patterns||0}</span>
          </div>
          <div class="summary-card-detail">
            Generalized patterns and anti-patterns
          </div>
          <div class="summary-card-meta">Anti-patterns: ${e?.antiPatterns||0}</div>
          <div class="memory-bar">
            <div class="memory-bar-fill semantic" style="width: ${Math.min((e?.patterns||0)/100*100,100)}%"></div>
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-card-header">
            <span class="summary-card-title">Procedural Memory</span>
            <span class="summary-card-count">${a?.skills||0}</span>
          </div>
          <div class="summary-card-detail">
            Learned skills and procedures
          </div>
          <div class="memory-bar">
            <div class="memory-bar-fill procedural" style="width: ${Math.min((a?.skills||0)/100*100,100)}%"></div>
          </div>
        </div>

        ${this._tokenEconomics?`
          <div class="summary-card token-economics">
            <div class="summary-card-header">
              <span class="summary-card-title">Token Economics</span>
            </div>
            <div class="economics-stats">
              <div class="econ-stat">
                <span class="econ-label">Discovery</span>
                <span class="econ-value">${this._tokenEconomics.discoveryTokens?.toLocaleString()||0}</span>
              </div>
              <div class="econ-stat">
                <span class="econ-label">Read</span>
                <span class="econ-value">${this._tokenEconomics.readTokens?.toLocaleString()||0}</span>
              </div>
              <div class="econ-stat">
                <span class="econ-label">Savings</span>
                <span class="econ-value savings">${(this._tokenEconomics.savingsPercent||0).toFixed(1)}%</span>
              </div>
            </div>
          </div>
        `:""}
      </div>

      <div class="summary-actions">
        <button class="btn btn-secondary" id="consolidate-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
            <polyline points="23 4 23 10 17 10"/>
            <polyline points="1 20 1 14 7 14"/>
            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
          </svg>
          Consolidate Memory
        </button>
        <button class="btn btn-secondary" id="refresh-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
            <polyline points="23 4 23 10 17 10"/>
            <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
          </svg>
          Refresh
        </button>
      </div>
    `}_renderEpisodes(){return this._episodes.length===0?'<div class="empty-state">No episodes recorded yet</div>':`
      <div class="item-list" role="list" aria-label="Episodes list">
        ${this._episodes.map(t=>`
          <div class="item-card" data-id="${t.id}" data-type="episode" tabindex="0" role="listitem" aria-label="Episode ${t.id}: ${this._escapeHtml(t.taskId||"Task")}, outcome ${t.outcome||"unknown"}">
            <div class="item-header">
              <span class="item-id mono">${t.id}</span>
              <span class="item-outcome ${t.outcome?.toLowerCase()}">${t.outcome||"unknown"}</span>
            </div>
            <div class="item-title">${this._escapeHtml(t.taskId||"Task")}</div>
            <div class="item-meta">
              <span>${t.agent||"unknown agent"}</span>
              <span>${t.phase||"unknown phase"}</span>
              <span>${new Date(t.timestamp).toLocaleString()}</span>
            </div>
          </div>
        `).join("")}
      </div>
    `}_renderPatterns(){return this._patterns.length===0?'<div class="empty-state">No patterns discovered yet</div>':`
      <div class="item-list" role="list" aria-label="Patterns list">
        ${this._patterns.map(t=>`
          <div class="item-card" data-id="${t.id}" data-type="pattern" tabindex="0" role="listitem" aria-label="Pattern: ${this._escapeHtml(t.pattern)}, ${(t.confidence*100).toFixed(0)} percent confidence">
            <div class="item-header">
              <span class="item-category">${t.category||"general"}</span>
              <span class="confidence-badge">${(t.confidence*100).toFixed(0)}%</span>
            </div>
            <div class="item-title">${this._escapeHtml(t.pattern)}</div>
            <div class="item-meta">
              <span>Used ${t.usageCount||0} times</span>
            </div>
          </div>
        `).join("")}
      </div>
    `}_renderSkills(){return this._skills.length===0?'<div class="empty-state">No skills learned yet</div>':`
      <div class="item-list" role="list" aria-label="Skills list">
        ${this._skills.map(t=>`
          <div class="item-card" data-id="${t.id}" data-type="skill" tabindex="0" role="listitem" aria-label="Skill: ${this._escapeHtml(t.name)}">
            <div class="item-header">
              <span class="item-id mono">${t.id}</span>
            </div>
            <div class="item-title">${this._escapeHtml(t.name)}</div>
            <div class="item-description">${this._escapeHtml(t.description||"")}</div>
          </div>
        `).join("")}
      </div>
    `}_renderDetail(){if(!this._selectedItem)return"";let t=this._selectedItem;return t.actionLog!==void 0?`
        <div class="detail-panel">
          <div class="detail-header">
            <h3>Episode: ${t.id}</h3>
            <button class="close-btn" id="close-detail">&times;</button>
          </div>
          <div class="detail-body">
            <div class="detail-row">
              <span class="detail-label">Task</span>
              <span class="detail-value">${t.taskId||"--"}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Agent</span>
              <span class="detail-value">${t.agent||"--"}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Phase</span>
              <span class="detail-value">${t.phase||"--"}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Outcome</span>
              <span class="detail-value outcome ${t.outcome?.toLowerCase()}">${t.outcome||"--"}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Duration</span>
              <span class="detail-value">${t.durationSeconds||0}s</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Tokens Used</span>
              <span class="detail-value">${t.tokensUsed?.toLocaleString()||0}</span>
            </div>
            ${t.goal?`
              <div class="detail-section">
                <div class="detail-label">Goal</div>
                <div class="detail-content">${this._escapeHtml(t.goal)}</div>
              </div>
            `:""}
            ${t.actionLog?.length?`
              <div class="detail-section">
                <div class="detail-label">Action Log (${t.actionLog.length})</div>
                <div class="action-log">
                  ${t.actionLog.map(e=>`
                    <div class="action-entry">
                      <span class="action-time">+${e.t}s</span>
                      <span class="action-type">${e.action}</span>
                      <span class="action-target">${this._escapeHtml(e.target)}</span>
                    </div>
                  `).join("")}
                </div>
              </div>
            `:""}
          </div>
        </div>
      `:t.conditions!==void 0?`
        <div class="detail-panel">
          <div class="detail-header">
            <h3>Pattern: ${t.id}</h3>
            <button class="close-btn" id="close-detail">&times;</button>
          </div>
          <div class="detail-body">
            <div class="detail-row">
              <span class="detail-label">Category</span>
              <span class="detail-value">${t.category||"general"}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Confidence</span>
              <span class="detail-value">${(t.confidence*100).toFixed(0)}%</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Usage Count</span>
              <span class="detail-value">${t.usageCount||0}</span>
            </div>
            <div class="detail-section">
              <div class="detail-label">Pattern</div>
              <div class="detail-content">${this._escapeHtml(t.pattern)}</div>
            </div>
            ${t.conditions?.length?`
              <div class="detail-section">
                <div class="detail-label">Conditions</div>
                <ul class="detail-list">
                  ${t.conditions.map(e=>`<li>${this._escapeHtml(e)}</li>`).join("")}
                </ul>
              </div>
            `:""}
            ${t.correctApproach?`
              <div class="detail-section">
                <div class="detail-label">Correct Approach</div>
                <div class="detail-content success">${this._escapeHtml(t.correctApproach)}</div>
              </div>
            `:""}
            ${t.incorrectApproach?`
              <div class="detail-section">
                <div class="detail-label">Incorrect Approach</div>
                <div class="detail-content error">${this._escapeHtml(t.incorrectApproach)}</div>
              </div>
            `:""}
          </div>
        </div>
      `:t.steps!==void 0?`
        <div class="detail-panel">
          <div class="detail-header">
            <h3>Skill: ${t.name}</h3>
            <button class="close-btn" id="close-detail">&times;</button>
          </div>
          <div class="detail-body">
            <div class="detail-section">
              <div class="detail-label">Description</div>
              <div class="detail-content">${this._escapeHtml(t.description)}</div>
            </div>
            ${t.prerequisites?.length?`
              <div class="detail-section">
                <div class="detail-label">Prerequisites</div>
                <ul class="detail-list">
                  ${t.prerequisites.map(e=>`<li>${this._escapeHtml(e)}</li>`).join("")}
                </ul>
              </div>
            `:""}
            ${t.steps?.length?`
              <div class="detail-section">
                <div class="detail-label">Steps</div>
                <ol class="detail-list numbered">
                  ${t.steps.map(e=>`<li>${this._escapeHtml(e)}</li>`).join("")}
                </ol>
              </div>
            `:""}
            ${t.exitCriteria?.length?`
              <div class="detail-section">
                <div class="detail-label">Exit Criteria</div>
                <ul class="detail-list">
                  ${t.exitCriteria.map(e=>`<li>${this._escapeHtml(e)}</li>`).join("")}
                </ul>
              </div>
            `:""}
          </div>
        </div>
      `:""}_escapeHtml(t){if(!t)return"";let e=document.createElement("div");return e.textContent=t,e.innerHTML}render(){let t=`
      <style>
        ${this.getBaseStyles()}

        :host {
          display: block;
        }

        .memory-browser {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          overflow: hidden;
        }

        .browser-header {
          padding: 12px 16px;
          border-bottom: 1px solid var(--loki-border);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .browser-title {
          font-size: 14px;
          font-weight: 600;
          color: var(--loki-text-primary);
        }

        .tabs {
          display: flex;
          border-bottom: 1px solid var(--loki-border);
          background: var(--loki-bg-secondary);
        }

        .tab {
          padding: 10px 16px;
          font-size: 12px;
          font-weight: 500;
          color: var(--loki-text-secondary);
          cursor: pointer;
          border: none;
          background: none;
          display: flex;
          align-items: center;
          gap: 6px;
          transition: all var(--loki-transition);
          border-bottom: 2px solid transparent;
          margin-bottom: -1px;
        }

        .tab:hover {
          color: var(--loki-text-primary);
          background: var(--loki-bg-hover);
        }

        .tab.active {
          color: var(--loki-accent);
          border-bottom-color: var(--loki-accent);
        }

        .tab svg {
          width: 14px;
          height: 14px;
          stroke: currentColor;
          stroke-width: 2;
          fill: none;
        }

        .browser-content {
          padding: 16px;
          min-height: 300px;
          max-height: 500px;
          overflow-y: auto;
          display: flex;
        }

        .content-main {
          flex: 1;
          min-width: 0;
        }

        .loading, .error-state {
          text-align: center;
          padding: 40px;
          color: var(--loki-text-muted);
        }

        .error-state {
          color: var(--loki-red);
        }

        /* Summary styles */
        .summary-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 12px;
        }

        .summary-card {
          background: var(--loki-bg-secondary);
          border-radius: 8px;
          padding: 14px;
        }

        .summary-card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
        }

        .summary-card-title {
          font-size: 12px;
          font-weight: 600;
          color: var(--loki-text-primary);
        }

        .summary-card-count {
          font-size: 18px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-accent);
        }

        .summary-card-detail {
          font-size: 11px;
          color: var(--loki-text-muted);
          margin-bottom: 8px;
        }

        .summary-card-meta {
          font-size: 10px;
          color: var(--loki-text-secondary);
          margin-bottom: 8px;
        }

        .memory-bar {
          height: 4px;
          background: var(--loki-bg-tertiary);
          border-radius: 2px;
          overflow: hidden;
        }

        .memory-bar-fill {
          height: 100%;
          border-radius: 2px;
          transition: width 0.3s ease;
        }

        .memory-bar-fill.episodic { background: var(--loki-blue); }
        .memory-bar-fill.semantic { background: var(--loki-purple); }
        .memory-bar-fill.procedural { background: var(--loki-green); }

        .token-economics .economics-stats {
          display: flex;
          gap: 16px;
          margin-top: 8px;
        }

        .econ-stat {
          text-align: center;
        }

        .econ-label {
          font-size: 10px;
          color: var(--loki-text-muted);
          display: block;
        }

        .econ-value {
          font-size: 14px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-primary);
        }

        .econ-value.savings {
          color: var(--loki-green);
        }

        .summary-actions {
          display: flex;
          gap: 8px;
          margin-top: 16px;
        }

        /* Item list styles */
        .item-list {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .item-card {
          background: var(--loki-bg-secondary);
          border: 1px solid var(--loki-border);
          border-radius: 6px;
          padding: 12px;
          cursor: pointer;
          transition: all var(--loki-transition);
        }

        .item-card:hover {
          border-color: var(--loki-border-light);
          transform: translateX(2px);
        }

        .item-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 6px;
        }

        .item-id {
          font-size: 10px;
          color: var(--loki-accent);
        }

        .item-category {
          font-size: 10px;
          padding: 2px 6px;
          background: var(--loki-bg-tertiary);
          border-radius: 3px;
          color: var(--loki-text-secondary);
        }

        .item-outcome {
          font-size: 9px;
          padding: 2px 6px;
          border-radius: 3px;
          text-transform: uppercase;
          font-weight: 500;
        }

        .item-outcome.success { background: var(--loki-green-muted); color: var(--loki-green); }
        .item-outcome.failure { background: var(--loki-red-muted); color: var(--loki-red); }
        .item-outcome.partial { background: var(--loki-yellow-muted); color: var(--loki-yellow); }

        .confidence-badge {
          font-size: 10px;
          font-weight: 500;
          color: var(--loki-blue);
        }

        .item-title {
          font-size: 12px;
          font-weight: 500;
          color: var(--loki-text-primary);
          margin-bottom: 4px;
        }

        .item-description {
          font-size: 11px;
          color: var(--loki-text-secondary);
          margin-bottom: 4px;
        }

        .item-meta {
          display: flex;
          gap: 12px;
          font-size: 10px;
          color: var(--loki-text-muted);
        }

        /* Detail panel */
        .detail-panel {
          width: 300px;
          min-width: 300px;
          background: var(--loki-bg-secondary);
          border-left: 1px solid var(--loki-border);
          margin: -16px -16px -16px 16px;
          padding: 16px;
          overflow-y: auto;
        }

        .detail-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }

        .detail-header h3 {
          font-size: 14px;
          font-weight: 600;
          color: var(--loki-text-primary);
        }

        .close-btn {
          background: none;
          border: none;
          font-size: 20px;
          color: var(--loki-text-muted);
          cursor: pointer;
          padding: 0;
          line-height: 1;
        }

        .close-btn:hover {
          color: var(--loki-text-primary);
        }

        .detail-row {
          display: flex;
          justify-content: space-between;
          padding: 6px 0;
          border-bottom: 1px solid var(--loki-border);
          font-size: 12px;
        }

        .detail-label {
          color: var(--loki-text-secondary);
          font-weight: 500;
          font-size: 11px;
          margin-bottom: 6px;
        }

        .detail-value {
          color: var(--loki-text-primary);
        }

        .detail-value.outcome.success { color: var(--loki-green); }
        .detail-value.outcome.failure { color: var(--loki-red); }

        .detail-section {
          margin-top: 16px;
        }

        .detail-content {
          background: var(--loki-bg-tertiary);
          padding: 10px;
          border-radius: 6px;
          font-size: 12px;
          color: var(--loki-text-primary);
        }

        .detail-content.success {
          border-left: 3px solid var(--loki-green);
        }

        .detail-content.error {
          border-left: 3px solid var(--loki-red);
        }

        .detail-list {
          padding-left: 20px;
          font-size: 12px;
          color: var(--loki-text-primary);
        }

        .detail-list li {
          margin-bottom: 4px;
        }

        .action-log {
          background: var(--loki-bg-tertiary);
          border-radius: 6px;
          padding: 8px;
          max-height: 200px;
          overflow-y: auto;
        }

        .action-entry {
          display: flex;
          gap: 8px;
          font-size: 11px;
          padding: 4px 0;
          border-bottom: 1px solid var(--loki-border);
        }

        .action-entry:last-child {
          border-bottom: none;
        }

        .action-time {
          color: var(--loki-text-muted);
          font-family: 'JetBrains Mono', monospace;
        }

        .action-type {
          color: var(--loki-blue);
          font-weight: 500;
        }

        .action-target {
          color: var(--loki-text-secondary);
          flex: 1;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .empty-state {
          text-align: center;
          padding: 40px;
          color: var(--loki-text-muted);
          font-size: 12px;
        }
      </style>
    `,e;if(this._loading)e='<div class="loading">Loading memory data...</div>';else if(this._error)e=`<div class="error-state">Error: ${this._error}</div>`;else{let a;switch(this._activeTab){case"summary":a=this._renderSummary();break;case"episodes":a=this._renderEpisodes();break;case"patterns":a=this._renderPatterns();break;case"skills":a=this._renderSkills();break;default:a=this._renderSummary()}e=`
        <div class="content-main">${a}</div>
        ${this._renderDetail()}
      `}this.shadowRoot.innerHTML=`
      ${t}
      <div class="memory-browser">
        <div class="browser-header">
          <span class="browser-title">Memory System</span>
        </div>
        <div class="tabs" role="tablist" aria-label="Memory browser sections">
          ${yt.map((a,i)=>`
            <button class="tab ${this._activeTab===a.id?"active":""}"
                    data-tab="${a.id}"
                    role="tab"
                    id="tab-${a.id}"
                    aria-selected="${this._activeTab===a.id}"
                    aria-controls="tabpanel-${a.id}"
                    tabindex="${this._activeTab===a.id?"0":"-1"}">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="${a.icon}"/></svg>
              ${a.label}
            </button>
          `).join("")}
        </div>
        <div class="browser-content" role="tabpanel" id="tabpanel-${this._activeTab}" aria-labelledby="tab-${this._activeTab}">
          ${e}
        </div>
      </div>
    `,this._attachEventListeners()}_attachEventListeners(){let t=this.shadowRoot.querySelectorAll(".tab");t.forEach((s,r)=>{s.addEventListener("click",()=>this._setTab(s.dataset.tab)),s.addEventListener("keydown",o=>{if(o.key==="ArrowRight"||o.key==="ArrowLeft"){o.preventDefault();let l=Array.from(t),p=o.key==="ArrowRight"?(r+1)%l.length:(r-1+l.length)%l.length;l[p].focus(),this._setTab(l[p].dataset.tab)}})}),this.shadowRoot.querySelectorAll(".item-card").forEach(s=>{s.addEventListener("click",()=>this._handleItemClick(s)),s.addEventListener("keydown",r=>{r.key==="Enter"||r.key===" "?(r.preventDefault(),this._handleItemClick(s)):(r.key==="ArrowDown"||r.key==="ArrowUp")&&(r.preventDefault(),this._navigateItemCards(s,r.key==="ArrowDown"?"next":"prev"))})});let e=this.shadowRoot.getElementById("close-detail");e&&e.addEventListener("click",()=>this._closeDetail());let a=this.shadowRoot.getElementById("consolidate-btn");a&&a.addEventListener("click",()=>this._triggerConsolidation());let i=this.shadowRoot.getElementById("refresh-btn");i&&i.addEventListener("click",()=>this._loadData())}_handleItemClick(t){let e=t.dataset.id;switch(t.dataset.type){case"episode":this._selectEpisode(e);break;case"pattern":this._selectPattern(e);break;case"skill":this._selectSkill(e);break}}_navigateItemCards(t,e){let a=Array.from(this.shadowRoot.querySelectorAll(".item-card")),i=a.indexOf(t);if(i===-1)return;let s=e==="next"?i+1:i-1;s>=0&&s<a.length&&a[s].focus()}};customElements.get("loki-memory-browser")||customElements.define("loki-memory-browser",O);var wt=[{id:"1h",label:"1 Hour",hours:1},{id:"24h",label:"24 Hours",hours:24},{id:"7d",label:"7 Days",hours:168},{id:"30d",label:"30 Days",hours:720}],$t=[{id:"all",label:"All Signals"},{id:"user_preference",label:"User Preferences"},{id:"error_pattern",label:"Error Patterns"},{id:"success_pattern",label:"Success Patterns"},{id:"tool_efficiency",label:"Tool Efficiency"},{id:"context_relevance",label:"Context Relevance"}],Tt=[{id:"all",label:"All Sources"},{id:"cli",label:"CLI"},{id:"api",label:"API"},{id:"vscode",label:"VS Code"},{id:"mcp",label:"MCP"},{id:"dashboard",label:"Dashboard"}],N=class extends c{static get observedAttributes(){return["api-url","theme","time-range","signal-type","source"]}constructor(){super(),this._loading=!1,this._error=null,this._api=null,this._timeRange="7d",this._signalType="all",this._source="all",this._metrics=null,this._trends=null,this._signals=[],this._selectedMetric=null}connectedCallback(){super.connectedCallback(),this._timeRange=this.getAttribute("time-range")||"7d",this._signalType=this.getAttribute("signal-type")||"all",this._source=this.getAttribute("source")||"all",this._setupApi(),this._loadData()}attributeChangedCallback(t,e,a){if(e!==a)switch(t){case"api-url":this._api&&(this._api.baseUrl=a,this._loadData());break;case"theme":this._applyTheme();break;case"time-range":this._timeRange=a,this._loadData();break;case"signal-type":this._signalType=a,this._loadData();break;case"source":this._source=a,this._loadData();break}}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t})}async _loadData(){this._loading=!0,this._error=null,this.render();try{let t={timeRange:this._timeRange,signalType:this._signalType!=="all"?this._signalType:void 0,source:this._source!=="all"?this._source:void 0},[e,a,i]=await Promise.all([this._api.getLearningMetrics(t).catch(()=>null),this._api.getLearningTrends(t).catch(()=>null),this._api.getLearningSignals({...t,limit:50}).catch(()=>[])]);this._metrics=e,this._trends=a,this._signals=i||[]}catch(t){this._error=t.message||"Failed to load learning data"}this._loading=!1,this.render()}_setFilter(t,e){switch(t){case"timeRange":this._timeRange=e,this.setAttribute("time-range",e);break;case"signalType":this._signalType=e,this.setAttribute("signal-type",e);break;case"source":this._source=e,this.setAttribute("source",e);break}this.dispatchEvent(new CustomEvent("filter-change",{detail:{timeRange:this._timeRange,signalType:this._signalType,source:this._source}})),this._loadData()}_selectMetric(t,e){this._selectedMetric={type:t,item:e},this.dispatchEvent(new CustomEvent("metric-select",{detail:{type:t,item:e}})),this.render()}_closeDetail(){this._selectedMetric=null,this.render()}_formatNumber(t){return t>=1e6?(t/1e6).toFixed(1)+"M":t>=1e3?(t/1e3).toFixed(1)+"K":t?.toString()||"0"}_formatPercent(t){return(t*100).toFixed(1)+"%"}_formatDuration(t){return t<60?t.toFixed(0)+"s":t<3600?(t/60).toFixed(1)+"m":(t/3600).toFixed(1)+"h"}_escapeHtml(t){if(!t)return"";let e=document.createElement("div");return e.textContent=t,e.innerHTML}_renderFilters(){return`
      <div class="filters">
        <div class="filter-group">
          <label>Time Range</label>
          <select id="time-range-select" class="filter-select">
            ${wt.map(t=>`
              <option value="${t.id}" ${this._timeRange===t.id?"selected":""}>${t.label}</option>
            `).join("")}
          </select>
        </div>
        <div class="filter-group">
          <label>Signal Type</label>
          <select id="signal-type-select" class="filter-select">
            ${$t.map(t=>`
              <option value="${t.id}" ${this._signalType===t.id?"selected":""}>${t.label}</option>
            `).join("")}
          </select>
        </div>
        <div class="filter-group">
          <label>Source</label>
          <select id="source-select" class="filter-select">
            ${Tt.map(t=>`
              <option value="${t.id}" ${this._source===t.id?"selected":""}>${t.label}</option>
            `).join("")}
          </select>
        </div>
        <button class="btn btn-secondary" id="refresh-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
            <polyline points="23 4 23 10 17 10"/>
            <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
          </svg>
          Refresh
        </button>
      </div>
    `}_renderSummaryCards(){if(!this._metrics)return'<div class="empty-state">No metrics available</div>';let{totalSignals:t,signalsByType:e,signalsBySource:a,aggregation:i}=this._metrics;return`
      <div class="summary-cards">
        <div class="summary-card">
          <div class="summary-card-header">
            <span class="summary-card-title">Total Signals</span>
            <span class="summary-card-count">${this._formatNumber(t||0)}</span>
          </div>
          <div class="summary-card-detail">Learning signals collected</div>
          <div class="signal-breakdown">
            ${Object.entries(e||{}).map(([s,r])=>`
              <div class="breakdown-item">
                <span class="breakdown-label">${s.replace("_"," ")}</span>
                <span class="breakdown-value">${this._formatNumber(r)}</span>
              </div>
            `).join("")}
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-card-header">
            <span class="summary-card-title">Sources</span>
            <span class="summary-card-count">${Object.keys(a||{}).length}</span>
          </div>
          <div class="summary-card-detail">Signal sources active</div>
          <div class="signal-breakdown">
            ${Object.entries(a||{}).map(([s,r])=>`
              <div class="breakdown-item">
                <span class="breakdown-label source-badge ${s}">${s}</span>
                <span class="breakdown-value">${this._formatNumber(r)}</span>
              </div>
            `).join("")}
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-card-header">
            <span class="summary-card-title">Patterns Found</span>
            <span class="summary-card-count">${this._formatNumber((i?.preferences?.length||0)+(i?.error_patterns?.length||0)+(i?.success_patterns?.length||0))}</span>
          </div>
          <div class="summary-card-detail">Aggregated learnings</div>
          <div class="pattern-counts">
            <div class="pattern-count">
              <span class="pattern-icon preferences">P</span>
              <span>${i?.preferences?.length||0} Preferences</span>
            </div>
            <div class="pattern-count">
              <span class="pattern-icon errors">E</span>
              <span>${i?.error_patterns?.length||0} Errors</span>
            </div>
            <div class="pattern-count">
              <span class="pattern-icon success">S</span>
              <span>${i?.success_patterns?.length||0} Success</span>
            </div>
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-card-header">
            <span class="summary-card-title">Avg Confidence</span>
            <span class="summary-card-count confidence-high">
              ${this._formatPercent(this._metrics.avgConfidence||0)}
            </span>
          </div>
          <div class="summary-card-detail">Signal reliability</div>
          <div class="confidence-bar">
            <div class="confidence-fill" style="width: ${(this._metrics.avgConfidence||0)*100}%"></div>
          </div>
        </div>
      </div>
    `}_renderTrendChart(){if(!this._trends||!this._trends.dataPoints||this._trends.dataPoints.length===0)return'<div class="chart-empty">No trend data available</div>';let{dataPoints:t,maxValue:e}=this._trends,a=120,i=400,s=20,r=t.map((l,p)=>{let y=s+p/(t.length-1||1)*(i-s*2),S=a-s-l.count/(e||1)*(a-s*2);return`${y},${S}`}).join(" "),o=`${s},${a-s} ${r} ${i-s},${a-s}`;return`
      <div class="trend-chart">
        <div class="chart-header">
          <span class="chart-title">Signal Volume Over Time</span>
          <span class="chart-subtitle">${this._trends.period}</span>
        </div>
        <svg class="chart-svg" viewBox="0 0 ${i} ${a}">
          <!-- Grid lines -->
          <line x1="${s}" y1="${s}" x2="${s}" y2="${a-s}" stroke="var(--loki-border)" stroke-width="1"/>
          <line x1="${s}" y1="${a-s}" x2="${i-s}" y2="${a-s}" stroke="var(--loki-border)" stroke-width="1"/>

          <!-- Area fill -->
          <polygon points="${o}" fill="var(--loki-accent-muted)" />

          <!-- Trend line -->
          <polyline points="${r}" fill="none" stroke="var(--loki-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>

          <!-- Data points -->
          ${t.map((l,p)=>{let y=s+p/(t.length-1||1)*(i-s*2),S=a-s-l.count/(e||1)*(a-s*2);return`<circle cx="${y}" cy="${S}" r="3" fill="var(--loki-accent)" />`}).join("")}
        </svg>
        <div class="chart-labels">
          ${t.length>0?`
            <span class="chart-label-start">${t[0].label}</span>
            <span class="chart-label-end">${t[t.length-1].label}</span>
          `:""}
        </div>
      </div>
    `}_renderTopLists(){if(!this._metrics?.aggregation)return"";let{preferences:t,error_patterns:e,success_patterns:a,tool_efficiencies:i}=this._metrics.aggregation;return`
      <div class="top-lists">
        <!-- User Preferences -->
        <div class="top-list">
          <div class="list-header">
            <span class="list-title">Top User Preferences</span>
            <span class="list-count">${t?.length||0}</span>
          </div>
          <div class="list-items" role="list">
            ${(t||[]).slice(0,5).map(s=>`
              <div class="list-item" data-type="preference" data-id="${s.preference_key}" tabindex="0" role="listitem">
                <div class="item-main">
                  <span class="item-key">${this._escapeHtml(s.preference_key)}</span>
                  <span class="item-value">${this._escapeHtml(String(s.preferred_value))}</span>
                </div>
                <div class="item-meta">
                  <span class="item-freq">${s.frequency}x</span>
                  <span class="item-conf">${this._formatPercent(s.confidence)}</span>
                </div>
              </div>
            `).join("")||'<div class="list-empty">No preferences found</div>'}
          </div>
        </div>

        <!-- Error Patterns -->
        <div class="top-list">
          <div class="list-header">
            <span class="list-title">Common Error Patterns</span>
            <span class="list-count">${e?.length||0}</span>
          </div>
          <div class="list-items" role="list">
            ${(e||[]).slice(0,5).map(s=>`
              <div class="list-item error-item" data-type="error_pattern" data-id="${s.error_type}" tabindex="0" role="listitem">
                <div class="item-main">
                  <span class="item-key">${this._escapeHtml(s.error_type)}</span>
                  <span class="resolution-rate ${s.resolution_rate>.5?"good":"poor"}">${this._formatPercent(s.resolution_rate)} resolved</span>
                </div>
                <div class="item-meta">
                  <span class="item-freq">${s.frequency}x</span>
                  <span class="item-conf">${this._formatPercent(s.confidence)}</span>
                </div>
              </div>
            `).join("")||'<div class="list-empty">No error patterns found</div>'}
          </div>
        </div>

        <!-- Success Patterns -->
        <div class="top-list">
          <div class="list-header">
            <span class="list-title">Success Patterns</span>
            <span class="list-count">${a?.length||0}</span>
          </div>
          <div class="list-items" role="list">
            ${(a||[]).slice(0,5).map(s=>`
              <div class="list-item success-item" data-type="success_pattern" data-id="${s.pattern_name}" tabindex="0" role="listitem">
                <div class="item-main">
                  <span class="item-key">${this._escapeHtml(s.pattern_name)}</span>
                  <span class="item-duration">${this._formatDuration(s.avg_duration_seconds)}</span>
                </div>
                <div class="item-meta">
                  <span class="item-freq">${s.frequency}x</span>
                  <span class="item-conf">${this._formatPercent(s.confidence)}</span>
                </div>
              </div>
            `).join("")||'<div class="list-empty">No success patterns found</div>'}
          </div>
        </div>

        <!-- Tool Efficiency -->
        <div class="top-list">
          <div class="list-header">
            <span class="list-title">Tool Efficiency Rankings</span>
            <span class="list-count">${i?.length||0}</span>
          </div>
          <div class="list-items" role="list">
            ${(i||[]).slice(0,5).map((s,r)=>`
              <div class="list-item tool-item" data-type="tool_efficiency" data-id="${s.tool_name}" tabindex="0" role="listitem">
                <div class="item-rank">#${r+1}</div>
                <div class="item-main">
                  <span class="item-key">${this._escapeHtml(s.tool_name)}</span>
                  <span class="efficiency-score">${(s.efficiency_score*100).toFixed(0)}</span>
                </div>
                <div class="item-meta">
                  <span class="success-rate ${s.success_rate>.8?"good":""}">${this._formatPercent(s.success_rate)}</span>
                  <span class="item-time">${s.avg_execution_time_ms.toFixed(0)}ms</span>
                </div>
              </div>
            `).join("")||'<div class="list-empty">No tool data found</div>'}
          </div>
        </div>
      </div>
    `}_renderRecentSignals(){return!this._signals||this._signals.length===0?'<div class="signals-empty">No recent signals</div>':`
      <div class="recent-signals">
        <div class="signals-header">
          <span class="signals-title">Recent Signals</span>
          <span class="signals-count">${this._signals.length}</span>
        </div>
        <div class="signals-list">
          ${this._signals.slice(0,10).map(t=>{let e=t.data||{},a=t.type||"unknown",i=e.action||t.action||a,s=e.source||t.source||"-",r=e.outcome||t.outcome||"-",o=t.timestamp?new Date(t.timestamp).toLocaleTimeString():"-";return`
            <div class="signal-item">
              <div class="signal-type ${a}">${a.replace("_"," ")}</div>
              <div class="signal-content">
                <span class="signal-action">${this._escapeHtml(i)}</span>
                <span class="signal-source">${s}</span>
              </div>
              <div class="signal-meta">
                <span class="signal-outcome ${r}">${r}</span>
                <span class="signal-time">${o}</span>
              </div>
            </div>`}).join("")}
        </div>
      </div>
    `}_renderDetailPanel(){if(!this._selectedMetric)return"";let{type:t,item:e}=this._selectedMetric,a="";switch(t){case"preference":a=`
          <div class="detail-row">
            <span class="detail-label">Preference Key</span>
            <span class="detail-value">${this._escapeHtml(e.preference_key)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Preferred Value</span>
            <span class="detail-value">${this._escapeHtml(String(e.preferred_value))}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Frequency</span>
            <span class="detail-value">${e.frequency} occurrences</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Confidence</span>
            <span class="detail-value">${this._formatPercent(e.confidence)}</span>
          </div>
          ${e.alternatives_rejected?.length?`
            <div class="detail-section">
              <div class="detail-label">Alternatives Rejected</div>
              <ul class="detail-list">
                ${e.alternatives_rejected.map(i=>`<li>${this._escapeHtml(i)}</li>`).join("")}
              </ul>
            </div>
          `:""}
        `;break;case"error_pattern":a=`
          <div class="detail-row">
            <span class="detail-label">Error Type</span>
            <span class="detail-value">${this._escapeHtml(e.error_type)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Resolution Rate</span>
            <span class="detail-value">${this._formatPercent(e.resolution_rate)}</span>
          </div>
          ${e.common_messages?.length?`
            <div class="detail-section">
              <div class="detail-label">Common Messages</div>
              <ul class="detail-list">
                ${e.common_messages.map(i=>`<li>${this._escapeHtml(i)}</li>`).join("")}
              </ul>
            </div>
          `:""}
          ${e.resolutions?.length?`
            <div class="detail-section">
              <div class="detail-label">Known Resolutions</div>
              <ul class="detail-list success">
                ${e.resolutions.map(i=>`<li>${this._escapeHtml(i)}</li>`).join("")}
              </ul>
            </div>
          `:""}
        `;break;case"success_pattern":a=`
          <div class="detail-row">
            <span class="detail-label">Pattern Name</span>
            <span class="detail-value">${this._escapeHtml(e.pattern_name)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Avg Duration</span>
            <span class="detail-value">${this._formatDuration(e.avg_duration_seconds)}</span>
          </div>
          ${e.common_actions?.length?`
            <div class="detail-section">
              <div class="detail-label">Common Actions</div>
              <ol class="detail-list numbered">
                ${e.common_actions.map(i=>`<li>${this._escapeHtml(i)}</li>`).join("")}
              </ol>
            </div>
          `:""}
        `;break;case"tool_efficiency":a=`
          <div class="detail-row">
            <span class="detail-label">Tool Name</span>
            <span class="detail-value">${this._escapeHtml(e.tool_name)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Usage Count</span>
            <span class="detail-value">${e.usage_count}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Success Rate</span>
            <span class="detail-value">${this._formatPercent(e.success_rate)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Avg Execution Time</span>
            <span class="detail-value">${e.avg_execution_time_ms.toFixed(0)}ms</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Total Tokens</span>
            <span class="detail-value">${this._formatNumber(e.total_tokens_used)}</span>
          </div>
          ${e.alternative_tools?.length?`
            <div class="detail-section">
              <div class="detail-label">Alternative Tools</div>
              <div class="tag-list">
                ${e.alternative_tools.map(i=>`<span class="tag">${this._escapeHtml(i)}</span>`).join("")}
              </div>
            </div>
          `:""}
        `;break}return`
      <div class="detail-panel">
        <div class="detail-header">
          <h3>${t.replace("_"," ").replace(/\b\w/g,i=>i.toUpperCase())}</h3>
          <button class="close-btn" id="close-detail">&times;</button>
        </div>
        <div class="detail-body">
          ${a}
          <div class="detail-row">
            <span class="detail-label">Sources</span>
            <div class="source-tags">
              ${(e.sources||[]).map(i=>`<span class="source-badge ${i}">${i}</span>`).join("")}
            </div>
          </div>
          <div class="detail-row">
            <span class="detail-label">First Seen</span>
            <span class="detail-value">${e.first_seen?new Date(e.first_seen).toLocaleDateString():"--"}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Last Seen</span>
            <span class="detail-value">${e.last_seen?new Date(e.last_seen).toLocaleDateString():"--"}</span>
          </div>
        </div>
      </div>
    `}render(){let t=`
      <style>
        ${this.getBaseStyles()}

        :host {
          display: block;
        }

        .learning-dashboard {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          overflow: hidden;
        }

        .dashboard-header {
          padding: 12px 16px;
          border-bottom: 1px solid var(--loki-border);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .dashboard-title {
          font-size: 14px;
          font-weight: 600;
          color: var(--loki-text-primary);
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .dashboard-title svg {
          color: var(--loki-accent);
        }

        /* Filters */
        .filters {
          display: flex;
          gap: 12px;
          align-items: center;
          padding: 12px 16px;
          background: var(--loki-bg-secondary);
          border-bottom: 1px solid var(--loki-border);
          flex-wrap: wrap;
        }

        .filter-group {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .filter-group label {
          font-size: 10px;
          font-weight: 500;
          color: var(--loki-text-muted);
          text-transform: uppercase;
        }

        .filter-select {
          padding: 6px 10px;
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 4px;
          font-size: 12px;
          color: var(--loki-text-primary);
          cursor: pointer;
        }

        .filter-select:focus {
          outline: none;
          border-color: var(--loki-accent);
        }

        /* Dashboard Content */
        .dashboard-content {
          padding: 16px;
          display: flex;
          gap: 16px;
          min-height: 400px;
        }

        .content-main {
          flex: 1;
          min-width: 0;
        }

        .loading, .error-state {
          text-align: center;
          padding: 40px;
          color: var(--loki-text-muted);
        }

        .error-state {
          color: var(--loki-red);
        }

        /* Summary Cards */
        .summary-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 12px;
          margin-bottom: 20px;
        }

        .summary-card {
          background: var(--loki-bg-secondary);
          border-radius: 8px;
          padding: 14px;
        }

        .summary-card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 6px;
        }

        .summary-card-title {
          font-size: 12px;
          font-weight: 600;
          color: var(--loki-text-primary);
        }

        .summary-card-count {
          font-size: 20px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-accent);
        }

        .summary-card-count.confidence-high {
          color: var(--loki-green);
        }

        .summary-card-detail {
          font-size: 11px;
          color: var(--loki-text-muted);
          margin-bottom: 10px;
        }

        .signal-breakdown {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .breakdown-item {
          display: flex;
          justify-content: space-between;
          font-size: 11px;
        }

        .breakdown-label {
          color: var(--loki-text-secondary);
          text-transform: capitalize;
        }

        .breakdown-value {
          color: var(--loki-text-primary);
          font-family: 'JetBrains Mono', monospace;
        }

        .source-badge {
          padding: 2px 6px;
          border-radius: 3px;
          font-size: 9px;
          text-transform: uppercase;
          font-weight: 500;
        }

        .source-badge.cli { background: var(--loki-blue-muted); color: var(--loki-blue); }
        .source-badge.api { background: var(--loki-green-muted); color: var(--loki-green); }
        .source-badge.vscode { background: var(--loki-purple-muted); color: var(--loki-purple); }
        .source-badge.mcp { background: var(--loki-yellow-muted); color: var(--loki-yellow); }
        .source-badge.dashboard { background: var(--loki-accent-muted); color: var(--loki-accent); }

        .pattern-counts {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .pattern-count {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 11px;
          color: var(--loki-text-secondary);
        }

        .pattern-icon {
          width: 18px;
          height: 18px;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 10px;
          font-weight: 600;
        }

        .pattern-icon.preferences { background: var(--loki-blue-muted); color: var(--loki-blue); }
        .pattern-icon.errors { background: var(--loki-red-muted); color: var(--loki-red); }
        .pattern-icon.success { background: var(--loki-green-muted); color: var(--loki-green); }

        .confidence-bar {
          height: 4px;
          background: var(--loki-bg-tertiary);
          border-radius: 2px;
          overflow: hidden;
        }

        .confidence-fill {
          height: 100%;
          background: var(--loki-green);
          border-radius: 2px;
          transition: width 0.3s ease;
        }

        /* Trend Chart */
        .trend-chart {
          background: var(--loki-bg-secondary);
          border-radius: 8px;
          padding: 14px;
          margin-bottom: 20px;
        }

        .chart-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
        }

        .chart-title {
          font-size: 12px;
          font-weight: 600;
          color: var(--loki-text-primary);
        }

        .chart-subtitle {
          font-size: 11px;
          color: var(--loki-text-muted);
        }

        .chart-svg {
          width: 100%;
          height: 120px;
        }

        .chart-labels {
          display: flex;
          justify-content: space-between;
          font-size: 10px;
          color: var(--loki-text-muted);
          margin-top: 4px;
        }

        .chart-empty {
          text-align: center;
          padding: 40px;
          color: var(--loki-text-muted);
          font-size: 12px;
          background: var(--loki-bg-secondary);
          border-radius: 8px;
          margin-bottom: 20px;
        }

        /* Top Lists */
        .top-lists {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 12px;
          margin-bottom: 20px;
        }

        .top-list {
          background: var(--loki-bg-secondary);
          border-radius: 8px;
          overflow: hidden;
        }

        .list-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px 12px;
          background: var(--loki-bg-tertiary);
        }

        .list-title {
          font-size: 11px;
          font-weight: 600;
          color: var(--loki-text-primary);
        }

        .list-count {
          font-size: 10px;
          padding: 2px 6px;
          background: var(--loki-bg-card);
          border-radius: 10px;
          color: var(--loki-text-muted);
        }

        .list-items {
          max-height: 200px;
          overflow-y: auto;
        }

        .list-item {
          padding: 10px 12px;
          border-bottom: 1px solid var(--loki-border);
          cursor: pointer;
          transition: background var(--loki-transition);
        }

        .list-item:hover {
          background: var(--loki-bg-hover);
        }

        .list-item:last-child {
          border-bottom: none;
        }

        .item-main {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 4px;
        }

        .item-key {
          font-size: 12px;
          font-weight: 500;
          color: var(--loki-text-primary);
          flex: 1;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .item-value {
          font-size: 11px;
          color: var(--loki-accent);
          margin-left: 8px;
        }

        .item-meta {
          display: flex;
          gap: 12px;
          font-size: 10px;
          color: var(--loki-text-muted);
        }

        .item-freq {
          color: var(--loki-blue);
        }

        .item-conf {
          color: var(--loki-green);
        }

        .item-rank {
          font-size: 11px;
          font-weight: 600;
          color: var(--loki-accent);
          margin-right: 8px;
        }

        .efficiency-score {
          font-family: 'JetBrains Mono', monospace;
          font-size: 12px;
          font-weight: 600;
          color: var(--loki-green);
        }

        .success-rate.good {
          color: var(--loki-green);
        }

        .resolution-rate {
          font-size: 10px;
          padding: 2px 6px;
          border-radius: 3px;
        }

        .resolution-rate.good {
          background: var(--loki-green-muted);
          color: var(--loki-green);
        }

        .resolution-rate.poor {
          background: var(--loki-red-muted);
          color: var(--loki-red);
        }

        .item-duration {
          font-size: 10px;
          color: var(--loki-text-muted);
        }

        .list-empty {
          padding: 20px;
          text-align: center;
          font-size: 11px;
          color: var(--loki-text-muted);
        }

        /* Recent Signals */
        .recent-signals {
          background: var(--loki-bg-secondary);
          border-radius: 8px;
          overflow: hidden;
        }

        .signals-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px 12px;
          background: var(--loki-bg-tertiary);
        }

        .signals-title {
          font-size: 11px;
          font-weight: 600;
          color: var(--loki-text-primary);
        }

        .signals-count {
          font-size: 10px;
          padding: 2px 6px;
          background: var(--loki-bg-card);
          border-radius: 10px;
          color: var(--loki-text-muted);
        }

        .signals-list {
          max-height: 300px;
          overflow-y: auto;
        }

        .signal-item {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 8px 12px;
          border-bottom: 1px solid var(--loki-border);
        }

        .signal-item:last-child {
          border-bottom: none;
        }

        .signal-type {
          font-size: 9px;
          padding: 3px 6px;
          border-radius: 3px;
          text-transform: uppercase;
          font-weight: 500;
          white-space: nowrap;
        }

        .signal-type.user_preference { background: var(--loki-blue-muted); color: var(--loki-blue); }
        .signal-type.error_pattern { background: var(--loki-red-muted); color: var(--loki-red); }
        .signal-type.success_pattern { background: var(--loki-green-muted); color: var(--loki-green); }
        .signal-type.tool_efficiency { background: var(--loki-purple-muted); color: var(--loki-purple); }
        .signal-type.context_relevance { background: var(--loki-yellow-muted); color: var(--loki-yellow); }

        .signal-content {
          flex: 1;
          min-width: 0;
        }

        .signal-action {
          font-size: 12px;
          color: var(--loki-text-primary);
          display: block;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .signal-source {
          font-size: 10px;
          color: var(--loki-text-muted);
        }

        .signal-meta {
          display: flex;
          flex-direction: column;
          align-items: flex-end;
          gap: 2px;
        }

        .signal-outcome {
          font-size: 9px;
          padding: 2px 5px;
          border-radius: 3px;
          text-transform: uppercase;
        }

        .signal-outcome.success { background: var(--loki-green-muted); color: var(--loki-green); }
        .signal-outcome.failure { background: var(--loki-red-muted); color: var(--loki-red); }
        .signal-outcome.partial { background: var(--loki-yellow-muted); color: var(--loki-yellow); }
        .signal-outcome.unknown { background: var(--loki-bg-tertiary); color: var(--loki-text-muted); }

        .signal-time {
          font-size: 10px;
          color: var(--loki-text-muted);
        }

        .signals-empty {
          padding: 30px;
          text-align: center;
          font-size: 12px;
          color: var(--loki-text-muted);
        }

        /* Detail Panel */
        .detail-panel {
          width: 300px;
          min-width: 300px;
          background: var(--loki-bg-secondary);
          border-left: 1px solid var(--loki-border);
          margin: -16px -16px -16px 16px;
          padding: 16px;
          overflow-y: auto;
        }

        .detail-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }

        .detail-header h3 {
          font-size: 14px;
          font-weight: 600;
          color: var(--loki-text-primary);
          text-transform: capitalize;
        }

        .close-btn {
          background: none;
          border: none;
          font-size: 20px;
          color: var(--loki-text-muted);
          cursor: pointer;
          padding: 0;
          line-height: 1;
        }

        .close-btn:hover {
          color: var(--loki-text-primary);
        }

        .detail-row {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px solid var(--loki-border);
          font-size: 12px;
        }

        .detail-label {
          color: var(--loki-text-secondary);
          font-weight: 500;
        }

        .detail-value {
          color: var(--loki-text-primary);
        }

        .detail-section {
          margin-top: 12px;
        }

        .detail-list {
          padding-left: 18px;
          margin-top: 6px;
          font-size: 11px;
          color: var(--loki-text-primary);
        }

        .detail-list li {
          margin-bottom: 4px;
        }

        .detail-list.success li {
          color: var(--loki-green);
        }

        .source-tags {
          display: flex;
          gap: 4px;
          flex-wrap: wrap;
        }

        .tag-list {
          display: flex;
          gap: 4px;
          flex-wrap: wrap;
          margin-top: 6px;
        }

        .tag {
          font-size: 10px;
          padding: 3px 8px;
          background: var(--loki-bg-tertiary);
          border-radius: 4px;
          color: var(--loki-text-secondary);
        }

        .empty-state {
          text-align: center;
          padding: 40px;
          color: var(--loki-text-muted);
          font-size: 12px;
        }
      </style>
    `,e;this._loading?e='<div class="loading">Loading learning metrics...</div>':this._error?e=`<div class="error-state">Error: ${this._error}</div>`:e=`
        <div class="content-main">
          ${this._renderSummaryCards()}
          ${this._renderTrendChart()}
          ${this._renderTopLists()}
          ${this._renderRecentSignals()}
        </div>
        ${this._renderDetailPanel()}
      `,this.shadowRoot.innerHTML=`
      ${t}
      <div class="learning-dashboard">
        <div class="dashboard-header">
          <span class="dashboard-title">
            <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
              <path d="M12 20V10"/>
              <path d="M18 20V4"/>
              <path d="M6 20v-4"/>
            </svg>
            Learning Metrics Dashboard
          </span>
        </div>
        ${this._renderFilters()}
        <div class="dashboard-content">
          ${e}
        </div>
      </div>
    `,this._attachEventListeners()}_attachEventListeners(){let t=this.shadowRoot.getElementById("time-range-select");t&&t.addEventListener("change",r=>this._setFilter("timeRange",r.target.value));let e=this.shadowRoot.getElementById("signal-type-select");e&&e.addEventListener("change",r=>this._setFilter("signalType",r.target.value));let a=this.shadowRoot.getElementById("source-select");a&&a.addEventListener("change",r=>this._setFilter("source",r.target.value));let i=this.shadowRoot.getElementById("refresh-btn");i&&i.addEventListener("click",()=>this._loadData());let s=this.shadowRoot.getElementById("close-detail");s&&s.addEventListener("click",()=>this._closeDetail()),this.shadowRoot.querySelectorAll(".list-item").forEach(r=>{r.addEventListener("click",()=>{let o=r.dataset.type,l=r.dataset.id,p=this._findItemData(o,l);p&&this._selectMetric(o,p)}),r.addEventListener("keydown",o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),r.click())})})}_findItemData(t,e){if(!this._metrics?.aggregation)return null;switch(t){case"preference":return this._metrics.aggregation.preferences?.find(a=>a.preference_key===e);case"error_pattern":return this._metrics.aggregation.error_patterns?.find(a=>a.error_type===e);case"success_pattern":return this._metrics.aggregation.success_patterns?.find(a=>a.pattern_name===e);case"tool_efficiency":return this._metrics.aggregation.tool_efficiencies?.find(a=>a.tool_name===e);default:return null}}};customElements.get("loki-learning-dashboard")||customElements.define("loki-learning-dashboard",N);var Et=[{id:"overview",label:"Overview"},{id:"decisions",label:"Decision Log"},{id:"convergence",label:"Convergence"},{id:"agents",label:"Agents"}],q=class extends c{static get observedAttributes(){return["api-url","theme"]}constructor(){super(),this._loading=!1,this._error=null,this._api=null,this._activeTab="overview",this._pollInterval=null,this._councilState=null,this._verdicts=[],this._convergence=[],this._agents=[],this._selectedAgent=null,this._lastDataHash=null}connectedCallback(){super.connectedCallback(),this._setupApi(),this._loadData(),this._startPolling()}disconnectedCallback(){super.disconnectedCallback(),this._stopPolling()}attributeChangedCallback(t,e,a){e!==a&&(t==="api-url"&&this._api&&(this._api.baseUrl=a,this._loadData()),t==="theme"&&this._applyTheme())}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t})}_startPolling(){this._pollInterval=setInterval(()=>this._loadData(),3e3),this._visibilityHandler=()=>{document.hidden?this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null):this._pollInterval||(this._loadData(),this._pollInterval=setInterval(()=>this._loadData(),3e3))},document.addEventListener("visibilitychange",this._visibilityHandler)}_stopPolling(){this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null),this._visibilityHandler&&(document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=null),this._pendingRaf&&(cancelAnimationFrame(this._pendingRaf),this._pendingRaf=null)}async _loadData(){try{let[e,a,i,s]=await Promise.allSettled([this._api._get("/api/council/state"),this._api._get("/api/council/verdicts"),this._api._get("/api/council/convergence"),this._api._get("/api/agents")]);e.status==="fulfilled"&&(this._councilState=e.value),a.status==="fulfilled"&&(this._verdicts=a.value.verdicts||[]),i.status==="fulfilled"&&(this._convergence=i.value.dataPoints||[]),s.status==="fulfilled"&&(this._agents=Array.isArray(s.value)?s.value:[]),this._error=null}catch(e){this._error=e.message}let t=JSON.stringify({s:this._councilState,v:this._verdicts,c:this._convergence,a:this._agents,e:this._error});t!==this._lastDataHash&&(this._lastDataHash=t,this.render())}async _forceReview(){try{await this._api._post("/api/council/force-review"),this.dispatchEvent(new CustomEvent("council-action",{detail:{action:"force-review"},bubbles:!0}))}catch(t){this._error=`Failed to force review: ${t.message}`,this.render()}}async _killAgent(t){if(confirm(`Kill agent ${t}?`))try{await this._api._post(`/api/agents/${t}/kill`),this.dispatchEvent(new CustomEvent("council-action",{detail:{action:"kill-agent",agentId:t},bubbles:!0})),await this._loadData()}catch(e){this._error=`Failed to kill agent: ${e.message}`,this.render()}}async _pauseAgent(t){try{await this._api._post(`/api/agents/${t}/pause`),await this._loadData()}catch(e){this._error=`Failed to pause agent: ${e.message}`,this.render()}}async _resumeAgent(t){try{await this._api._post(`/api/agents/${t}/resume`),await this._loadData()}catch(e){this._error=`Failed to resume agent: ${e.message}`,this.render()}}_setTab(t){this._activeTab=t,this.render()}_selectAgent(t){this._selectedAgent=this._selectedAgent?.id===t.id?null:t,this.render()}render(){let t=this.shadowRoot;t&&(this._pendingRaf&&(cancelAnimationFrame(this._pendingRaf),this._pendingRaf=null),t.innerHTML=`
      <style>${this.getBaseStyles()}${this._getStyles()}</style>
      <div class="council-dashboard">
        <div class="council-header">
          <div class="header-left">
            <h2 class="title">Completion Council</h2>
            ${this._councilState?.enabled!==!1?'<span class="badge badge-active">Active</span>':'<span class="badge badge-inactive">Disabled</span>'}
          </div>
          <button class="btn btn-primary" id="force-review-btn">
            Force Review
          </button>
        </div>

        <div class="tabs">
          ${Et.map(e=>`
            <button
              class="tab ${this._activeTab===e.id?"active":""}"
              data-tab="${e.id}"
            >${e.label}</button>
          `).join("")}
        </div>

        <div class="tab-content">
          ${this._renderTabContent()}
        </div>

        ${this._error?`<div class="error-banner">${this._error}</div>`:""}
      </div>
    `,this._attachEventListeners())}_attachEventListeners(){let t=this.shadowRoot;if(!t)return;let e=t.getElementById("force-review-btn");e&&e.addEventListener("click",()=>this._forceReview()),t.querySelectorAll(".tab[data-tab]").forEach(a=>{a.addEventListener("click",()=>this._setTab(a.dataset.tab))})}_renderTabContent(){switch(this._activeTab){case"overview":return this._renderOverview();case"decisions":return this._renderDecisions();case"convergence":return this._renderConvergence();case"agents":return this._renderAgents();default:return""}}_renderOverview(){let t=this._councilState||{},e=t.consecutive_no_change||0,a=t.done_signals||0,i=t.total_votes||0,s=t.approve_votes||0,r=this._verdicts.length>0?this._verdicts[this._verdicts.length-1]:null,o=this._agents.filter(l=>l.alive).length;return`
      <div class="overview-grid">
        <div class="stat-card">
          <div class="stat-label">Council Status</div>
          <div class="stat-value ${t.enabled!==!1?"text-green":"text-muted"}">
            ${t.enabled!==!1?"Monitoring":"Disabled"}
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Votes Cast</div>
          <div class="stat-value">${i}</div>
          <div class="stat-sub">${s} approved</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Stagnation Streak</div>
          <div class="stat-value ${e>=3?"text-warn":""}">${e}</div>
          <div class="stat-sub">consecutive no-change</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Done Signals</div>
          <div class="stat-value ${a>=2?"text-green":""}">${a}</div>
          <div class="stat-sub">from agent output</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Active Agents</div>
          <div class="stat-value">${o}</div>
          <div class="stat-sub">of ${this._agents.length} total</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Last Verdict</div>
          <div class="stat-value ${r?.result==="APPROVED"?"text-green":"text-muted"}">
            ${r?r.result:"None"}
          </div>
          ${r?`<div class="stat-sub">iteration ${r.iteration}</div>`:""}
        </div>
      </div>

      ${this._convergence.length>0?`
        <div class="section">
          <h3 class="section-title">Convergence Trend</h3>
          <div class="convergence-mini">
            ${this._renderConvergenceBar()}
          </div>
        </div>
      `:""}
    `}_renderConvergenceBar(){let t=this._convergence.slice(-20);if(t.length===0)return'<span class="text-muted">No data</span>';let e=Math.max(...t.map(a=>a.files_changed),1);return`
      <div class="bar-chart">
        ${t.map(a=>{let i=Math.max(4,a.files_changed/e*60),s=a.no_change_streak>0;return`
            <div class="bar-wrapper" title="Iter ${a.iteration}: ${a.files_changed} files changed">
              <div class="bar ${s?"bar-stagnant":"bar-active"}" style="height: ${i}px"></div>
              <div class="bar-label">${a.iteration}</div>
            </div>
          `}).join("")}
      </div>
    `}_renderDecisions(){return this._verdicts.length===0?`<div class="empty-state">No council decisions yet. The council convenes every ${this._councilState?.check_interval||5} iterations.</div>`:`
      <div class="decision-list">
        ${this._verdicts.slice().reverse().map(t=>`
          <div class="decision-card ${t.result==="APPROVED"?"decision-approved":"decision-rejected"}">
            <div class="decision-header">
              <span class="decision-result ${t.result==="APPROVED"?"text-green":"text-warn"}">
                ${t.result}
              </span>
              <span class="decision-iter">Iteration ${t.iteration}</span>
              <span class="decision-time">${this._formatTime(t.timestamp)}</span>
            </div>
            <div class="decision-votes">
              <span class="vote-approve">${t.approve} Approve</span>
              <span class="vote-reject">${t.reject} Reject</span>
            </div>
          </div>
        `).join("")}
      </div>
    `}_renderConvergence(){return this._convergence.length===0?'<div class="empty-state">No convergence data available yet.</div>':`
      <div class="section">
        <h3 class="section-title">Files Changed Per Iteration</h3>
        <div class="convergence-chart">
          ${this._renderConvergenceBar()}
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">Convergence Log</h3>
        <div class="convergence-table">
          <table>
            <thead>
              <tr>
                <th>Iteration</th>
                <th>Files Changed</th>
                <th>No-Change Streak</th>
                <th>Done Signals</th>
              </tr>
            </thead>
            <tbody>
              ${this._convergence.slice().reverse().map(t=>`
                <tr class="${t.no_change_streak>=3?"row-warn":""}">
                  <td>${t.iteration}</td>
                  <td>${t.files_changed}</td>
                  <td>${t.no_change_streak}</td>
                  <td>${t.done_signals}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>
    `}_renderAgents(){if(this._agents.length===0)return'<div class="empty-state">No agents registered.</div>';let t=`
      <div class="agents-list">
        ${this._agents.map((e,a)=>`
          <div class="agent-card ${this._selectedAgent?.id===e.id?"agent-selected":""}"
               data-agent-index="${a}">
            <div class="agent-header">
              <span class="agent-name">${e.name||e.id||"Unknown"}</span>
              <span class="agent-status ${e.alive?"status-alive":"status-dead"}">
                ${e.alive?"Running":"Stopped"}
              </span>
            </div>
            <div class="agent-meta">
              ${e.type?`<span class="agent-type">${e.type}</span>`:""}
              ${e.pid?`<span class="agent-pid">PID: ${e.pid}</span>`:""}
              ${e.task?`<span class="agent-task">Task: ${e.task}</span>`:""}
            </div>
            ${this._selectedAgent?.id===e.id?`
              <div class="agent-actions">
                ${e.alive?`
                  <button class="btn btn-sm btn-warn" data-action="pause" data-agent-id="${e.id||e.name}">
                    Pause
                  </button>
                  <button class="btn btn-sm btn-danger" data-action="kill" data-agent-id="${e.id||e.name}">
                    Kill
                  </button>
                `:`
                  <button class="btn btn-sm btn-primary" data-action="resume" data-agent-id="${e.id||e.name}">
                    Resume
                  </button>
                `}
              </div>
            `:""}
          </div>
        `).join("")}
      </div>
    `;return this._pendingRaf=requestAnimationFrame(()=>{this._pendingRaf=null;let e=this.shadowRoot;e&&e.querySelectorAll(".agent-card[data-agent-index]").forEach(a=>{let i=parseInt(a.dataset.agentIndex,10),s=this._agents[i];s&&(a.addEventListener("click",()=>this._selectAgent(s)),a.querySelectorAll("[data-action]").forEach(r=>{r.addEventListener("click",o=>{o.stopPropagation();let l=r.dataset.action,p=r.dataset.agentId;l==="pause"?this._pauseAgent(p):l==="kill"?this._killAgent(p):l==="resume"&&this._resumeAgent(p)})}))})}),t}_formatTime(t){if(!t)return"";try{return new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return t}}_getStyles(){return`
      :host {
        display: block;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--loki-text-primary);
      }

      .council-dashboard {
        padding: 16px;
      }

      .council-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }

      .badge {
        font-size: 11px;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .badge-active {
        background: var(--loki-success-muted);
        color: var(--loki-success);
        border: 1px solid var(--loki-success-muted);
      }

      .badge-inactive {
        background: var(--loki-bg-hover);
        color: var(--loki-text-muted);
        border: 1px solid var(--loki-border-light);
      }

      .tabs {
        display: flex;
        gap: 2px;
        border-bottom: 1px solid var(--loki-border);
        margin-bottom: 16px;
      }

      .tab {
        padding: 8px 16px;
        background: none;
        border: none;
        color: var(--loki-text-muted);
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: all 0.15s ease;
      }

      .tab:hover {
        color: var(--loki-text-primary);
      }

      .tab.active {
        color: var(--loki-accent);
        border-bottom-color: var(--loki-accent);
      }

      .btn {
        padding: 6px 14px;
        border: 1px solid var(--loki-border);
        border-radius: 6px;
        background: var(--loki-bg-tertiary);
        color: var(--loki-text-primary);
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.15s ease;
      }

      .btn:hover {
        background: var(--loki-accent);
        border-color: var(--loki-accent);
        color: white;
      }

      .btn-primary {
        background: var(--loki-accent);
        border-color: var(--loki-accent);
        color: white;
      }

      .btn-primary:hover {
        background: var(--loki-accent-hover);
      }

      .btn-sm {
        padding: 4px 10px;
        font-size: 11px;
      }

      .btn-warn {
        background: var(--loki-warning-muted);
        border-color: var(--loki-warning-muted);
        color: var(--loki-warning);
      }

      .btn-warn:hover {
        background: var(--loki-warning-muted);
        opacity: 0.85;
      }

      .btn-danger {
        background: var(--loki-error-muted);
        border-color: var(--loki-error-muted);
        color: var(--loki-error);
      }

      .btn-danger:hover {
        background: var(--loki-error-muted);
        opacity: 0.85;
      }

      /* Overview Grid */
      .overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: var(--loki-bg-card);
        border: 1px solid var(--loki-border);
        border-radius: 8px;
        padding: 14px;
      }

      .stat-label {
        font-size: 11px;
        font-weight: 500;
        color: var(--loki-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 600;
        line-height: 1.2;
      }

      .stat-sub {
        font-size: 11px;
        color: var(--loki-text-muted);
        margin-top: 2px;
      }

      .text-green { color: var(--loki-success); }
      .text-warn { color: var(--loki-warning); }
      .text-muted { color: var(--loki-text-muted); }

      /* Section */
      .section {
        margin-bottom: 20px;
      }

      .section-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--loki-text-secondary);
      }

      /* Bar Chart */
      .bar-chart {
        display: flex;
        align-items: flex-end;
        gap: 4px;
        height: 80px;
        padding: 8px;
        background: var(--loki-bg-card);
        border: 1px solid var(--loki-border);
        border-radius: 8px;
      }

      .bar-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        min-width: 0;
      }

      .bar {
        width: 100%;
        max-width: 24px;
        border-radius: 3px 3px 0 0;
        transition: height 0.3s ease;
      }

      .bar-active {
        background: var(--loki-accent);
      }

      .bar-stagnant {
        background: var(--loki-warning-muted);
      }

      .bar-label {
        font-size: 9px;
        color: var(--loki-text-muted);
        margin-top: 4px;
      }

      /* Decision List */
      .decision-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .decision-card {
        background: var(--loki-bg-card);
        border: 1px solid var(--loki-border);
        border-radius: 8px;
        padding: 12px 16px;
        border-left: 3px solid transparent;
      }

      .decision-approved {
        border-left-color: var(--loki-success);
      }

      .decision-rejected {
        border-left-color: var(--loki-error);
      }

      .decision-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 6px;
      }

      .decision-result {
        font-weight: 600;
        font-size: 13px;
      }

      .decision-iter {
        font-size: 12px;
        color: var(--loki-text-secondary);
      }

      .decision-time {
        font-size: 11px;
        color: var(--loki-text-muted);
        margin-left: auto;
      }

      .decision-votes {
        display: flex;
        gap: 16px;
        font-size: 12px;
      }

      .vote-approve {
        color: var(--loki-success);
      }

      .vote-reject {
        color: var(--loki-error);
      }

      /* Convergence Table */
      .convergence-table {
        background: var(--loki-bg-card);
        border: 1px solid var(--loki-border);
        border-radius: 8px;
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      th {
        text-align: left;
        padding: 10px 14px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--loki-text-muted);
        border-bottom: 1px solid var(--loki-border);
        background: var(--loki-bg-tertiary);
      }

      td {
        padding: 8px 14px;
        border-bottom: 1px solid var(--loki-border);
      }

      tr:last-child td {
        border-bottom: none;
      }

      .row-warn {
        background: var(--loki-warning-muted);
      }

      /* Agent List */
      .agents-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .agent-card {
        background: var(--loki-bg-card);
        border: 1px solid var(--loki-border);
        border-radius: 8px;
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .agent-card:hover {
        border-color: var(--loki-accent);
      }

      .agent-selected {
        border-color: var(--loki-accent);
        background: var(--loki-accent-muted);
      }

      .agent-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .agent-name {
        font-weight: 600;
        font-size: 13px;
      }

      .agent-status {
        font-size: 11px;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 10px;
      }

      .status-alive {
        background: var(--loki-success-muted);
        color: var(--loki-success);
      }

      .status-dead {
        background: var(--loki-bg-hover);
        color: var(--loki-text-muted);
      }

      .agent-meta {
        display: flex;
        gap: 12px;
        font-size: 11px;
        color: var(--loki-text-muted);
      }

      .agent-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--loki-border);
      }

      /* Empty State */
      .empty-state {
        padding: 40px;
        text-align: center;
        color: var(--loki-text-muted);
        font-size: 13px;
      }

      /* Error Banner */
      .error-banner {
        margin-top: 12px;
        padding: 10px 14px;
        background: var(--loki-error-muted);
        border: 1px solid var(--loki-error-muted);
        border-radius: 6px;
        color: var(--loki-error);
        font-size: 12px;
      }
    `}};customElements.get("loki-council-dashboard")||customElements.define("loki-council-dashboard",q);var ut={critical:0,major:1,minor:2},St={critical:"var(--loki-status-error, #ef4444)",major:"var(--loki-status-warning, #f59e0b)",minor:"var(--loki-text-muted, #71717a)"},G=class extends c{static get observedAttributes(){return["api-url","theme"]}constructor(){super(),this._loading=!1,this._error=null,this._api=null,this._pollInterval=null,this._checklist=null,this._waivers=[],this._expandedCategories=new Set,this._lastDataHash=null}connectedCallback(){super.connectedCallback(),this._setupApi(),this._loadData(),this._startPolling()}disconnectedCallback(){super.disconnectedCallback(),this._stopPolling()}attributeChangedCallback(t,e,a){e!==a&&(t==="api-url"&&this._api&&(this._api.baseUrl=a,this._loadData()),t==="theme"&&this._applyTheme())}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t})}_startPolling(){this._pollInterval=setInterval(()=>this._loadData(),5e3),this._visibilityHandler=()=>{document.hidden?this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null):this._pollInterval||(this._loadData(),this._pollInterval=setInterval(()=>this._loadData(),5e3))},document.addEventListener("visibilitychange",this._visibilityHandler)}_stopPolling(){this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null),this._visibilityHandler&&(document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=null)}async _loadData(){try{let[t,e]=await Promise.all([this._api.getChecklist(),this._api.getChecklistWaivers().catch(()=>null)]),a=JSON.stringify(e),i=JSON.stringify(t?.summary)+a;if(i===this._lastDataHash)return;this._lastDataHash=i,this._checklist=t,this._waivers=e&&e.waivers?e.waivers.filter(s=>s.active):[],this._error=null,this.render()}catch(t){this._error=`Failed to load checklist: ${t.message}`,this.render()}}_isItemWaived(t){return this._waivers.some(e=>e.item_id===t)}_getWaiverForItem(t){return this._waivers.find(e=>e.item_id===t)||null}async _waiveItem(t){let e=window.prompt("Enter reason for waiving this item:");if(e)try{await this._api.addChecklistWaiver(t,e),this._lastDataHash=null,await this._loadData()}catch(a){this._error=`Failed to add waiver: ${a.message}`,this.render()}}async _unwaiveItem(t){try{await this._api.removeChecklistWaiver(t),this._lastDataHash=null,await this._loadData()}catch(e){this._error=`Failed to remove waiver: ${e.message}`,this.render()}}_toggleCategory(t){this._expandedCategories.has(t)?this._expandedCategories.delete(t):this._expandedCategories.add(t),this.render()}_getStyles(){return`
      .checklist-viewer {
        padding: 16px;
        font-family: var(--loki-font-family, system-ui, -apple-system, sans-serif);
        color: var(--loki-text-primary, #18181b);
      }
      .checklist-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }
      .title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }
      .summary-badges {
        display: flex;
        gap: 8px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 500;
      }
      .badge-verified {
        background: color-mix(in srgb, var(--loki-status-success, #22c55e) 15%, transparent);
        color: var(--loki-status-success, #22c55e);
      }
      .badge-failing {
        background: color-mix(in srgb, var(--loki-status-error, #ef4444) 15%, transparent);
        color: var(--loki-status-error, #ef4444);
      }
      .badge-pending {
        background: color-mix(in srgb, var(--loki-text-muted, #71717a) 15%, transparent);
        color: var(--loki-text-muted, #71717a);
      }

      /* Progress bar */
      .progress-container {
        margin-bottom: 20px;
      }
      .progress-bar {
        height: 8px;
        background: var(--loki-bg-tertiary, #e4e4e7);
        border-radius: 4px;
        overflow: hidden;
        display: flex;
      }
      .progress-verified {
        background: var(--loki-status-success, #22c55e);
        transition: width 0.3s ease;
      }
      .progress-failing {
        background: var(--loki-status-error, #ef4444);
        transition: width 0.3s ease;
      }
      .progress-label {
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
        font-size: 12px;
        color: var(--loki-text-secondary, #52525b);
      }

      /* Category accordions */
      .category {
        border: 1px solid var(--loki-border, #e4e4e7);
        border-radius: 8px;
        margin-bottom: 8px;
        overflow: hidden;
      }
      .category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        cursor: pointer;
        background: var(--loki-bg-secondary, #f4f4f5);
        user-select: none;
        transition: background 0.15s;
      }
      .category-header:hover {
        background: var(--loki-bg-hover, #f0f0f3);
      }
      .category-name {
        font-weight: 600;
        font-size: 14px;
      }
      .category-stats {
        font-size: 12px;
        color: var(--loki-text-secondary, #52525b);
      }
      .category-arrow {
        font-size: 12px;
        transition: transform 0.2s;
      }
      .category-arrow.expanded {
        transform: rotate(90deg);
      }
      .category-body {
        padding: 0;
      }

      /* Checklist items */
      .item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 14px;
        border-top: 1px solid var(--loki-border, #e4e4e7);
        font-size: 13px;
      }
      .item-status {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .status-verified {
        background: var(--loki-status-success, #22c55e);
      }
      .status-failing {
        background: var(--loki-status-error, #ef4444);
      }
      .status-pending {
        background: var(--loki-text-muted, #a1a1aa);
      }
      .item-title {
        flex: 1;
        min-width: 0;
      }
      .item-priority {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 1px 6px;
        border-radius: 4px;
        flex-shrink: 0;
      }
      .verification-dots {
        display: flex;
        gap: 3px;
        flex-shrink: 0;
      }
      .v-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
      }
      .v-dot-pass { background: var(--loki-status-success, #22c55e); }
      .v-dot-fail { background: var(--loki-status-error, #ef4444); }
      .v-dot-pending { background: var(--loki-text-muted, #a1a1aa); }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: var(--loki-text-secondary, #52525b);
      }
      .empty-state p {
        margin: 8px 0;
        font-size: 14px;
      }
      .empty-state .hint {
        font-size: 12px;
        color: var(--loki-text-muted, #71717a);
      }

      /* Waiver badge */
      .badge-waived {
        background: #92400e;
        color: #fbbf24;
      }
      .item-waived-badge {
        display: inline-flex;
        align-items: center;
        padding: 1px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #92400e;
        color: #fbbf24;
        flex-shrink: 0;
        cursor: default;
      }

      /* Waive/Unwaive buttons */
      .waiver-btn {
        padding: 2px 8px;
        border: 1px solid var(--loki-border, #e4e4e7);
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        cursor: pointer;
        background: transparent;
        color: var(--loki-text-secondary, #52525b);
        flex-shrink: 0;
        transition: background 0.15s, color 0.15s;
      }
      .waiver-btn:hover {
        background: var(--loki-bg-hover, #f0f0f3);
        color: var(--loki-text-primary, #18181b);
      }
      .waiver-btn-unwaive {
        border-color: #92400e;
        color: #fbbf24;
      }
      .waiver-btn-unwaive:hover {
        background: #92400e;
        color: #fbbf24;
      }

      /* Council gate banner */
      .gate-banner {
        padding: 10px 14px;
        margin-bottom: 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
      }
      .gate-blocked {
        background: rgba(239, 68, 68, 0.1);
        border-left: 3px solid #ef4444;
        color: #fca5a5;
      }
      .gate-passed {
        background: rgba(34, 197, 94, 0.1);
        border-left: 3px solid #22c55e;
        color: #86efac;
      }

      /* Error */
      .error-banner {
        margin-top: 12px;
        padding: 8px 12px;
        background: color-mix(in srgb, var(--loki-status-error, #ef4444) 10%, transparent);
        color: var(--loki-status-error, #ef4444);
        border-radius: 6px;
        font-size: 12px;
      }
    `}_getUnwaivedCriticalFailures(){if(!this._checklist?.categories)return[];let t=[];for(let e of this._checklist.categories)for(let a of e.items||[])a.status==="failing"&&a.priority==="critical"&&!this._isItemWaived(a.id)&&t.push(a);return t}_renderGateBanner(){let t=this._getUnwaivedCriticalFailures();return t.length>0?`<div class="gate-banner gate-blocked">COUNCIL GATE: BLOCKED - ${t.length} critical item${t.length!==1?"s":""} must be verified or waived before completion</div>`:'<div class="gate-banner gate-passed">COUNCIL GATE: PASSED - No blocking critical failures</div>'}render(){let t=this.shadowRoot;if(!t)return;let e=this._checklist,a=e&&e.status!=="not_initialized"&&e.categories?.length>0;t.innerHTML=`
      <style>${this.getBaseStyles()}${this._getStyles()}</style>
      <div class="checklist-viewer">
        <div class="checklist-header">
          <h2 class="title">PRD Checklist</h2>
          ${a?this._renderBadges(e.summary):""}
        </div>
        ${a?this._renderGateBanner():""}
        ${a?this._renderProgress(e.summary):""}
        ${a?this._renderCategories(e.categories):this._renderEmpty()}
        ${this._error?`<div class="error-banner">${this._escapeHtml(this._error)}</div>`:""}
      </div>
    `,this._attachEventListeners()}_renderBadges(t){if(!t)return"";let e=this._waivers.length;return`
      <div class="summary-badges">
        ${t.verified?`<span class="badge badge-verified">${t.verified} verified</span>`:""}
        ${t.failing?`<span class="badge badge-failing">${t.failing} failing</span>`:""}
        ${e?`<span class="badge badge-waived">${e} waived</span>`:""}
        ${t.pending?`<span class="badge badge-pending">${t.pending} pending</span>`:""}
      </div>
    `}_renderProgress(t){if(!t||!t.total)return"";let e=t.verified/t.total*100,a=t.failing/t.total*100;return`
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-verified" style="width: ${e}%"></div>
          <div class="progress-failing" style="width: ${a}%"></div>
        </div>
        <div class="progress-label">
          <span>${t.verified}/${t.total} verified | ${t.failing||0} failing | ${this._waivers.length} waived | ${t.pending||0} pending</span>
          <span>${Math.round(e)}%</span>
        </div>
      </div>
    `}_renderCategories(t){return t?.length?t.map(e=>{let a=this._expandedCategories.has(e.name),i=e.items||[],s=i.filter(o=>o.status==="verified").length,r=i.filter(o=>o.status==="failing").length;return`
        <div class="category">
          <div class="category-header" data-category="${this._escapeHtml(e.name)}">
            <div>
              <span class="category-name">${this._escapeHtml(e.name)}</span>
              <span class="category-stats">${s}/${i.length} verified${r?`, ${r} failing`:""}</span>
            </div>
            <span class="category-arrow ${a?"expanded":""}">&#9654;</span>
          </div>
          ${a?`<div class="category-body">${this._renderItems(i)}</div>`:""}
        </div>
      `}).join(""):this._renderEmpty()}_renderItems(t){return t?.length?[...t].sort((a,i)=>(ut[a.priority]??2)-(ut[i.priority]??2)).map(a=>{let i=a.status==="verified"?"status-verified":a.status==="failing"?"status-failing":"status-pending",s=["critical","major","minor"].includes(a.priority)?a.priority:"minor",r=St[s],o=a.verification||[],l=this._getWaiverForItem(a.id),p=!!l,y=a.status==="failing"&&(s==="critical"||s==="major"),S=p?`<span class="item-waived-badge" title="${this._escapeHtml(l.reason||"No reason provided")}">WAIVED</span>`:"",P="";return y&&(p?P=`<button class="waiver-btn waiver-btn-unwaive" data-unwaive-id="${this._escapeHtml(a.id)}">Unwaive</button>`:P=`<button class="waiver-btn" data-waive-id="${this._escapeHtml(a.id)}">Waive</button>`),`
        <div class="item">
          <div class="item-status ${i}"></div>
          <div class="item-title">${this._escapeHtml(a.title||a.id||"?")}</div>
          <span class="item-priority" style="color:${r};border:1px solid ${r}">${s}</span>
          ${S}
          ${P}
          <div class="verification-dots">
            ${o.map(R=>`<div class="v-dot ${R.passed===!0?"v-dot-pass":R.passed===!1?"v-dot-fail":"v-dot-pending"}" title="${this._escapeHtml(R.type||"")}"></div>`).join("")}
          </div>
        </div>
      `}).join(""):'<div class="item" style="color:var(--loki-text-muted)">No items</div>'}_renderEmpty(){return`
      <div class="empty-state">
        <p>Checklist not initialized</p>
        <p class="hint">The PRD checklist will be created during the first iteration when a PRD is provided.</p>
      </div>
    `}_attachEventListeners(){let t=this.shadowRoot;t&&(t.querySelectorAll(".category-header[data-category]").forEach(e=>{e.addEventListener("click",()=>this._toggleCategory(e.dataset.category))}),t.querySelectorAll("button[data-waive-id]").forEach(e=>{e.addEventListener("click",a=>{a.stopPropagation(),this._waiveItem(e.dataset.waiveId)})}),t.querySelectorAll("button[data-unwaive-id]").forEach(e=>{e.addEventListener("click",a=>{a.stopPropagation(),this._unwaiveItem(e.dataset.unwaiveId)})}))}_escapeHtml(t){return t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}};customElements.define("loki-checklist-viewer",G);var gt={not_initialized:{color:"var(--loki-text-muted, #71717a)",label:"Not Started",pulse:!1},starting:{color:"var(--loki-yellow, #ca8a04)",label:"Starting...",pulse:!0},running:{color:"var(--loki-green, #16a34a)",label:"Running",pulse:!0},crashed:{color:"var(--loki-red, #dc2626)",label:"Crashed",pulse:!1},stopped:{color:"var(--loki-text-muted, #a1a1aa)",label:"Stopped",pulse:!1}},K=class extends c{static get observedAttributes(){return["api-url","theme"]}constructor(){super(),this._loading=!1,this._error=null,this._api=null,this._pollInterval=null,this._status=null,this._logs=[],this._lastDataHash=null}connectedCallback(){super.connectedCallback(),this._setupApi(),this._loadData(),this._startPolling()}disconnectedCallback(){super.disconnectedCallback(),this._stopPolling()}attributeChangedCallback(t,e,a){e!==a&&(t==="api-url"&&this._api&&(this._api.baseUrl=a,this._loadData()),t==="theme"&&this._applyTheme())}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t})}_startPolling(){this._pollInterval=setInterval(()=>this._loadData(),3e3),this._visibilityHandler=()=>{document.hidden?this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null):this._pollInterval||(this._loadData(),this._pollInterval=setInterval(()=>this._loadData(),3e3))},document.addEventListener("visibilitychange",this._visibilityHandler)}_stopPolling(){this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null),this._visibilityHandler&&(document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=null)}async _loadData(){try{let[t,e]=await Promise.all([this._api.getAppRunnerStatus(),this._api.getAppRunnerLogs()]),a=JSON.stringify({status:t?.status,port:t?.port,restarts:t?.restart_count,url:t?.url}),i=(e?.lines?.length||0)!==this._logs.length;if(a===this._lastDataHash&&!i)return;this._lastDataHash=a,this._status=t,this._logs=e?.lines||[],this._error=null,this.render(),this._scrollLogsToBottom()}catch(t){this._error||(this._error=`Failed to load app status: ${t.message}`,this.render())}}_scrollLogsToBottom(){let t=this.shadowRoot;if(!t)return;let e=t.querySelector(".log-area");e&&(e.scrollTop=e.scrollHeight)}async _handleRestart(){try{await this._api.restartApp(),this._loadData()}catch(t){this._error=`Restart failed: ${t.message}`,this.render()}}async _handleStop(){try{await this._api.stopApp(),this._loadData()}catch(t){this._error=`Stop failed: ${t.message}`,this.render()}}_formatUptime(t){if(!t)return"--";let e=new Date(t),i=Math.floor((new Date-e)/1e3);if(i<60)return`${i}s`;if(i<3600)return`${Math.floor(i/60)}m ${i%60}s`;let s=Math.floor(i/3600),r=Math.floor(i%3600/60);return`${s}h ${r}m`}_isValidUrl(t){if(!t)return!1;try{let e=new URL(t);return e.protocol==="http:"||e.protocol==="https:"}catch{return!1}}_getStyles(){return`
      .app-status {
        padding: 16px;
        font-family: var(--loki-font-family, system-ui, -apple-system, sans-serif);
        color: var(--loki-text-primary, #18181b);
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }

      /* Status dot */
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .status-dot.pulse {
        animation: dot-pulse 1.5s ease-in-out infinite;
      }
      @keyframes dot-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 10px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 500;
      }

      /* Status card */
      .status-card {
        background: var(--loki-bg-card, #ffffff);
        border: 1px solid var(--loki-border, #e4e4e7);
        border-radius: 8px;
        padding: 14px;
        margin-bottom: 12px;
      }
      .status-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 13px;
      }
      .status-label {
        color: var(--loki-text-secondary, #52525b);
      }
      .status-value {
        font-weight: 500;
      }
      .status-value a {
        color: var(--loki-accent, #7c3aed);
        text-decoration: none;
      }
      .status-value a:hover {
        text-decoration: underline;
      }

      /* Log viewer */
      .log-section {
        margin-bottom: 12px;
      }
      .log-header {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--loki-text-secondary, #52525b);
      }
      .log-area {
        background: var(--loki-bg-tertiary, #1a1a2e);
        border: 1px solid var(--loki-border, #e4e4e7);
        border-radius: 6px;
        padding: 10px;
        max-height: 300px;
        overflow-y: auto;
        font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
        font-size: 11px;
        line-height: 1.5;
        color: var(--loki-text-muted, #a1a1aa);
        white-space: pre-wrap;
        word-break: break-all;
      }
      .log-empty {
        color: var(--loki-text-muted, #71717a);
        font-style: italic;
      }

      /* Action buttons */
      .actions {
        display: flex;
        gap: 8px;
      }
      .btn {
        padding: 5px 14px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid var(--loki-border, #e4e4e7);
        background: var(--loki-bg-secondary, #f4f4f5);
        color: var(--loki-text-primary, #18181b);
        transition: background 0.15s;
      }
      .btn:hover {
        background: var(--loki-bg-hover, #f0f0f3);
      }
      .btn-danger {
        border-color: var(--loki-red, #dc2626);
        color: var(--loki-red, #dc2626);
      }
      .btn-danger:hover {
        background: var(--loki-red-muted, rgba(220, 38, 38, 0.12));
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: var(--loki-text-secondary, #52525b);
      }
      .empty-state p {
        margin: 8px 0;
        font-size: 14px;
      }
      .empty-state .hint {
        font-size: 12px;
        color: var(--loki-text-muted, #71717a);
      }

      /* Error */
      .error-banner {
        margin-top: 12px;
        padding: 8px 12px;
        background: color-mix(in srgb, var(--loki-status-error, #ef4444) 10%, transparent);
        color: var(--loki-status-error, #ef4444);
        border-radius: 6px;
        font-size: 12px;
      }
    `}render(){let t=this.shadowRoot;if(!t)return;let e=this._status,a=e&&e.status&&e.status!=="not_initialized";t.innerHTML=`
      <style>${this.getBaseStyles()}${this._getStyles()}</style>
      <div class="app-status">
        <div class="header">
          <div class="header-left">
            <h2 class="title">App Runner</h2>
            ${this._renderStatusBadge(e)}
          </div>
          ${a?this._renderActions(e):""}
        </div>
        ${a?this._renderStatusCard(e):""}
        ${a&&this._logs.length>0?this._renderLogs():""}
        ${a?"":this._renderEmpty()}
        ${this._error?`<div class="error-banner">${this._escapeHtml(this._error)}</div>`:""}
      </div>
    `,this._attachEventListeners()}_renderStatusBadge(t){let e=t?.status||"not_initialized",a=gt[e]||gt.not_initialized;return`
      <span class="status-badge" style="background: color-mix(in srgb, ${a.color} 15%, transparent); color: ${a.color}">
        <span class="status-dot ${a.pulse?"pulse":""}" style="background: ${a.color}"></span>
        ${this._escapeHtml(a.label)}
      </span>
    `}_renderStatusCard(t){let a=this._isValidUrl(t.url)?`<a href="${this._escapeHtml(t.url)}" target="_blank" rel="noopener noreferrer">${this._escapeHtml(t.url)}</a>`:this._escapeHtml(t.url||"--");return`
      <div class="status-card">
        <div class="status-row">
          <span class="status-label">Method</span>
          <span class="status-value">${this._escapeHtml(t.method||"--")}</span>
        </div>
        <div class="status-row">
          <span class="status-label">Port</span>
          <span class="status-value">${t.port?this._escapeHtml(String(t.port)):"--"}</span>
        </div>
        <div class="status-row">
          <span class="status-label">URL</span>
          <span class="status-value">${a}</span>
        </div>
        <div class="status-row">
          <span class="status-label">Restarts</span>
          <span class="status-value">${t.restart_count!=null?t.restart_count:"--"}</span>
        </div>
        <div class="status-row">
          <span class="status-label">Uptime</span>
          <span class="status-value">${this._formatUptime(t.started_at)}</span>
        </div>
        ${t.status==="crashed"&&t.error?`
          <div class="status-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--loki-border, #e4e4e7);">
            <span class="status-label" style="color: var(--loki-red, #dc2626)">Error</span>
            <span class="status-value" style="color: var(--loki-red, #dc2626); max-width: 70%; text-align: right;">${this._escapeHtml(t.error)}</span>
          </div>
        `:""}
      </div>
    `}_renderLogs(){let t=this._logs.slice(-20);return`
      <div class="log-section">
        <div class="log-header">Application Logs</div>
        <div class="log-area">${t.length>0?t.map(e=>this._escapeHtml(e)).join(`
`):'<span class="log-empty">No log output yet</span>'}</div>
      </div>
    `}_renderActions(t){let e=t.status==="running"||t.status==="crashed"||t.status==="stopped",a=t.status==="running"||t.status==="starting";return`
      <div class="actions">
        <button class="btn" data-action="restart" ${e?"":"disabled"}>Restart</button>
        <button class="btn btn-danger" data-action="stop" ${a?"":"disabled"}>Stop</button>
      </div>
    `}_renderEmpty(){return`
      <div class="empty-state">
        <p>App runner not started</p>
        <p class="hint">App runner will start after the first successful build iteration.</p>
      </div>
    `}_attachEventListeners(){let t=this.shadowRoot;if(!t)return;let e=t.querySelector('[data-action="restart"]'),a=t.querySelector('[data-action="stop"]');e&&e.addEventListener("click",()=>this._handleRestart()),a&&a.addEventListener("click",()=>this._handleStop())}_escapeHtml(t){return t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}};customElements.define("loki-app-status",K);var Ct={opus:{input:5,output:25,label:"Opus 4.6",provider:"claude"},sonnet:{input:3,output:15,label:"Sonnet 4.5",provider:"claude"},haiku:{input:1,output:5,label:"Haiku 4.5",provider:"claude"},"gpt-5.3-codex":{input:1.5,output:12,label:"GPT-5.3 Codex",provider:"codex"},"gemini-3-pro":{input:1.25,output:10,label:"Gemini 3 Pro",provider:"gemini"},"gemini-3-flash":{input:.1,output:.4,label:"Gemini 3 Flash",provider:"gemini"}},J=class extends c{static get observedAttributes(){return["api-url","theme"]}constructor(){super(),this._data={total_input_tokens:0,total_output_tokens:0,estimated_cost_usd:0,by_phase:{},by_model:{},budget_limit:null,budget_used:0,budget_remaining:null,connected:!1},this._api=null,this._pollInterval=null,this._modelPricing={...Ct}}connectedCallback(){super.connectedCallback(),this._setupApi(),this._loadPricing(),this._loadCost(),this._startPolling()}disconnectedCallback(){super.disconnectedCallback(),this._stopPolling()}attributeChangedCallback(t,e,a){e!==a&&(t==="api-url"&&this._api&&(this._api.baseUrl=a,this._loadCost()),t==="theme"&&this._applyTheme())}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t})}async _loadPricing(){try{let t=await this._api.getPricing();if(t&&t.models){let e={};for(let[a,i]of Object.entries(t.models))e[a]={input:i.input,output:i.output,label:i.label||a,provider:i.provider||"unknown"};this._modelPricing=e,this._pricingSource=t.source||"api",this._pricingDate=t.updated||"",this._activeProvider=t.provider||"claude",this.render()}}catch{}}async _loadCost(){try{let t=await this._api.getCost();this._updateFromCost(t)}catch{this._data.connected=!1,this.render()}}_updateFromCost(t){t&&(this._data={...this._data,connected:!0,total_input_tokens:t.total_input_tokens||0,total_output_tokens:t.total_output_tokens||0,estimated_cost_usd:t.estimated_cost_usd||0,by_phase:t.by_phase||{},by_model:t.by_model||{},budget_limit:t.budget_limit,budget_used:t.budget_used||0,budget_remaining:t.budget_remaining},this.render())}_startPolling(){this._pollInterval=setInterval(async()=>{try{let t=await this._api.getCost();this._updateFromCost(t)}catch{this._data.connected=!1,this.render()}},5e3)}_stopPolling(){this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null)}_formatTokens(t){return!t||t===0?"0":t>=1e6?(t/1e6).toFixed(2)+"M":t>=1e3?(t/1e3).toFixed(1)+"K":String(t)}_formatUSD(t){return!t||t===0?"$0.00":t<.01?"<$0.01":"$"+t.toFixed(2)}_getBudgetPercent(){return!this._data.budget_limit||this._data.budget_limit<=0?0:Math.min(100,this._data.budget_used/this._data.budget_limit*100)}_getBudgetStatusClass(){let t=this._getBudgetPercent();return t>=90?"critical":t>=70?"warning":"ok"}_renderPhaseRows(){let t=this._data.by_phase;return!t||Object.keys(t).length===0?'<tr><td colspan="4" class="empty-cell">No phase data yet</td></tr>':Object.entries(t).map(([e,a])=>{let i=a.input_tokens||0,s=a.output_tokens||0,r=a.cost_usd||0;return`
        <tr>
          <td class="phase-name">${this._escapeHTML(e)}</td>
          <td class="mono-cell">${this._formatTokens(i)}</td>
          <td class="mono-cell">${this._formatTokens(s)}</td>
          <td class="mono-cell cost-cell">${this._formatUSD(r)}</td>
        </tr>
      `}).join("")}_renderModelRows(){let t=this._data.by_model;return!t||Object.keys(t).length===0?'<tr><td colspan="4" class="empty-cell">No model data yet</td></tr>':Object.entries(t).map(([e,a])=>{let i=a.input_tokens||0,s=a.output_tokens||0,r=a.cost_usd||0;return`
        <tr>
          <td class="model-name">${this._escapeHTML(e)}</td>
          <td class="mono-cell">${this._formatTokens(i)}</td>
          <td class="mono-cell">${this._formatTokens(s)}</td>
          <td class="mono-cell cost-cell">${this._formatUSD(r)}</td>
        </tr>
      `}).join("")}_renderBudgetSection(){if(this._data.budget_limit===null||this._data.budget_limit===void 0)return`
        <div class="budget-section">
          <div class="section-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
            </svg>
            <span class="section-title">Budget</span>
          </div>
          <div class="budget-not-set">No budget configured</div>
        </div>
      `;let t=this._getBudgetPercent(),e=this._getBudgetStatusClass(),a=this._data.budget_remaining!=null?this._formatUSD(this._data.budget_remaining):this._formatUSD(this._data.budget_limit-this._data.budget_used);return`
      <div class="budget-section">
        <div class="section-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
          </svg>
          <span class="section-title">Budget</span>
        </div>
        <div class="budget-bar-container">
          <div class="budget-bar ${e}" style="width: ${t.toFixed(1)}%"></div>
        </div>
        <div class="budget-details">
          <span class="budget-used">${this._formatUSD(this._data.budget_used)} used</span>
          <span class="budget-remaining">${a} remaining</span>
          <span class="budget-limit">of ${this._formatUSD(this._data.budget_limit)}</span>
        </div>
      </div>
    `}_getPricingColorClass(t,e){return t==="opus"||t.includes("opus")?"opus":t==="sonnet"||t.includes("sonnet")?"sonnet":t==="haiku"||t.includes("haiku")?"haiku":e.provider==="codex"?"codex":e.provider==="gemini"?"gemini":""}_escapeHTML(t){return t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}render(){let t=this._data.total_input_tokens+this._data.total_output_tokens;this.shadowRoot.innerHTML=`
      <style>
        ${this.getBaseStyles()}

        :host {
          display: block;
        }

        .cost-container {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        /* Summary Cards */
        .summary-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          gap: 10px;
        }

        .summary-card {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          padding: 14px 16px;
          transition: all var(--loki-transition);
        }

        .summary-card:hover {
          border-color: var(--loki-border-light);
        }

        .card-label {
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-text-muted);
          margin-bottom: 6px;
        }

        .card-value {
          font-size: 22px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-primary);
          line-height: 1.2;
        }

        .card-value.accent {
          color: var(--loki-accent);
        }

        .card-sub {
          font-size: 11px;
          color: var(--loki-text-muted);
          margin-top: 4px;
          font-family: 'JetBrains Mono', monospace;
        }

        /* Section Headers */
        .section-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 10px;
        }

        .section-header svg {
          width: 16px;
          height: 16px;
          color: var(--loki-text-muted);
          flex-shrink: 0;
        }

        .section-title {
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-text-muted);
        }

        /* Tables */
        .data-table-container {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          padding: 16px;
          overflow-x: auto;
        }

        .data-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .data-table th {
          text-align: left;
          padding: 8px 12px;
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-text-muted);
          border-bottom: 1px solid var(--loki-border);
        }

        .data-table td {
          padding: 8px 12px;
          color: var(--loki-text-secondary);
          border-bottom: 1px solid var(--loki-border);
        }

        .data-table tr:last-child td {
          border-bottom: none;
        }

        .data-table tr:hover td {
          background: var(--loki-bg-hover);
        }

        .phase-name, .model-name {
          font-weight: 500;
          color: var(--loki-text-primary);
          text-transform: capitalize;
        }

        .mono-cell {
          font-family: 'JetBrains Mono', monospace;
          text-align: right;
        }

        .cost-cell {
          color: var(--loki-accent);
          font-weight: 500;
        }

        .empty-cell {
          text-align: center;
          color: var(--loki-text-muted);
          font-style: italic;
          padding: 16px 12px;
        }

        /* Budget Section */
        .budget-section {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          padding: 16px;
        }

        .budget-bar-container {
          width: 100%;
          height: 8px;
          background: var(--loki-bg-tertiary);
          border-radius: 4px;
          overflow: hidden;
          margin-bottom: 10px;
        }

        .budget-bar {
          height: 100%;
          border-radius: 4px;
          transition: width 0.5s ease;
        }

        .budget-bar.ok {
          background: var(--loki-green);
        }

        .budget-bar.warning {
          background: var(--loki-yellow);
        }

        .budget-bar.critical {
          background: var(--loki-red);
        }

        .budget-details {
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 12px;
          font-family: 'JetBrains Mono', monospace;
        }

        .budget-used {
          color: var(--loki-text-primary);
          font-weight: 500;
        }

        .budget-remaining {
          color: var(--loki-text-secondary);
        }

        .budget-limit {
          color: var(--loki-text-muted);
        }

        .budget-not-set {
          color: var(--loki-text-muted);
          font-size: 12px;
          font-style: italic;
        }

        /* Pricing Reference */
        .pricing-ref {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          padding: 16px;
        }

        .pricing-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
          gap: 8px;
          margin-top: 8px;
        }

        .pricing-item {
          background: var(--loki-bg-tertiary);
          border-radius: 8px;
          padding: 10px 12px;
        }

        .pricing-model {
          font-size: 12px;
          font-weight: 600;
          color: var(--loki-text-primary);
          margin-bottom: 4px;
        }

        .pricing-model.opus { color: var(--loki-opus); }
        .pricing-model.sonnet { color: var(--loki-sonnet); }
        .pricing-model.haiku { color: var(--loki-haiku); }
        .pricing-model.codex { color: var(--loki-blue); }
        .pricing-model.gemini { color: var(--loki-green); }

        .pricing-meta {
          font-size: 10px;
          color: var(--loki-text-muted);
          margin-left: auto;
          font-family: 'JetBrains Mono', monospace;
        }

        .pricing-rates {
          font-size: 11px;
          color: var(--loki-text-muted);
          font-family: 'JetBrains Mono', monospace;
          line-height: 1.5;
        }

        /* Offline state */
        .offline-notice {
          text-align: center;
          padding: 20px;
          color: var(--loki-text-muted);
          font-size: 12px;
        }
      </style>

      <div class="cost-container">
        ${this._data.connected?"":`
          <div class="offline-notice">Connecting to cost API...</div>
        `}

        <!-- Summary Cards -->
        <div class="summary-grid">
          <div class="summary-card">
            <div class="card-label">Total Tokens</div>
            <div class="card-value">${this._formatTokens(t)}</div>
            <div class="card-sub">${this._formatTokens(this._data.total_input_tokens)} in / ${this._formatTokens(this._data.total_output_tokens)} out</div>
          </div>

          <div class="summary-card">
            <div class="card-label">Input Tokens</div>
            <div class="card-value">${this._formatTokens(this._data.total_input_tokens)}</div>
          </div>

          <div class="summary-card">
            <div class="card-label">Output Tokens</div>
            <div class="card-value">${this._formatTokens(this._data.total_output_tokens)}</div>
          </div>

          <div class="summary-card">
            <div class="card-label">Estimated Cost</div>
            <div class="card-value accent">${this._formatUSD(this._data.estimated_cost_usd)}</div>
          </div>
        </div>

        <!-- Budget -->
        ${this._renderBudgetSection()}

        <!-- Cost by Model -->
        <div class="data-table-container">
          <div class="section-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/>
            </svg>
            <span class="section-title">Cost by Model</span>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Model</th>
                <th style="text-align:right">Input</th>
                <th style="text-align:right">Output</th>
                <th style="text-align:right">Cost</th>
              </tr>
            </thead>
            <tbody>
              ${this._renderModelRows()}
            </tbody>
          </table>
        </div>

        <!-- Cost by Phase -->
        <div class="data-table-container">
          <div class="section-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
            <span class="section-title">Cost by Phase</span>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Phase</th>
                <th style="text-align:right">Input</th>
                <th style="text-align:right">Output</th>
                <th style="text-align:right">Cost</th>
              </tr>
            </thead>
            <tbody>
              ${this._renderPhaseRows()}
            </tbody>
          </table>
        </div>

        <!-- Pricing Reference -->
        <div class="pricing-ref">
          <div class="section-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            <span class="section-title">API Pricing Reference (per 1M tokens)</span>
            ${this._pricingDate?`<span class="pricing-meta">Updated: ${this._escapeHTML(this._pricingDate)}</span>`:""}
          </div>
          <div class="pricing-grid">
            ${Object.entries(this._modelPricing).map(([e,a])=>`
            <div class="pricing-item">
              <div class="pricing-model ${this._getPricingColorClass(e,a)}">${a.label||e}</div>
              <div class="pricing-rates">In: $${a.input.toFixed(2)} / Out: $${a.output.toFixed(2)}</div>
            </div>`).join("")}
          </div>
        </div>
      </div>
    `}};customElements.get("loki-cost-dashboard")||customElements.define("loki-cost-dashboard",J);var V=class extends c{static get observedAttributes(){return["api-url","theme"]}constructor(){super(),this._loading=!1,this._error=null,this._api=null,this._checkpoints=[],this._pollInterval=null,this._lastDataHash=null,this._showCreateForm=!1,this._creating=!1,this._rollingBack=!1,this._rollbackTarget=null}connectedCallback(){super.connectedCallback(),this._setupApi(),this._loadData(),this._startPolling()}disconnectedCallback(){super.disconnectedCallback(),this._stopPolling()}attributeChangedCallback(t,e,a){e!==a&&(t==="api-url"&&this._api&&(this._api.baseUrl=a,this._loadData()),t==="theme"&&this._applyTheme())}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t})}_startPolling(){this._pollInterval=setInterval(()=>this._loadData(),3e3),this._visibilityHandler=()=>{document.hidden?this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null):this._pollInterval||(this._loadData(),this._pollInterval=setInterval(()=>this._loadData(),3e3))},document.addEventListener("visibilitychange",this._visibilityHandler)}_stopPolling(){this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null),this._visibilityHandler&&(document.removeEventListener("visibilitychange",this._visibilityHandler),this._visibilityHandler=null)}async _loadData(){try{let[e]=await Promise.allSettled([this._api._get("/api/checkpoints?limit=50")]);e.status==="fulfilled"&&(this._checkpoints=Array.isArray(e.value)?e.value:e.value?.checkpoints||[]),this._error=null}catch(e){this._error=e.message}let t=JSON.stringify({c:this._checkpoints,e:this._error});t!==this._lastDataHash&&(this._lastDataHash=t,this.render())}async _createCheckpoint(){let t=this.shadowRoot.getElementById("checkpoint-message"),e=t?t.value.trim():"";if(e){this._creating=!0,this.render();try{await this._api._post("/api/checkpoints",{message:e}),this._showCreateForm=!1,this._creating=!1,this.dispatchEvent(new CustomEvent("checkpoint-action",{detail:{action:"create",message:e},bubbles:!0})),this._lastDataHash=null,await this._loadData()}catch(a){this._creating=!1,this._error=`Failed to create checkpoint: ${a.message}`,this.render()}}}async _rollbackCheckpoint(t){if(!this._rollingBack){this._rollingBack=!0,this.render();try{await this._api._post(`/api/checkpoints/${t}/rollback`),this._rollbackTarget=null,this.dispatchEvent(new CustomEvent("checkpoint-action",{detail:{action:"rollback",checkpointId:t},bubbles:!0})),this._lastDataHash=null,await this._loadData()}catch(e){this._rollbackTarget=null,this._error=`Failed to rollback: ${e.message}`}finally{this._rollingBack=!1,this.render()}}}_toggleCreateForm(){this._showCreateForm=!this._showCreateForm,this._rollbackTarget=null,this.render()}_confirmRollback(t){this._rollbackTarget=t,this.render()}_cancelRollback(){this._rollbackTarget=null,this.render()}_formatRelativeTime(t){if(!t)return"";try{let e=Date.now(),a=new Date(t).getTime(),i=Math.floor((e-a)/1e3);return i<60?`${i}s ago`:i<3600?`${Math.floor(i/60)}m ago`:i<86400?`${Math.floor(i/3600)}h ago`:`${Math.floor(i/86400)}d ago`}catch{return this._escapeHTML(t)}}render(){let t=this.shadowRoot;if(!t)return;let e=this._checkpoints.length;t.innerHTML=`
      <style>${this.getBaseStyles()}${this._getStyles()}</style>
      <div class="checkpoint-viewer">
        <div class="checkpoint-header">
          <div class="header-left">
            <h2 class="title">Checkpoints</h2>
            <span class="count-badge">${e}</span>
          </div>
          <button class="btn btn-primary" id="create-btn">
            ${this._showCreateForm?"Cancel":"Create Checkpoint"}
          </button>
        </div>

        ${this._showCreateForm?this._renderCreateForm():""}

        <div class="checkpoint-list">
          ${this._loading?'<div class="loading-state">Loading checkpoints...</div>':""}
          ${!this._loading&&e===0?'<div class="empty-state">No checkpoints yet. Create one to save the current state.</div>':""}
          ${this._checkpoints.map(a=>this._renderCheckpointCard(a)).join("")}
        </div>

        ${this._error?`<div class="error-banner">${this._escapeHTML(this._error)}</div>`:""}
      </div>
    `,this._attachEventListeners()}_renderCreateForm(){return`
      <div class="create-form">
        <input
          type="text"
          id="checkpoint-message"
          class="form-input"
          placeholder="Checkpoint message (e.g., before refactoring auth module)"
          maxlength="200"
          ${this._creating?"disabled":""}
        />
        <button class="btn btn-primary" id="submit-create-btn" ${this._creating?"disabled":""}>
          ${this._creating?"Creating...":"Save"}
        </button>
      </div>
    `}_renderCheckpointCard(t){let e=t.git_sha?t.git_sha.substring(0,7):"unknown",a=Array.isArray(t.files)?t.files.length:t.files_count||0,i=this._rollbackTarget===t.id;return`
      <div class="checkpoint-card" data-checkpoint-id="${this._escapeHTML(t.id)}">
        <div class="card-header">
          <span class="checkpoint-sha mono">${this._escapeHTML(e)}</span>
          <span class="checkpoint-time">${this._formatRelativeTime(t.created_at)}</span>
        </div>
        <div class="card-body">
          <p class="checkpoint-message">${this._escapeHTML(t.message||"No message")}</p>
          <div class="card-meta">
            <span class="meta-item">${a} file${a!==1?"s":""}</span>
            <span class="meta-item mono">ID: ${this._escapeHTML(t.id)}</span>
          </div>
        </div>
        <div class="card-actions">
          ${i?`
            <span class="rollback-confirm-text">Rollback to this checkpoint?</span>
            <button class="btn btn-sm btn-danger" data-action="confirm-rollback" data-id="${this._escapeHTML(t.id)}">Confirm</button>
            <button class="btn btn-sm" data-action="cancel-rollback">Cancel</button>
          `:`
            <button class="btn btn-sm" data-action="rollback" data-id="${this._escapeHTML(t.id)}">Rollback</button>
          `}
        </div>
      </div>
    `}_escapeHTML(t){return t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}_attachEventListeners(){let t=this.shadowRoot;if(!t)return;let e=t.getElementById("create-btn");e&&e.addEventListener("click",()=>this._toggleCreateForm());let a=t.getElementById("submit-create-btn");a&&a.addEventListener("click",()=>this._createCheckpoint());let i=t.getElementById("checkpoint-message");i&&(i.addEventListener("keydown",s=>{s.key==="Enter"&&!this._creating&&(s.preventDefault(),this._createCheckpoint())}),requestAnimationFrame(()=>i.focus())),t.querySelectorAll("[data-action]").forEach(s=>{s.addEventListener("click",r=>{r.stopPropagation();let o=s.dataset.action,l=s.dataset.id;o==="rollback"?this._confirmRollback(l):o==="confirm-rollback"?this._rollbackCheckpoint(l):o==="cancel-rollback"&&this._cancelRollback()})})}_getStyles(){return`
      :host {
        display: block;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--loki-text-primary);
      }

      .checkpoint-viewer {
        padding: 16px;
      }

      .checkpoint-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }

      .count-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 10px;
        background: var(--loki-accent-muted);
        color: var(--loki-accent);
      }

      .btn {
        padding: 6px 14px;
        border: 1px solid var(--loki-border);
        border-radius: 6px;
        background: var(--loki-bg-tertiary);
        color: var(--loki-text-primary);
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.15s ease;
      }

      .btn:hover {
        background: var(--loki-bg-hover);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: var(--loki-accent);
        border-color: var(--loki-accent);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: var(--loki-accent-light);
      }

      .btn-sm {
        padding: 4px 10px;
        font-size: 11px;
      }

      .btn-danger {
        background: var(--loki-red-muted);
        border-color: var(--loki-red-muted);
        color: var(--loki-red);
      }

      .btn-danger:hover {
        opacity: 0.85;
      }

      /* Create Form */
      .create-form {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        padding: 12px;
        background: var(--loki-bg-card);
        border: 1px solid var(--loki-border);
        border-radius: 8px;
      }

      .form-input {
        flex: 1;
        padding: 8px 12px;
        background: var(--loki-bg-primary);
        border: 1px solid var(--loki-border);
        border-radius: 6px;
        color: var(--loki-text-primary);
        font-size: 13px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.15s ease;
      }

      .form-input:focus {
        border-color: var(--loki-accent);
      }

      .form-input::placeholder {
        color: var(--loki-text-muted);
      }

      .form-input:disabled {
        opacity: 0.5;
      }

      /* Checkpoint List */
      .checkpoint-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .checkpoint-card {
        background: var(--loki-bg-card);
        border: 1px solid var(--loki-border);
        border-radius: 8px;
        padding: 12px 16px;
        transition: all 0.15s ease;
      }

      .checkpoint-card:hover {
        border-color: var(--loki-border-light);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .checkpoint-sha {
        font-size: 12px;
        font-weight: 600;
        color: var(--loki-accent);
        background: var(--loki-accent-muted);
        padding: 2px 6px;
        border-radius: 4px;
      }

      .checkpoint-time {
        font-size: 11px;
        color: var(--loki-text-muted);
      }

      .card-body {
        margin-bottom: 8px;
      }

      .checkpoint-message {
        margin: 0 0 6px 0;
        font-size: 13px;
        color: var(--loki-text-primary);
        line-height: 1.4;
      }

      .card-meta {
        display: flex;
        gap: 12px;
        font-size: 11px;
        color: var(--loki-text-muted);
      }

      .meta-item {
        display: inline-flex;
        align-items: center;
      }

      .mono {
        font-family: 'JetBrains Mono', monospace;
      }

      .card-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--loki-border);
      }

      .rollback-confirm-text {
        font-size: 12px;
        color: var(--loki-red);
        font-weight: 500;
        margin-right: auto;
      }

      /* States */
      .loading-state {
        padding: 40px;
        text-align: center;
        color: var(--loki-text-muted);
        font-size: 13px;
      }

      .empty-state {
        padding: 40px;
        text-align: center;
        color: var(--loki-text-muted);
        font-size: 13px;
      }

      .error-banner {
        margin-top: 12px;
        padding: 10px 14px;
        background: var(--loki-red-muted);
        border: 1px solid var(--loki-red-muted);
        border-radius: 6px;
        color: var(--loki-red);
        font-size: 12px;
      }
    `}};customElements.get("loki-checkpoint-viewer")||customElements.define("loki-checkpoint-viewer",V);var Y=class extends c{static get observedAttributes(){return["api-url","theme"]}constructor(){super(),this._data=null,this._connected=!1,this._activeTab="gauge",this._api=null,this._pollInterval=null}connectedCallback(){super.connectedCallback(),this._setupApi(),this._loadContext(),this._startPolling()}disconnectedCallback(){super.disconnectedCallback(),this._stopPolling()}attributeChangedCallback(t,e,a){e!==a&&(t==="api-url"&&this._api&&(this._api.baseUrl=a,this._loadContext()),t==="theme"&&this._applyTheme())}_setupApi(){let t=this.getAttribute("api-url")||window.location.origin;this._api=u({baseUrl:t})}async _loadContext(){try{let t=this.getAttribute("api-url")||window.location.origin,e=await fetch(t+"/api/context");e.ok&&(this._data=await e.json(),this._connected=!0)}catch{this._connected=!1}this.render()}_startPolling(){this._pollInterval=setInterval(()=>{this._loadContext()},5e3)}_stopPolling(){this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null)}_setTab(t){this._activeTab=t,this.render()}_formatTokens(t){return!t||t===0?"0":t>=1e6?(t/1e6).toFixed(2)+"M":t>=1e3?(t/1e3).toFixed(1)+"K":String(t)}_formatUSD(t){return!t||t===0?"$0.00":t<.01?"<$0.01":"$"+t.toFixed(2)}_escapeHTML(t){return t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}_getGaugeColor(t){return t>80?"var(--loki-red)":t>=60?"var(--loki-yellow)":"var(--loki-green)"}_getGaugeColorClass(t){return t>80?"gauge-red":t>=60?"gauge-yellow":"gauge-green"}_renderGaugeTab(){let t=this._data?.current||{},e=this._data?.totals||{},a=t.context_window_pct||0,i=this._getGaugeColor(a),s=this._getGaugeColorClass(a),r=70,o=2*Math.PI*r,l=o-a/100*o;return`
      <div class="gauge-tab">
        <div class="gauge-container">
          <svg class="gauge-svg" viewBox="0 0 180 180" aria-label="Context window usage: ${a.toFixed(1)}%">
            <circle
              class="gauge-bg"
              cx="90" cy="90" r="${r}"
              fill="none"
              stroke="var(--loki-bg-tertiary)"
              stroke-width="12"
            />
            <circle
              class="gauge-ring ${s}"
              cx="90" cy="90" r="${r}"
              fill="none"
              stroke="${i}"
              stroke-width="12"
              stroke-linecap="round"
              stroke-dasharray="${o}"
              stroke-dashoffset="${l}"
              transform="rotate(-90 90 90)"
            />
            <text class="gauge-pct" x="90" y="85" text-anchor="middle"
                  fill="var(--loki-text-primary)" font-size="28" font-weight="600"
                  font-family="'JetBrains Mono', monospace">
              ${a.toFixed(1)}%
            </text>
            <text class="gauge-label" x="90" y="108" text-anchor="middle"
                  fill="var(--loki-text-muted)" font-size="11">
              Context Used
            </text>
          </svg>
        </div>

        <div class="summary-grid">
          <div class="summary-card">
            <div class="card-label">Total Tokens</div>
            <div class="card-value">${this._formatTokens(t.total_tokens)}</div>
            <div class="card-sub">${this._formatTokens(t.input_tokens)} in / ${this._formatTokens(t.output_tokens)} out</div>
          </div>
          <div class="summary-card">
            <div class="card-label">Estimated Cost</div>
            <div class="card-value accent">${this._formatUSD(t.estimated_cost_usd)}</div>
          </div>
          <div class="summary-card">
            <div class="card-label">Compactions</div>
            <div class="card-value">${e.compaction_count||0}</div>
          </div>
          <div class="summary-card">
            <div class="card-label">Iterations Tracked</div>
            <div class="card-value">${e.iterations_tracked||0}</div>
          </div>
        </div>

        <div class="cache-info">
          <div class="section-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            <span class="section-title">Cache Tokens</span>
          </div>
          <div class="cache-grid">
            <div class="cache-item">
              <span class="cache-label">Cache Read</span>
              <span class="cache-value">${this._formatTokens(t.cache_read_tokens)}</span>
            </div>
            <div class="cache-item">
              <span class="cache-label">Cache Creation</span>
              <span class="cache-value">${this._formatTokens(t.cache_creation_tokens)}</span>
            </div>
          </div>
        </div>
      </div>
    `}_renderTimelineTab(){let t=this._data?.per_iteration||[],e=this._data?.compactions||[];if(t.length===0)return'<div class="empty-state">No iteration data yet</div>';let a=Math.max(...t.map(r=>(r.input_tokens||0)+(r.output_tokens||0)+(r.cache_read_tokens||0)+(r.cache_creation_tokens||0))),i=new Set(e.map(r=>r.at_iteration)),s="";for(let r of t){let o=(r.input_tokens||0)+(r.output_tokens||0)+(r.cache_read_tokens||0)+(r.cache_creation_tokens||0),l=a>0?o/a*100:0,p=r.compacted===!0;i.has(r.iteration)&&(s+=`
          <div class="timeline-compaction-row">
            <div class="compaction-line"></div>
            <span class="compaction-label">Context Compacted</span>
            <div class="compaction-line"></div>
          </div>
        `),s+=`
        <div class="timeline-row ${p?"compacted":""}">
          <div class="timeline-iter">#${r.iteration}</div>
          <div class="timeline-bar-container">
            <div class="timeline-bar" style="width: ${l.toFixed(1)}%"></div>
          </div>
          <div class="timeline-tokens">${this._formatTokens(o)}</div>
          <div class="timeline-cost">${this._formatUSD(r.cost_usd)}</div>
        </div>
      `}return`
      <div class="timeline-tab">
        <div class="section-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          <span class="section-title">Per-Iteration Token Usage</span>
        </div>
        <div class="timeline-header-row">
          <div class="timeline-iter">Iter</div>
          <div class="timeline-bar-container">Tokens</div>
          <div class="timeline-tokens">Count</div>
          <div class="timeline-cost">Cost</div>
        </div>
        ${s}
      </div>
    `}_renderBreakdownTab(){let t=this._data?.per_iteration||[];if(t.length===0)return'<div class="empty-state">No iteration data yet</div>';let e=Math.max(...t.map(s=>(s.input_tokens||0)+(s.output_tokens||0)+(s.cache_read_tokens||0)+(s.cache_creation_tokens||0))),a=`
      <div class="breakdown-legend">
        <div class="legend-item"><span class="legend-swatch swatch-input"></span> Input</div>
        <div class="legend-item"><span class="legend-swatch swatch-output"></span> Output</div>
        <div class="legend-item"><span class="legend-swatch swatch-cache-read"></span> Cache Read</div>
        <div class="legend-item"><span class="legend-swatch swatch-cache-create"></span> Cache Creation</div>
      </div>
    `,i="";for(let s of t){let r=s.input_tokens||0,o=s.output_tokens||0,l=s.cache_read_tokens||0,p=s.cache_creation_tokens||0,y=r+o+l+p,S=e>0?r/e*100:0,P=e>0?o/e*100:0,R=e>0?l/e*100:0,rt=e>0?p/e*100:0;i+=`
        <div class="breakdown-row">
          <div class="breakdown-iter">#${s.iteration}</div>
          <div class="breakdown-bar-container">
            <div class="breakdown-bar bar-input" style="width: ${S.toFixed(1)}%"></div>
            <div class="breakdown-bar bar-output" style="width: ${P.toFixed(1)}%"></div>
            <div class="breakdown-bar bar-cache-read" style="width: ${R.toFixed(1)}%"></div>
            <div class="breakdown-bar bar-cache-create" style="width: ${rt.toFixed(1)}%"></div>
          </div>
          <div class="breakdown-cost">${this._formatUSD(s.cost_usd)}</div>
        </div>
      `}return`
      <div class="breakdown-tab">
        <div class="section-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <line x1="3" y1="9" x2="21" y2="9"/>
            <line x1="9" y1="21" x2="9" y2="9"/>
          </svg>
          <span class="section-title">Token Type Breakdown</span>
        </div>
        ${a}
        ${i}
      </div>
    `}render(){let t=this._activeTab==="gauge"?this._renderGaugeTab():this._activeTab==="timeline"?this._renderTimelineTab():this._renderBreakdownTab();this.shadowRoot.innerHTML=`
      <style>
        ${this.getBaseStyles()}

        :host {
          display: block;
        }

        .context-container {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        /* Tabs */
        .tabs {
          display: flex;
          gap: 2px;
          margin-bottom: 16px;
          background: var(--loki-bg-tertiary);
          border-radius: 8px;
          padding: 2px;
        }

        .tab {
          flex: 1;
          padding: 8px 12px;
          border: none;
          background: none;
          color: var(--loki-text-muted);
          cursor: pointer;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 500;
          transition: all 0.2s;
          font-family: inherit;
        }

        .tab:hover {
          color: var(--loki-text-secondary);
        }

        .tab.active {
          background: var(--loki-bg-card);
          color: var(--loki-text-primary);
          box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Summary Cards */
        .summary-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 10px;
        }

        .summary-card {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          padding: 14px 16px;
          transition: all var(--loki-transition);
        }

        .summary-card:hover {
          border-color: var(--loki-border-light);
        }

        .card-label {
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-text-muted);
          margin-bottom: 6px;
        }

        .card-value {
          font-size: 22px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-primary);
          line-height: 1.2;
        }

        .card-value.accent {
          color: var(--loki-accent);
        }

        .card-sub {
          font-size: 11px;
          color: var(--loki-text-muted);
          margin-top: 4px;
          font-family: 'JetBrains Mono', monospace;
        }

        /* Section Headers */
        .section-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 10px;
        }

        .section-header svg {
          width: 16px;
          height: 16px;
          color: var(--loki-text-muted);
          flex-shrink: 0;
        }

        .section-title {
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-text-muted);
        }

        /* Gauge Tab */
        .gauge-tab {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .gauge-container {
          display: flex;
          justify-content: center;
          padding: 16px 0;
        }

        .gauge-svg {
          width: 180px;
          height: 180px;
        }

        .gauge-ring {
          transition: stroke-dashoffset 0.6s ease;
        }

        .cache-info {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          padding: 16px;
        }

        .cache-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 12px;
        }

        .cache-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .cache-label {
          font-size: 12px;
          color: var(--loki-text-muted);
        }

        .cache-value {
          font-size: 14px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-primary);
        }

        /* Timeline Tab */
        .timeline-tab {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .timeline-header-row {
          display: grid;
          grid-template-columns: 48px 1fr 72px 72px;
          gap: 8px;
          align-items: center;
          padding: 6px 8px;
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-text-muted);
          border-bottom: 1px solid var(--loki-border);
          margin-bottom: 4px;
        }

        .timeline-row {
          display: grid;
          grid-template-columns: 48px 1fr 72px 72px;
          gap: 8px;
          align-items: center;
          padding: 6px 8px;
          border-radius: 6px;
          transition: background 0.15s;
        }

        .timeline-row:hover {
          background: var(--loki-bg-hover);
        }

        .timeline-row.compacted {
          border: 1px dashed var(--loki-yellow);
          background: rgba(234, 179, 8, 0.04);
        }

        .timeline-iter {
          font-size: 12px;
          font-weight: 500;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-secondary);
        }

        .timeline-bar-container {
          height: 16px;
          background: var(--loki-bg-tertiary);
          border-radius: 4px;
          overflow: hidden;
        }

        .timeline-bar {
          height: 100%;
          background: var(--loki-accent);
          border-radius: 4px;
          min-width: 2px;
          transition: width 0.3s ease;
        }

        .timeline-tokens {
          font-size: 12px;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-primary);
          text-align: right;
        }

        .timeline-cost {
          font-size: 12px;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-accent);
          text-align: right;
        }

        .timeline-compaction-row {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 8px 0;
          margin: 4px 0;
        }

        .compaction-line {
          flex: 1;
          height: 1px;
          background: var(--loki-yellow);
          opacity: 0.5;
        }

        .compaction-label {
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-yellow);
          white-space: nowrap;
        }

        /* Breakdown Tab */
        .breakdown-tab {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .breakdown-legend {
          display: flex;
          gap: 16px;
          flex-wrap: wrap;
          margin-bottom: 8px;
          padding: 10px 12px;
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 8px;
        }

        .legend-item {
          display: flex;
          align-items: center;
          gap: 6px;
          font-size: 11px;
          color: var(--loki-text-secondary);
        }

        .legend-swatch {
          width: 12px;
          height: 12px;
          border-radius: 3px;
          flex-shrink: 0;
        }

        .swatch-input { background: var(--loki-accent); }
        .swatch-output { background: var(--loki-green); }
        .swatch-cache-read { background: var(--loki-blue, #3b82f6); }
        .swatch-cache-create { background: var(--loki-yellow); }

        .breakdown-row {
          display: grid;
          grid-template-columns: 48px 1fr 72px;
          gap: 8px;
          align-items: center;
          padding: 6px 8px;
          border-radius: 6px;
          transition: background 0.15s;
        }

        .breakdown-row:hover {
          background: var(--loki-bg-hover);
        }

        .breakdown-iter {
          font-size: 12px;
          font-weight: 500;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-secondary);
        }

        .breakdown-bar-container {
          display: flex;
          height: 16px;
          background: var(--loki-bg-tertiary);
          border-radius: 4px;
          overflow: hidden;
        }

        .breakdown-bar {
          height: 100%;
          min-width: 0;
          transition: width 0.3s ease;
        }

        .bar-input { background: var(--loki-accent); }
        .bar-output { background: var(--loki-green); }
        .bar-cache-read { background: var(--loki-blue, #3b82f6); }
        .bar-cache-create { background: var(--loki-yellow); }

        .breakdown-cost {
          font-size: 12px;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-accent);
          text-align: right;
        }

        /* Empty / Offline states */
        .empty-state {
          text-align: center;
          padding: 32px 20px;
          color: var(--loki-text-muted);
          font-size: 13px;
          font-style: italic;
        }

        .offline-notice {
          text-align: center;
          padding: 20px;
          color: var(--loki-text-muted);
          font-size: 12px;
        }
      </style>

      <div class="context-container">
        ${this._connected?"":`
          <div class="offline-notice">Connecting to context API...</div>
        `}

        <div class="tabs">
          <button class="tab ${this._activeTab==="gauge"?"active":""}" data-tab="gauge">Gauge</button>
          <button class="tab ${this._activeTab==="timeline"?"active":""}" data-tab="timeline">Timeline</button>
          <button class="tab ${this._activeTab==="breakdown"?"active":""}" data-tab="breakdown">Breakdown</button>
        </div>

        ${t}
      </div>
    `,this.shadowRoot.querySelectorAll(".tab").forEach(e=>{e.addEventListener("click",()=>{this._setTab(e.dataset.tab)})})}};customElements.get("loki-context-tracker")||customElements.define("loki-context-tracker",Y);var st={critical:"var(--loki-red, #ef4444)",warning:"var(--loki-yellow, #eab308)",info:"var(--loki-blue, #3b82f6)"},W=class extends c{static get observedAttributes(){return["api-url","theme"]}constructor(){super(),this._notifications=[],this._triggers=[],this._summary={},this._connected=!1,this._activeTab="feed",this._pollInterval=null}connectedCallback(){super.connectedCallback(),this._loadNotifications(),this._loadTriggers(),this._startPolling()}disconnectedCallback(){super.disconnectedCallback(),this._stopPolling()}attributeChangedCallback(t,e,a){e!==a&&(t==="api-url"&&(this._loadNotifications(),this._loadTriggers()),t==="theme"&&this._applyTheme())}async _loadNotifications(){try{let t=this.getAttribute("api-url")||window.location.origin,e=await fetch(t+"/api/notifications");if(e.ok){let a=await e.json();this._notifications=a.notifications||[],this._summary=a.summary||{},this._connected=!0}}catch{this._connected=!1}this.render()}async _loadTriggers(){try{let t=this.getAttribute("api-url")||window.location.origin,e=await fetch(t+"/api/notifications/triggers");if(e.ok){let a=await e.json();this._triggers=a.triggers||[]}}catch{}}async _acknowledgeNotification(t){let e=this.getAttribute("api-url")||window.location.origin;await fetch(e+"/api/notifications/"+encodeURIComponent(t)+"/acknowledge",{method:"POST"}),this._loadNotifications()}async _acknowledgeAll(){let t=this.getAttribute("api-url")||window.location.origin,e=this._notifications.filter(a=>!a.acknowledged);for(let a of e)await fetch(t+"/api/notifications/"+encodeURIComponent(a.id)+"/acknowledge",{method:"POST"});this._loadNotifications()}async _toggleTrigger(t,e){let a=this.getAttribute("api-url")||window.location.origin,i=this._triggers.map(s=>s.id===t?{...s,enabled:e}:s);await fetch(a+"/api/notifications/triggers",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({triggers:i})}),this._triggers=i,this.render()}_startPolling(){this._pollInterval=setInterval(()=>{this._loadNotifications(),this._loadTriggers()},5e3)}_stopPolling(){this._pollInterval&&(clearInterval(this._pollInterval),this._pollInterval=null)}_formatTime(t){if(!t)return"";try{let e=new Date(t),i=new Date-e,s=Math.floor(i/1e3),r=Math.floor(s/60),o=Math.floor(r/60),l=Math.floor(o/24);return s<60?s+"s ago":r<60?r+"m ago":o<24?o+"h ago":l<7?l+"d ago":e.toLocaleDateString()}catch{return String(t)}}_escapeHTML(t){return t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}_getSeverityColor(t){return st[t]||st.info}_switchTab(t){this._activeTab=t,this.render()}_bindEvents(){let t=this.shadowRoot;t.querySelectorAll(".tab").forEach(a=>{a.addEventListener("click",()=>{this._switchTab(a.dataset.tab)})}),t.querySelectorAll(".ack-btn").forEach(a=>{a.addEventListener("click",()=>{this._acknowledgeNotification(a.dataset.id)})});let e=t.querySelector(".ack-all-btn");e&&e.addEventListener("click",()=>{this._acknowledgeAll()}),t.querySelectorAll(".toggle input").forEach(a=>{a.addEventListener("change",()=>{this._toggleTrigger(a.dataset.triggerId,a.checked)})})}_renderSummaryBar(){let t=this._summary.total||0,e=this._summary.unacknowledged||0,a=this._summary.critical||0;return`
      <div class="summary-row">
        <div class="summary-grid">
          <div class="summary-card">
            <div class="card-label">Total</div>
            <div class="card-value">${t}</div>
          </div>
          <div class="summary-card">
            <div class="card-label">Unread</div>
            <div class="card-value">${e}</div>
          </div>
          <div class="summary-card">
            <div class="card-label">Critical</div>
            <div class="card-value" style="color: ${st.critical}">${a}</div>
          </div>
        </div>
        ${e>0?`
          <button class="ack-all-btn">Acknowledge All</button>
        `:""}
      </div>
    `}_renderNotificationList(){return this._notifications.length===0?'<div class="empty-state">No notifications</div>':[...this._notifications].sort((e,a)=>new Date(a.timestamp)-new Date(e.timestamp)).map(e=>{let a=e.acknowledged,i=this._getSeverityColor(e.severity);return`
        <div class="notif-row ${a?"acknowledged":""}">
          <span class="severity-dot" style="background: ${i};" title="${this._escapeHTML(e.severity)}"></span>
          <span class="notif-time">${this._formatTime(e.timestamp)}</span>
          <span class="notif-message">${this._escapeHTML(e.message)}</span>
          ${e.iteration!=null?`<span class="notif-iteration">iter ${e.iteration}</span>`:""}
          ${a?"":`<button class="ack-btn" data-id="${this._escapeHTML(e.id)}">Ack</button>`}
        </div>
      `}).join("")}_renderTriggerList(){return this._triggers.length===0?'<div class="empty-state">No triggers configured</div>':this._triggers.map(t=>{let e=this._getSeverityColor(t.severity),a=t.threshold_pct!=null?`Threshold: ${t.threshold_pct}%`:t.pattern||"";return`
        <div class="trigger-row">
          <label class="toggle">
            <input type="checkbox" data-trigger-id="${this._escapeHTML(t.id)}" ${t.enabled?"checked":""}>
            <span class="toggle-slider"></span>
          </label>
          <span class="trigger-name">${this._escapeHTML(t.id)}</span>
          <span class="trigger-badge type-badge">${this._escapeHTML(t.type||"custom")}</span>
          <span class="trigger-badge severity-badge" style="background: ${e}; color: #fff;">${this._escapeHTML(t.severity||"info")}</span>
          ${a?`<span class="trigger-info">${this._escapeHTML(a)}</span>`:""}
        </div>
      `}).join("")}render(){this.shadowRoot.innerHTML=`
      <style>
        ${this.getBaseStyles()}

        :host {
          display: block;
        }

        .notif-container {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        /* Tabs */
        .tabs {
          display: flex;
          gap: 2px;
          margin-bottom: 16px;
          background: var(--loki-bg-tertiary);
          border-radius: 8px;
          padding: 2px;
        }

        .tab {
          flex: 1;
          padding: 8px 12px;
          border: none;
          background: none;
          color: var(--loki-text-muted);
          cursor: pointer;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 500;
          transition: all 0.2s;
          font-family: inherit;
        }

        .tab:hover {
          color: var(--loki-text-secondary);
        }

        .tab.active {
          background: var(--loki-bg-card);
          color: var(--loki-text-primary);
          box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Summary bar */
        .summary-row {
          display: flex;
          align-items: flex-start;
          gap: 12px;
          justify-content: space-between;
        }

        .summary-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 10px;
          flex: 1;
        }

        .summary-card {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          padding: 14px 16px;
          transition: all var(--loki-transition);
        }

        .summary-card:hover {
          border-color: var(--loki-border-light);
        }

        .card-label {
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: var(--loki-text-muted);
          margin-bottom: 6px;
        }

        .card-value {
          font-size: 22px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-primary);
          line-height: 1.2;
        }

        /* Acknowledge All button */
        .ack-all-btn {
          padding: 8px 16px;
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 8px;
          color: var(--loki-text-primary);
          font-size: 12px;
          font-weight: 500;
          cursor: pointer;
          white-space: nowrap;
          transition: all 0.2s;
          font-family: inherit;
          align-self: center;
        }

        .ack-all-btn:hover {
          border-color: var(--loki-accent);
          color: var(--loki-accent);
        }

        /* Notification list */
        .notif-list {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          overflow: hidden;
        }

        .notif-row {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 10px 14px;
          border-bottom: 1px solid var(--loki-border);
          transition: all 0.2s;
        }

        .notif-row:last-child {
          border-bottom: none;
        }

        .notif-row:hover {
          background: var(--loki-bg-hover);
        }

        .notif-row.acknowledged {
          opacity: 0.5;
        }

        .severity-dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          flex-shrink: 0;
        }

        .notif-time {
          font-size: 11px;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-muted);
          white-space: nowrap;
          min-width: 56px;
        }

        .notif-message {
          flex: 1;
          font-size: 13px;
          color: var(--loki-text-primary);
          line-height: 1.4;
        }

        .notif-iteration {
          font-size: 10px;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-muted);
          background: var(--loki-bg-tertiary);
          padding: 2px 8px;
          border-radius: 10px;
          white-space: nowrap;
        }

        .ack-btn {
          padding: 4px 10px;
          background: none;
          border: 1px solid var(--loki-border);
          border-radius: 6px;
          color: var(--loki-text-secondary);
          font-size: 11px;
          cursor: pointer;
          white-space: nowrap;
          transition: all 0.2s;
          font-family: inherit;
        }

        .ack-btn:hover {
          border-color: var(--loki-accent);
          color: var(--loki-accent);
        }

        /* Trigger list */
        .trigger-list {
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
          overflow: hidden;
        }

        .trigger-row {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 14px;
          border-bottom: 1px solid var(--loki-border);
        }

        .trigger-row:last-child {
          border-bottom: none;
        }

        .trigger-row:hover {
          background: var(--loki-bg-hover);
        }

        .trigger-name {
          font-size: 13px;
          font-weight: 600;
          color: var(--loki-text-primary);
          min-width: 100px;
        }

        .trigger-badge {
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.3px;
          padding: 3px 8px;
          border-radius: 10px;
          white-space: nowrap;
        }

        .type-badge {
          background: var(--loki-bg-tertiary);
          color: var(--loki-text-secondary);
        }

        .severity-badge {
          color: #fff;
        }

        .trigger-info {
          font-size: 11px;
          font-family: 'JetBrains Mono', monospace;
          color: var(--loki-text-muted);
          margin-left: auto;
        }

        /* Toggle switch */
        .toggle {
          position: relative;
          width: 36px;
          height: 20px;
          flex-shrink: 0;
        }

        .toggle input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .toggle-slider {
          position: absolute;
          inset: 0;
          background: var(--loki-bg-tertiary);
          border-radius: 10px;
          cursor: pointer;
          transition: 0.2s;
        }

        .toggle-slider:before {
          content: '';
          position: absolute;
          width: 16px;
          height: 16px;
          left: 2px;
          bottom: 2px;
          background: var(--loki-text-muted);
          border-radius: 50%;
          transition: 0.2s;
        }

        .toggle input:checked + .toggle-slider {
          background: var(--loki-accent);
        }

        .toggle input:checked + .toggle-slider:before {
          transform: translateX(16px);
          background: white;
        }

        /* Empty state */
        .empty-state {
          text-align: center;
          padding: 32px 16px;
          color: var(--loki-text-muted);
          font-size: 13px;
          background: var(--loki-bg-card);
          border: 1px solid var(--loki-border);
          border-radius: 10px;
        }

        /* Offline notice */
        .offline-notice {
          text-align: center;
          padding: 20px;
          color: var(--loki-text-muted);
          font-size: 12px;
        }
      </style>

      <div class="notif-container">
        ${this._connected?"":'<div class="offline-notice">Connecting to notifications API...</div>'}

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab ${this._activeTab==="feed"?"active":""}" data-tab="feed">Feed</button>
          <button class="tab ${this._activeTab==="triggers"?"active":""}" data-tab="triggers">Triggers</button>
        </div>

        <!-- Feed Tab -->
        ${this._activeTab==="feed"?`
          ${this._renderSummaryBar()}
          <div class="notif-list">
            ${this._renderNotificationList()}
          </div>
        `:""}

        <!-- Triggers Tab -->
        ${this._activeTab==="triggers"?`
          <div class="trigger-list">
            ${this._renderTriggerList()}
          </div>
        `:""}
      </div>
    `,this._bindEvents()}};customElements.get("loki-notification-center")||customElements.define("loki-notification-center",W);var At="1.3.0";function Lt(d={}){return d.theme?h.setTheme(d.theme):d.autoDetectContext!==!1?h.init():A.init(),d.apiUrl&&u({baseUrl:d.apiUrl}),{theme:h.getTheme(),context:h.detectContext()}}return _t(It);})();


// Initialize dashboard when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  // Initialize the dashboard with auto-detect
  var initResult = LokiDashboard.init({ autoDetectContext: true });
  console.log('Loki Dashboard initialized:', initResult);

  // Theme toggle functionality
  var themeToggle = document.getElementById('theme-toggle');
  var themeLabel = document.getElementById('theme-label');

  var sunIcon = document.getElementById('theme-icon-sun');
  var moonIcon = document.getElementById('theme-icon-moon');

  function updateThemeUI() {
    var theme = LokiDashboard.UnifiedThemeManager.getTheme();
    var isDark = theme.includes('dark') || theme === 'high-contrast';
    themeLabel.textContent = isDark ? 'Light' : 'Dark';
    if (sunIcon) sunIcon.style.display = isDark ? 'inline' : 'none';
    if (moonIcon) moonIcon.style.display = isDark ? 'none' : 'inline';
  }

  themeToggle.addEventListener('click', function() {
    LokiDashboard.UnifiedThemeManager.toggle();
    updateThemeUI();
  });

  window.addEventListener('loki-theme-change', function() {
    updateThemeUI();
  });

  updateThemeUI();

  // API URL configuration - auto-detect from current server
  var apiUrlInput = document.getElementById('api-url');
  var connectBtn = document.getElementById('connect-btn');
  var detectedUrl = window.location.origin;
  apiUrlInput.value = detectedUrl;

  function updateComponentsApiUrl(apiUrl) {
    var components = [
      'overview',
      'task-board',
      'session-control',
      'log-stream',
      'memory-browser',
      'learning-dashboard',
      'checklist-viewer',
      'app-status',
      'council-dashboard',
      'cost-dashboard',
      'checkpoint-viewer',
      'context-tracker',
      'notification-center'
    ];
    components.forEach(function(id) {
      var el = document.getElementById(id);
      if (el) el.setAttribute('api-url', apiUrl);
    });
    console.log('API URL updated:', apiUrl);
  }

  // Auto-connect to current server on load
  updateComponentsApiUrl(detectedUrl);

  connectBtn.addEventListener('click', function() {
    updateComponentsApiUrl(apiUrlInput.value);
  });

  // Offline detection
  window.addEventListener('online', function() {
    document.getElementById('offline-banner').classList.remove('show');
  });

  window.addEventListener('offline', function() {
    document.getElementById('offline-banner').classList.add('show');
  });

  if (!navigator.onLine) {
    document.getElementById('offline-banner').classList.add('show');
  }

  // Mobile menu toggle
  var mobileMenuBtn = document.getElementById('mobile-menu-btn');
  var sidebar = document.getElementById('sidebar');

  mobileMenuBtn.addEventListener('click', function() {
    sidebar.classList.toggle('mobile-open');
  });

  document.addEventListener('click', function(e) {
    if (window.innerWidth <= 768 &&
        sidebar.classList.contains('mobile-open') &&
        !sidebar.contains(e.target) &&
        !mobileMenuBtn.contains(e.target)) {
      sidebar.classList.remove('mobile-open');
    }
  });

  // --- Section Navigation ---
  var navLinks = document.querySelectorAll('.nav-link');
  var mainContent = document.getElementById('main-content');

  function switchSection(sectionId) {
    var pageEl = document.getElementById('page-' + sectionId);
    if (pageEl) {
      pageEl.scrollIntoView({ behavior: 'smooth' });
    }
    navLinks.forEach(function(link) { link.classList.remove('active'); });
    var navEl = document.querySelector('.nav-link[data-section="' + sectionId + '"]');
    if (navEl) navEl.classList.add('active');
    localStorage.setItem('loki-active-section', sectionId);
  }

  navLinks.forEach(function(link) {
    link.addEventListener('click', function() {
      switchSection(link.dataset.section);
      // Close mobile sidebar
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('mobile-open');
      }
    });
  });

  // IntersectionObserver to track active section on scroll
  var sectionPages = document.querySelectorAll('.section-page');
  var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting && entry.intersectionRatio > 0.3) {
        var sectionId = entry.target.id.replace('page-', '');
        navLinks.forEach(function(link) { link.classList.remove('active'); });
        var navEl = document.querySelector('.nav-link[data-section="' + sectionId + '"]');
        if (navEl) navEl.classList.add('active');
      }
    });
  }, { root: mainContent, threshold: 0.3 });

  sectionPages.forEach(function(page) { observer.observe(page); });

  // Keyboard shortcuts: Cmd/Ctrl + 1-7
  document.addEventListener('keydown', function(e) {
    if ((e.metaKey || e.ctrlKey) && ((e.key >= '1' && e.key <= '9') || e.key === '0')) {
      e.preventDefault();
      var sections = ['overview', 'tasks', 'logs', 'memory', 'learning', 'prd-checklist', 'app-runner', 'council', 'cost', 'checkpoint', 'context', 'notifications'];
      var idx = e.key === '0' ? 9 : parseInt(e.key) - 1;
      if (idx < sections.length) switchSection(sections[idx]);
    }
  });

  // --- Keyboard Shortcuts (Issue #18) ---
  var shortcutsOverlay = document.getElementById('shortcuts-overlay');
  var shortcutsClose = document.getElementById('shortcuts-close');

  function toggleShortcutsOverlay() {
    shortcutsOverlay.classList.toggle('visible');
  }

  function closeShortcutsOverlay() {
    shortcutsOverlay.classList.remove('visible');
  }

  shortcutsClose.addEventListener('click', closeShortcutsOverlay);

  // Close overlay when clicking outside the dialog
  shortcutsOverlay.addEventListener('click', function(e) {
    if (e.target === shortcutsOverlay) {
      closeShortcutsOverlay();
    }
  });

  document.addEventListener('keydown', function(e) {
    // Skip shortcuts when typing in input, textarea, or select elements
    var tag = (e.target.tagName || '').toLowerCase();
    if (tag === 'input' || tag === 'textarea' || tag === 'select' || e.target.isContentEditable) {
      // Allow Escape to blur input fields
      if (e.key === 'Escape') {
        e.target.blur();
      }
      return;
    }

    // Skip if modifier keys are held (let browser defaults work)
    if (e.metaKey || e.ctrlKey || e.altKey) return;

    var sections = ['overview', 'tasks', 'logs', 'memory', 'learning', 'prd-checklist', 'app-runner', 'council', 'cost', 'checkpoint', 'context', 'notifications'];

    switch (e.key) {
      // Section navigation: 1-9, 0
      case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9':
        e.preventDefault();
        switchSection(sections[parseInt(e.key) - 1]);
        break;
      case '0':
        e.preventDefault();
        switchSection(sections[9]);
        break;

      // Help overlay
      case '?':
        e.preventDefault();
        toggleShortcutsOverlay();
        break;

      // Close overlays
      case 'Escape':
        if (shortcutsOverlay.classList.contains('visible')) {
          e.preventDefault();
          closeShortcutsOverlay();
        }
        break;

      // Focus API URL input
      case '/':
        e.preventDefault();
        apiUrlInput.focus();
        apiUrlInput.select();
        break;

      // Theme toggle
      case 't':
        e.preventDefault();
        LokiDashboard.UnifiedThemeManager.toggle();
        updateThemeUI();
        break;

      // Session controls
      case 'p':
        e.preventDefault();
        var sessionCtrl = document.getElementById('session-control');
        if (sessionCtrl) {
          var pauseBtn = sessionCtrl.shadowRoot && sessionCtrl.shadowRoot.getElementById('pause-btn');
          if (pauseBtn && !pauseBtn.disabled) {
            pauseBtn.click();
          }
        }
        break;

      case 'r':
        e.preventDefault();
        var sessionCtrl2 = document.getElementById('session-control');
        if (sessionCtrl2) {
          var resumeBtn = sessionCtrl2.shadowRoot && sessionCtrl2.shadowRoot.getElementById('resume-btn');
          if (resumeBtn) {
            resumeBtn.click();
          }
        }
        break;

      case 's':
        e.preventDefault();
        var sessionCtrl3 = document.getElementById('session-control');
        if (sessionCtrl3) {
          var stopBtn = sessionCtrl3.shadowRoot && sessionCtrl3.shadowRoot.getElementById('stop-btn');
          if (stopBtn && !stopBtn.disabled) {
            if (window.confirm('Are you sure you want to stop the session?')) {
              stopBtn.click();
            }
          }
        }
        break;
    }
  });

  // Restore last section from localStorage
  var savedSection = localStorage.getItem('loki-active-section');
  if (savedSection) {
    setTimeout(function() { switchSection(savedSection); }, 100);
  }

  // Add initial log entry and verify connection
  setTimeout(function() {
    var logStream = document.getElementById('log-stream');
    if (logStream && logStream.addLog) {
      logStream.addLog('Dashboard initialized', 'success');
      logStream.addLog('Connecting to ' + detectedUrl + '...', 'info');
      fetch(detectedUrl + '/health').then(function(r) {
        return r.json();
      }).then(function(data) {
        if (data.status === 'healthy') {
          logStream.addLog('Connected to API', 'success');
        }
      }).catch(function() {
        logStream.addLog('API not reachable at ' + detectedUrl, 'error');
      });
    }
  }, 500);

  // Overview cards are now handled by the <loki-overview> component
  // which polls /api/status reactively via the unified API client.
});
  </script>
</body>
</html>