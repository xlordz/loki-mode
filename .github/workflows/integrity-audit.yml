name: Weekly Integrity Audit

on:
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  integrity-audit:
    name: Codebase integrity audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install npm dependencies
        run: npm ci

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pytest pydantic

      - name: Run npm tests
        id: npm_tests
        run: npm test

      - name: Run pytest
        id: pytest
        run: python3 -m pytest

      - name: Run shell tests
        id: shell_tests
        run: bash tests/run-all-tests.sh

      - name: Bash syntax validation
        id: bash_syntax
        run: bash -n autonomy/run.sh && bash -n autonomy/loki

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Helm lint
        id: helm_lint
        run: helm lint deploy/helm/loki-mode

      - name: Node module import checks
        id: node_imports
        run: |
          echo "-- Checking Node module imports --"
          node -e "require('./src/protocols/mcp-client')"
          node -e "require('./src/protocols/a2a')"
          node -e "require('./src/observability')"
          node -e "require('./src/policies')"
          node -e "require('./src/audit')"
          node -e "require('./src/integrations/jira')"
          node -e "require('./src/integrations/slack')"
          node -e "require('./src/integrations/teams')"
          node -e "require('./src/plugins')"
          echo "All Node module imports passed"

      - name: Python module import checks
        id: python_imports
        run: |
          echo "-- Checking Python module imports --"
          PYTHONPATH=sdk/python:$PYTHONPATH python3 -c "from memory.knowledge_graph import OrganizationKnowledgeGraph"
          PYTHONPATH=sdk/python:$PYTHONPATH python3 -c "from swarm.sycophancy import detect_sycophancy"
          PYTHONPATH=sdk/python:$PYTHONPATH python3 -c "from swarm.calibration import CalibrationTracker"
          PYTHONPATH=sdk/python:$PYTHONPATH python3 -c "from swarm.classifier import PRDClassifier"
          PYTHONPATH=sdk/python:$PYTHONPATH python3 -c "from swarm.composer import SwarmComposer"
          PYTHONPATH=sdk/python:$PYTHONPATH python3 -c "from loki_mode_sdk import AutonomiClient"
          echo "All Python module imports passed"

      - name: Dashboard health check
        id: dashboard_health
        run: |
          python3 -m pip install fastapi uvicorn
          python3 -m dashboard.server &
          DASHBOARD_PID=$!
          sleep 5
          echo "-- Checking /health --"
          curl -sf http://localhost:57374/health
          echo ""
          echo "-- Checking /.well-known/agent.json --"
          curl -sf http://localhost:57374/.well-known/agent.json
          echo ""
          echo "Dashboard health checks passed"
          kill $DASHBOARD_PID 2>/dev/null || true

      - name: Generate summary
        if: always()
        run: |
          echo "=== Weekly Integrity Audit Summary ==="
          echo "Run date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "npm tests:           ${{ steps.npm_tests.outcome }}"
          echo "pytest:              ${{ steps.pytest.outcome }}"
          echo "Shell tests:         ${{ steps.shell_tests.outcome }}"
          echo "Bash syntax:         ${{ steps.bash_syntax.outcome }}"
          echo "Helm lint:           ${{ steps.helm_lint.outcome }}"
          echo "Node imports:        ${{ steps.node_imports.outcome }}"
          echo "Python imports:      ${{ steps.python_imports.outcome }}"
          echo "Dashboard health:    ${{ steps.dashboard_health.outcome }}"
          echo ""
          echo "=== End Summary ==="

      - name: Create issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY="## Weekly Integrity Audit Failure

          **Commit:** ${{ github.sha }}
          **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Step Results

          | Check | Result |
          |-------|--------|
          | npm tests | ${{ steps.npm_tests.outcome }} |
          | pytest | ${{ steps.pytest.outcome }} |
          | Shell tests | ${{ steps.shell_tests.outcome }} |
          | Bash syntax | ${{ steps.bash_syntax.outcome }} |
          | Helm lint | ${{ steps.helm_lint.outcome }} |
          | Node imports | ${{ steps.node_imports.outcome }} |
          | Python imports | ${{ steps.python_imports.outcome }} |
          | Dashboard health | ${{ steps.dashboard_health.outcome }} |

          Review the workflow run for detailed logs."

          gh issue create \
            --title "Weekly Integrity Audit Failed - $(date -u '+%Y-%m-%d')" \
            --body "$BODY" \
            --label "bug"
