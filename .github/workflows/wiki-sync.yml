name: Wiki Sync

on:
  release:
    types: [published]
  push:
    branches: [main]
    paths:
      - 'wiki/**'
      - 'CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone or init wiki
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git wiki-repo 2>/dev/null || {
            mkdir -p wiki-repo
            cd wiki-repo
            git init
            git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git
          }

      - name: Copy wiki pages
        run: |
          cp -r wiki/* wiki-repo/ 2>/dev/null || true
          cd wiki-repo

          # Update version references
          VERSION="${{ steps.version.outputs.version }}"
          find . -name "*.md" -type f -exec sed -i "s/Version: .*/Version: $VERSION/g" {} \; 2>/dev/null || true

          if [ -f "Home.md" ]; then
            sed -i "s/Current Version: \*\*.*\*\*/Current Version: **$VERSION**/g" Home.md 2>/dev/null || true
          fi

      - name: Generate Changelog
        run: |
          cd wiki-repo
          echo "# Changelog" > Changelog.md
          echo "" >> Changelog.md
          echo "See [CHANGELOG.md](https://github.com/asklokesh/loki-mode/blob/main/CHANGELOG.md) for complete history." >> Changelog.md
          echo "" >> Changelog.md
          echo "---" >> Changelog.md
          echo "" >> Changelog.md
          head -150 ../CHANGELOG.md >> Changelog.md 2>/dev/null || true

      - name: Push to wiki
        run: |
          cd wiki-repo
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to push"
          else
            git commit -m "Sync wiki for v${{ steps.version.outputs.version }}"
            git push origin HEAD:master 2>/dev/null || git push origin HEAD:main 2>/dev/null || echo "Push failed - wiki may need initialization"
          fi

      - name: Summary
        run: |
          echo "## Wiki Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Wiki URL: https://github.com/${{ github.repository }}/wiki" >> $GITHUB_STEP_SUMMARY

  enhance-with-ai:
    runs-on: ubuntu-latest
    needs: sync-wiki
    if: github.event_name == 'release'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version
        id: version
        run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Clone wiki
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git wiki-repo

      - name: Create AI enhancement script
        run: |
          cat > enhance.mjs << 'ENDSCRIPT'
          import https from 'https';
          import fs from 'fs';
          import path from 'path';

          const API_KEY = process.env.ANTHROPIC_API_KEY;
          const VERSION = process.env.VERSION || 'latest';

          if (!API_KEY) {
            console.log('No ANTHROPIC_API_KEY - skipping AI enhancement');
            process.exit(0);
          }

          async function callClaude(prompt) {
            return new Promise((resolve, reject) => {
              const body = JSON.stringify({
                model: 'claude-sonnet-4-6-20250929',
                max_tokens: 8192,
                messages: [{ role: 'user', content: prompt }]
              });

              const req = https.request({
                hostname: 'api.anthropic.com',
                port: 443,
                path: '/v1/messages',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': API_KEY,
                  'anthropic-version': '2023-06-01'
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    const json = JSON.parse(data);
                    resolve(json.content?.[0]?.text || '');
                  } catch (e) {
                    reject(e);
                  }
                });
              });

              req.on('error', reject);
              req.write(body);
              req.end();
            });
          }

          async function enhancePage(file) {
            const name = path.basename(file, '.md');
            if (name.startsWith('_') || name === 'Changelog') return;

            console.log('Enhancing ' + name + '...');
            const content = fs.readFileSync(file, 'utf8');

            const prompt = 'You are a technical documentation expert. Enhance this Loki Mode v' + VERSION + ' wiki page.\n\n' +
              'Current content:\n' + content + '\n\n' +
              'Instructions: Improve clarity, add examples where helpful, ensure accuracy. Do not use emojis. Return ONLY markdown.';

            try {
              const enhanced = await callClaude(prompt);
              if (enhanced && enhanced.length > 100) {
                fs.writeFileSync(file, enhanced);
                console.log('Enhanced ' + name);
              }
            } catch (e) {
              console.error('Failed: ' + e.message);
            }
          }

          const wikiDir = './wiki-repo';
          const files = fs.readdirSync(wikiDir).filter(f => f.endsWith('.md'));

          for (const f of ['Home.md', 'Getting-Started.md', 'FAQ.md']) {
            const fp = path.join(wikiDir, f);
            if (fs.existsSync(fp)) {
              await enhancePage(fp);
              await new Promise(r => setTimeout(r, 2000));
            }
          }
          ENDSCRIPT

      - name: Run AI enhancement
        if: env.ANTHROPIC_API_KEY != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          VERSION: ${{ steps.version.outputs.version }}
        run: node enhance.mjs

      - name: Push enhanced wiki
        run: |
          cd wiki-repo
          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "AI-enhanced wiki for v${{ steps.version.outputs.version }}"
            git push origin HEAD:master 2>/dev/null || git push origin HEAD:main 2>/dev/null || true
          fi
