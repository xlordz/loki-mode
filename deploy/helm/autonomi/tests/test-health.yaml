apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "autonomi.fullname" . }}-test-health"
  labels:
    {{- include "autonomi.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: curl
      image: curlimages/curl:8.5.0
      command:
        - sh
        - "-c"
        - |
          response=$(curl --fail --silent --show-error --max-time 10 \
            "http://{{ include "autonomi.fullname" . }}-controlplane:{{ .Values.service.port }}/api/status")
          echo "$response"
          echo "$response" | python3 -c "import sys, json; json.load(sys.stdin)" 2>/dev/null || \
          echo "$response" | grep -q '{' || exit 1
